
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Set Up Autoscaling and Resource Allocation &#8212; Ray 3.0.0.dev0</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css@digest=1999514e3f237ded88cf.css" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css@digest=1999514e3f237ded88cf.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css@digest=5115cc725059bd94278eecd172e13a965bf8f5a9.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/termynal.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../_/static/css/badge_only.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js@digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/versionwarning.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script defer="defer" src="../_static/js/docsearch.js"></script>
    <script src="../_static/js/rate-the-docs.es.min.js"></script>
    <script defer="defer" src="../_static/js/termynal.js"></script>
    <script defer="defer" src="../_static/js/custom.js"></script>
    <script defer="defer" src="../_static/js/top-navigation.js"></script>
    <script src="../_static/js/tags.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js@digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script async="async" src="../../../_/static/javascript/readthedocs-doc-embed.js"></script>
    <link rel="canonical" href="https://docs.ray.io/en/latest/serve/scaling-and-resource-allocation.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Advanced Guides" href="advanced-guides/index.html" />
    <link rel="prev" title="Monitor Your Application" href="monitoring.html" />

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://deer.ray.io/script.js" data-site="WYYANYOS" defer></script>
<!-- / Fathom -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110413294-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110413294-1');
</script>

<script
  src="https://widget.kapa.ai/kapa-widget.bundle.js"
  data-website-id="18a8c339-4ec5-43c8-8182-db3f2bc8c6b6"
  data-project-name="Ray"
  data-project-color="#2C2C2C"
  data-project-logo="https://global.discourse-cdn.com/business7/uploads/ray/original/1X/8f4dcb72f7cd34e2a332d548bd65860994bc8ff1.png"
></script>

<script>
(function(apiKey){
    (function(p,e,n,d,o){var v,w,x,y,z;o=p[d]=p[d]||{};o._q=o._q||[];
    v=['initialize','identify','updateOptions','pageLoad','track'];for(w=0,x=v.length;w<x;++w)(function(m){
        o[m]=o[m]||function(){o._q[m===v[0]?'unshift':'push']([m].concat([].slice.call(arguments,0)));};})(v[w]);
        y=e.createElement(n);y.async=!0;y.src='https://cdn.pendo.io/agent/static/'+apiKey+'/pendo.js';
        z=e.getElementsByTagName(n)[0];z.parentNode.insertBefore(y,z);})(window,document,'script','pendo');

        pendo.initialize({
            visitor: {
                id: 'VISITOR-UNIQUE-ID'
            },
            account: {
                id: 'ACCOUNT-UNIQUE-ID'
            }
        });
})('f89fa48a-6dd7-4d7c-67cf-a8051ed891f2');
</script>



  
<!-- RTD Extra Head -->

<link rel="stylesheet" href="../../../_/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="application/json" id="READTHEDOCS_DATA">{"ad_free": true, "api_host": "https://readthedocs.org", "builder": "sphinx", "canonical_url": null, "docroot": "/doc/source/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-1", "language": "en", "page": "serve/scaling-and-resource-allocation", "programming_language": "py", "project": "ray", "proxied_api_host": "/_", "source_suffix": ".md", "subprojects": {}, "theme": "sphinx_book_theme", "user_analytics_code": "", "version": "master"}</script>

<!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
-->
<script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script>

<script type="text/javascript" src="../../../_/static/javascript/readthedocs-analytics.js" async="async"></script>

<!-- end RTD <extrahead> -->
</head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"><div class='topnav'></div></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ray 3.0.0.dev0</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main Navigation">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Welcome to Ray!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ray
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/index.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/getting-started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-more-libs/installation.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/use-cases.html">
   Use Cases
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/examples.html">
   Example Gallery
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/ray-libraries.html">
   Ecosystem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-core/walkthrough.html">
   Ray Core
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-air/getting-started.html">
   Ray AI Runtime (AIR)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/data.html">
   Ray Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../train/train.html">
   Ray Train
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tune.html">
   Ray Tune
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   Ray Serve
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="getting_started.html">
     Getting Started
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="key-concepts.html">
     Key Concepts
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="model_composition.html">
     Deploy a Composition of Models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="deploy-many-models/index.html">
     Deploy Many Models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="http-guide.html">
     Set Up FastAPI and HTTP
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="production-guide/index.html">
     Production Guide
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="monitoring.html">
     Monitor Your Application
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="scaling-and-resource-allocation.html#">
     Set Up Autoscaling and Resource Allocation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="advanced-guides/index.html">
     Advanced Guides
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="architecture.html">
     Architecture
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="tutorials/index.html">
     Examples
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="api/index.html">
     Ray Serve API
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../rllib/index.html">
   Ray RLlib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-more-libs/index.html">
   More Libraries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-core/cluster/index.html">
   Ray Clusters
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-observability/index.html">
   Monitoring and Debugging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-references/api.html">
   References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-contribute/stability.html">
   Developer Guides
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ray-project/ray"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/issues/new?title=Issue%20on%20page%20%2Fserve/scaling-and-resource-allocation.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/edit/master/doc/source/serve/scaling-and-resource-allocation.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/serve/scaling-and-resource-allocation.md.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="scaling-and-resource-allocation.html#scaling-horizontally-with-num-replicas">
   Scaling horizontally with
   <code class="docutils literal notranslate">
    <span class="pre">
     num_replicas
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="scaling-and-resource-allocation.html#autoscaling">
   Autoscaling
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="scaling-and-resource-allocation.html#autoscaling-config-parameters">
     <code class="docutils literal notranslate">
      <span class="pre">
       autoscaling_config
      </span>
     </code>
     parameters
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="scaling-and-resource-allocation.html#resource-management-cpus-gpus">
   Resource Management (CPUs, GPUs)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="scaling-and-resource-allocation.html#fractional-cpus-and-fractional-gpus">
     Fractional CPUs and Fractional GPUs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="scaling-and-resource-allocation.html#custom-resources-accelerator-types-and-more">
     Custom Resources, Accelerator types, and more
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="scaling-and-resource-allocation.html#configuring-parallelism-with-omp-num-threads">
   Configuring Parallelism with OMP_NUM_THREADS
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Set Up Autoscaling and Resource Allocation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="scaling-and-resource-allocation.html#scaling-horizontally-with-num-replicas">
   Scaling horizontally with
   <code class="docutils literal notranslate">
    <span class="pre">
     num_replicas
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="scaling-and-resource-allocation.html#autoscaling">
   Autoscaling
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="scaling-and-resource-allocation.html#autoscaling-config-parameters">
     <code class="docutils literal notranslate">
      <span class="pre">
       autoscaling_config
      </span>
     </code>
     parameters
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="scaling-and-resource-allocation.html#resource-management-cpus-gpus">
   Resource Management (CPUs, GPUs)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="scaling-and-resource-allocation.html#fractional-cpus-and-fractional-gpus">
     Fractional CPUs and Fractional GPUs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="scaling-and-resource-allocation.html#custom-resources-accelerator-types-and-more">
     Custom Resources, Accelerator types, and more
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="scaling-and-resource-allocation.html#configuring-parallelism-with-omp-num-threads">
   Configuring Parallelism with OMP_NUM_THREADS
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="set-up-autoscaling-and-resource-allocation">
<span id="serve-scaling-and-resource-allocation"></span><h1>Set Up Autoscaling and Resource Allocation<a class="headerlink" href="scaling-and-resource-allocation.html#set-up-autoscaling-and-resource-allocation" title="Permalink to this headline">#</a></h1>
<p>This guide helps you to:</p>
<ul class="simple">
<li><p>scale your deployments horizontally by specifying a number of replicas</p></li>
<li><p>scale up and down automatically to react to changing traffic</p></li>
<li><p>allocate hardware resources (CPUs, GPUs, etc) for each deployment</p></li>
</ul>
<section id="scaling-horizontally-with-num-replicas">
<span id="scaling-out-a-deployment"></span><h2>Scaling horizontally with <code class="docutils literal notranslate"><span class="pre">num_replicas</span></code><a class="headerlink" href="scaling-and-resource-allocation.html#scaling-horizontally-with-num-replicas" title="Permalink to this headline">#</a></h2>
<p>Each deployment consists of one or more <a class="reference internal" href="architecture.html#serve-architecture-high-level-view"><span class="std std-ref">replicas</span></a>.
The number of replicas is specified by the <code class="docutils literal notranslate"><span class="pre">num_replicas</span></code> field in the deployment options.
By default, <code class="docutils literal notranslate"><span class="pre">num_replicas</span></code> is 1.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create with a single replica.</span>
<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span><span class="p">(</span><span class="n">num_replicas</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">bind</span><span class="p">())</span>

<span class="c1"># Scale up to 3 replicas.</span>
<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">num_replicas</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">())</span>

<span class="c1"># Scale back down to 1 replica.</span>
<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">num_replicas</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="autoscaling">
<span id="ray-serve-autoscaling"></span><h2>Autoscaling<a class="headerlink" href="scaling-and-resource-allocation.html#autoscaling" title="Permalink to this headline">#</a></h2>
<p>Serve also supports a demand-based replica autoscaler. It adjusts to traffic spikes by observing queue sizes and making scaling decisions to add or remove replicas.
To configure it, you can set the <code class="docutils literal notranslate"><span class="pre">autoscaling_config</span></code> field in deployment options.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span><span class="p">(</span>
    <span class="n">autoscaling_config</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;min_replicas&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;initial_replicas&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;max_replicas&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;target_num_ongoing_requests_per_replica&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span>


<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">func</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
<span class="p">)</span>  <span class="c1"># The func deployment will now autoscale based on requests demand.</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">min_replicas</span></code> and <code class="docutils literal notranslate"><span class="pre">max_replicas</span></code> fields configure the range of replicas which the
Serve autoscaler chooses from.  Deployments will start with <code class="docutils literal notranslate"><span class="pre">initial_replicas</span></code>. <code class="docutils literal notranslate"><span class="pre">initial_replicas</span></code> is optional; it’s set to <code class="docutils literal notranslate"><span class="pre">min_replicas</span></code> by default.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">target_num_ongoing_requests_per_replica</span></code> configuration specifies how aggressively the
autoscaler should react to traffic. Serve will try to make sure that each replica has roughly that number
of requests being processed and waiting in the queue. For example, if your processing time is <code class="docutils literal notranslate"><span class="pre">10ms</span></code>
and the latency constraint is <code class="docutils literal notranslate"><span class="pre">100ms</span></code>, you can have at most <code class="docutils literal notranslate"><span class="pre">10</span></code> requests ongoing per replica so
the last requests can finish within the latency constraint. We recommend you benchmark your application
code and set this number based on end to end latency objective.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Ray Serve Autoscaler is an application-level autoscaler that sits on top of the <a class="reference internal" href="../ray-core/cluster/index.html#cluster-index"><span class="std std-ref">Ray Autoscaler</span></a>.
Concretely, this means that the Ray Serve autoscaler asks Ray to start a number of replica actors based on the request demand.
If the Ray Autoscaler determines there aren’t enough available CPUs to place these actors, it responds by requesting more Ray nodes.
The underlying cloud provider will then respond by adding more nodes.
Similarly, when Ray Serve scales down and terminates some replica actors, it will try to do so in a way that results in the most nodes having no Ray actors or tasks running on them, at which point the Ray autoscaler will remove those nodes.</p>
</div>
<p>To learn about the architecture underlying Ray Serve Autoscaling, see <a class="reference internal" href="architecture.html#serve-autoscaling-architecture"><span class="std std-ref">Ray Serve Autoscaling</span></a>.</p>
<section id="autoscaling-config-parameters">
<h3><code class="docutils literal notranslate"><span class="pre">autoscaling_config</span></code> parameters<a class="headerlink" href="scaling-and-resource-allocation.html#autoscaling-config-parameters" title="Permalink to this headline">#</a></h3>
<p>There are several user-specified parameters the autoscaling algorithm takes into consideration when deciding the target number of replicas for your deployment:</p>
<p><strong>min_replicas[default_value=1]</strong>: The minimum number of replicas for the deployment. <code class="docutils literal notranslate"><span class="pre">min_replicas</span></code> will also be the initial number of replicas when the deployment is deployed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ray Serve Autoscaling allows the <code class="docutils literal notranslate"><span class="pre">min_replicas</span></code> to be 0 when starting your deployment; the scale up will be started when you start sending traffic. There will be a cold start time as the Ray ServeHandle waits (blocks) for available replicas to assign the request.</p>
</div>
<p><strong>max_replicas[default_value=1]</strong>: The maximum number of replicas for the deployment. Ray Serve Autoscaling will rely on the Ray Autoscaler to scale up more nodes when the currently available cluster resources (CPUs, GPUs, etc.) are not enough to support more replicas.</p>
<p><strong>target_num_ongoing_requests_per_replica[default_value=1]</strong>: How many ongoing requests are expected to run concurrently per replica. The autoscaler scales up if the value is lower than the current number of ongoing requests per replica. Similarly, the autoscaler scales down if it’s higher than the current number of ongoing requests. Scaling happens quicker if there’s a high disparity between this value and the current number of ongoing requests.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>It is always recommended to load test your workloads. For example, if the use case is latency sensitive, you can lower the <code class="docutils literal notranslate"><span class="pre">target_num_ongoing_requests_per_replica</span></code> number to maintain high performance.</p></li>
<li><p>Internally, the autoscaler will decide to scale up or down by comparing <code class="docutils literal notranslate"><span class="pre">target_num_ongoing_requests_per_replica</span></code> to the number of <code class="docutils literal notranslate"><span class="pre">RUNNING</span></code> and <code class="docutils literal notranslate"><span class="pre">PENDING</span></code> tasks on each replica.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">target_num_ongoing_requests_per_replica</span></code> is only a target value used for autoscaling (not a hard limit), the real ongoing requests number can be higher than the config.</p></li>
</ul>
</div>
<p><strong>downscale_delay_s[default_value=600.0]</strong>: How long the cluster needs to wait before scaling down replicas.</p>
<p><strong>upscale_delay_s[default_value=30.0]</strong>: How long the cluster needs to wait before scaling up replicas.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">downscale_delay_s</span></code> and <code class="docutils literal notranslate"><span class="pre">upscale_delay_s</span></code> control the frequency of doing autoscaling work. For example, if your application takes a long time to do initialization work, you can increase <code class="docutils literal notranslate"><span class="pre">downscale_delay_s</span></code> to make the downscaling happen slowly.</p>
</div>
<p><strong>smoothing_factor[default_value=1.0]</strong>: The multiplicative factor to speed up or slow down each autoscaling step. For example, when the application has high traffic volume in short period of time, you can increase <code class="docutils literal notranslate"><span class="pre">smoothing_factor</span></code> to scale up the resource quickly.  You can think of this as a “gain” factor to amplify the response of the autoscaling algorithm.</p>
<p><strong>metrics_interval_s[default_value=10]</strong>: This controls how often each replica sends metrics to the autoscaler. (Normally you don’t need to change this config.)</p>
</section>
</section>
<section id="resource-management-cpus-gpus">
<span id="serve-cpus-gpus"></span><h2>Resource Management (CPUs, GPUs)<a class="headerlink" href="scaling-and-resource-allocation.html#resource-management-cpus-gpus" title="Permalink to this headline">#</a></h2>
<p>You may want to specify a deployment’s resource requirements to reserve cluster resources like GPUs.  To assign hardware resources per replica, you can pass resource requirements to
<code class="docutils literal notranslate"><span class="pre">ray_actor_options</span></code>.
By default, each replica reserves one CPU.
To learn about options to pass in, take a look at the <a class="reference internal" href="../ray-more-libs/actors.html#actor-resource-guide"><span class="std std-ref">Resources with Actors guide</span></a>.</p>
<p>For example, to create a deployment where each replica uses a single GPU, you can do the
following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span><span class="p">(</span><span class="n">ray_actor_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;num_gpus&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">do_something_with_my_gpu</span><span class="p">()</span>
</pre></div>
</div>
<section id="fractional-cpus-and-fractional-gpus">
<span id="serve-fractional-resources-guide"></span><h3>Fractional CPUs and Fractional GPUs<a class="headerlink" href="scaling-and-resource-allocation.html#fractional-cpus-and-fractional-gpus" title="Permalink to this headline">#</a></h3>
<p>Suppose you have two models and each doesn’t fully saturate a GPU.  You might want to have them share a GPU by allocating 0.5 GPUs each.</p>
<p>To do this, the resources specified in <code class="docutils literal notranslate"><span class="pre">ray_actor_options</span></code> can be <em>fractional</em>.
For example, if you have two models and each doesn’t fully saturate a GPU, you might want to have them share a GPU by allocating 0.5 GPUs each.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span><span class="p">(</span><span class="n">ray_actor_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;num_gpus&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">func_1</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">do_something_with_my_gpu</span><span class="p">()</span>

<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span><span class="p">(</span><span class="n">ray_actor_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;num_gpus&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">func_2</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">do_something_with_my_gpu</span><span class="p">()</span>
</pre></div>
</div>
<p>In this example, each replica of each deployment will be allocated 0.5 GPUs.  The same can be done to multiplex over CPUs, using <code class="docutils literal notranslate"><span class="pre">&quot;num_cpus&quot;</span></code>.</p>
</section>
<section id="custom-resources-accelerator-types-and-more">
<h3>Custom Resources, Accelerator types, and more<a class="headerlink" href="scaling-and-resource-allocation.html#custom-resources-accelerator-types-and-more" title="Permalink to this headline">#</a></h3>
<p>You can also specify <a class="reference internal" href="../ray-core/configure.html#cluster-resources"><span class="std std-ref">custom resources</span></a> in <code class="docutils literal notranslate"><span class="pre">ray_actor_options</span></code>, for example to ensure that a deployment is scheduled on a specific node.
For example, if you have a deployment that requires 2 units of the <code class="docutils literal notranslate"><span class="pre">&quot;custom_resource&quot;</span></code> resource, you can specify it like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span><span class="p">(</span><span class="n">ray_actor_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;custom_resource&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}})</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">do_something_with_my_custom_resource</span><span class="p">()</span>
</pre></div>
</div>
<p>You can also specify <a class="reference internal" href="../ray-core/tasks/using-ray-with-gpus.html#accelerator-types"><span class="std std-ref">accelerator types</span></a> via the <code class="docutils literal notranslate"><span class="pre">accelerator_type</span></code> parameter in <code class="docutils literal notranslate"><span class="pre">ray_actor_options</span></code>.</p>
<p>Below is the full list of supported options in <code class="docutils literal notranslate"><span class="pre">ray_actor_options</span></code>; please see the relevant Ray Core documentation for more details about each option:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">accelerator_type</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">memory</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_cpus</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_gpus</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">object_store_memory</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resources</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">runtime_env</span></code></p></li>
</ul>
</section>
</section>
<section id="configuring-parallelism-with-omp-num-threads">
<span id="serve-omp-num-threads"></span><h2>Configuring Parallelism with OMP_NUM_THREADS<a class="headerlink" href="scaling-and-resource-allocation.html#configuring-parallelism-with-omp-num-threads" title="Permalink to this headline">#</a></h2>
<p>Deep learning models like PyTorch and Tensorflow often use multithreading when performing inference.
The number of CPUs they use is controlled by the <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> environment variable.
Ray sets <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS=&lt;num_cpus&gt;</span></code> by default. To <a class="reference internal" href="../ray-core/configure.html#omp-num-thread-note"><span class="std std-ref">avoid contention</span></a>, Ray sets <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS=1</span></code> if <code class="docutils literal notranslate"><span class="pre">num_cpus</span></code> is not specified on the tasks/actors, to reduce contention between actors/tasks which run in a single thread.
If you <em>do</em> want to enable this parallelism in your Serve deployment, just set <code class="docutils literal notranslate"><span class="pre">num_cpus</span></code> (recommended) to the desired value, or manually set the <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> environment variable when starting Ray or in your function/class definition.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">12</span> ray start --head
<span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">12</span> ray start --address<span class="o">=</span><span class="nv">$HEAD_NODE_ADDRESS</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">MyDeployment</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parallelism</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parallelism</span>
        <span class="c1"># Download model weights, initialize model, etc.</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">MyDeployment</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;12&quot;</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some other libraries may not respect <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> and have their own way to configure parallelism.
For example, if you’re using OpenCV, you’ll need to manually set the number of threads using <code class="docutils literal notranslate"><span class="pre">cv2.setNumThreads(num_threads)</span></code> (set to 0 to disable multi-threading).
You can check the configuration using <code class="docutils literal notranslate"><span class="pre">cv2.getNumThreads()</span></code> and <code class="docutils literal notranslate"><span class="pre">cv2.getNumberOfCPUs()</span></code>.</p>
</div>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="monitoring.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Monitor Your Application</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="advanced-guides/index.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Advanced Guides</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The Ray Team<br/>
  
      &copy; Copyright 2023, The Ray Team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js@digest=1999514e3f237ded88cf"></script>


  </body>
</html>