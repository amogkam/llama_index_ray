
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Processing NYC taxi data using Ray Data &#8212; Ray 3.0.0.dev0</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css@digest=1999514e3f237ded88cf.css" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css@digest=1999514e3f237ded88cf.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css@digest=5115cc725059bd94278eecd172e13a965bf8f5a9.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/termynal.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_/static/css/badge_only.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js@digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/versionwarning.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script defer="defer" src="../../_static/js/docsearch.js"></script>
    <script src="../../_static/js/rate-the-docs.es.min.js"></script>
    <script defer="defer" src="../../_static/js/termynal.js"></script>
    <script defer="defer" src="../../_static/js/custom.js"></script>
    <script defer="defer" src="../../_static/js/top-navigation.js"></script>
    <script src="../../_static/js/tags.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js@digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script async="async" src="../../../../_/static/javascript/readthedocs-doc-embed.js"></script>
    <link rel="canonical" href="https://docs.ray.io/en/latest/data/examples/nyc_taxi_basic_processing.html" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Batch Training with Ray Data" href="batch_training.html" />
    <link rel="prev" title="Object Detection Batch Inference with PyTorch" href="batch_inference_object_detection.html" />

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://deer.ray.io/script.js" data-site="WYYANYOS" defer></script>
<!-- / Fathom -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110413294-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110413294-1');
</script>

<script
  src="https://widget.kapa.ai/kapa-widget.bundle.js"
  data-website-id="18a8c339-4ec5-43c8-8182-db3f2bc8c6b6"
  data-project-name="Ray"
  data-project-color="#2C2C2C"
  data-project-logo="https://global.discourse-cdn.com/business7/uploads/ray/original/1X/8f4dcb72f7cd34e2a332d548bd65860994bc8ff1.png"
></script>

<script>
(function(apiKey){
    (function(p,e,n,d,o){var v,w,x,y,z;o=p[d]=p[d]||{};o._q=o._q||[];
    v=['initialize','identify','updateOptions','pageLoad','track'];for(w=0,x=v.length;w<x;++w)(function(m){
        o[m]=o[m]||function(){o._q[m===v[0]?'unshift':'push']([m].concat([].slice.call(arguments,0)));};})(v[w]);
        y=e.createElement(n);y.async=!0;y.src='https://cdn.pendo.io/agent/static/'+apiKey+'/pendo.js';
        z=e.getElementsByTagName(n)[0];z.parentNode.insertBefore(y,z);})(window,document,'script','pendo');

        pendo.initialize({
            visitor: {
                id: 'VISITOR-UNIQUE-ID'
            },
            account: {
                id: 'ACCOUNT-UNIQUE-ID'
            }
        });
})('f89fa48a-6dd7-4d7c-67cf-a8051ed891f2');
</script>



  
<!-- RTD Extra Head -->

<link rel="stylesheet" href="../../../../_/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="application/json" id="READTHEDOCS_DATA">{"ad_free": true, "api_host": "https://readthedocs.org", "builder": "sphinx", "canonical_url": null, "docroot": "/doc/source/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-1", "language": "en", "page": "data/examples/nyc_taxi_basic_processing", "programming_language": "py", "project": "ray", "proxied_api_host": "/_", "source_suffix": ".ipynb", "subprojects": {}, "theme": "sphinx_book_theme", "user_analytics_code": "", "version": "master"}</script>

<!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
-->
<script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script>

<script type="text/javascript" src="../../../../_/static/javascript/readthedocs-analytics.js" async="async"></script>

<!-- end RTD <extrahead> -->
</head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"><div class='topnav'></div></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ray 3.0.0.dev0</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main Navigation">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Welcome to Ray!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ray
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/index.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/getting-started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-more-libs/installation.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/use-cases.html">
   Use Cases
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/examples.html">
   Example Gallery
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/ray-libraries.html">
   Ecosystem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-core/walkthrough.html">
   Ray Core
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-air/getting-started.html">
   Ray AI Runtime (AIR)
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../data.html">
   Ray Data
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../overview.html">
     Overview
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../getting-started.html">
     Getting Started
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../key-concepts.html">
     Key Concepts
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide.html">
     User Guides
    </a>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="index.html">
     Ray Data Examples
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="huggingface_vit_batch_prediction.html">
       Image Classification Batch Inference with Huggingface Vision Transformer
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="pytorch_resnet_batch_prediction.html">
       Image Classification Batch Inference with PyTorch
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="batch_inference_object_detection.html">
       Object Detection Batch Inference with PyTorch
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="nyc_taxi_basic_processing.html#">
       Processing NYC taxi data using Ray Data
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="batch_training.html">
       Batch Training with Ray Data
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="ocr_example.html">
       Scaling OCR using Ray Data
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="random-access.html">
       Random Data Access (Experimental)
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="custom-datasource.html">
       Implementing a Custom Datasource
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../faq.html">
     FAQ
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../api/api.html">
     Ray Data API
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../train/train.html">
   Ray Train
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tune.html">
   Ray Tune
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../serve/index.html">
   Ray Serve
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../rllib/index.html">
   Ray RLlib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-more-libs/index.html">
   More Libraries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-core/cluster/index.html">
   Ray Clusters
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-observability/index.html">
   Monitoring and Debugging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-references/api.html">
   References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-contribute/stability.html">
   Developer Guides
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ray-project/ray"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/issues/new?title=Issue%20on%20page%20%2Fdata/examples/nyc_taxi_basic_processing.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/edit/master/doc/source/data/examples/nyc_taxi_basic_processing.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/data/examples/nyc_taxi_basic_processing.ipynb.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#overview">
   Overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#walkthrough">
   Walkthrough
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#reading-and-inspecting-the-data">
     Reading and Inspecting the Data
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#advanced-aside-reading-partitioned-parquet-datasets">
       Advanced Aside - Reading Partitioned Parquet Datasets
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#data-exploration-and-cleaning">
     Data Exploration and Cleaning
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#advanced-aside-projection-and-filter-pushdown">
       Advanced Aside - Projection and Filter Pushdown
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#ingesting-into-model-trainers">
     Ingesting into Model Trainers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#parallel-batch-inference">
     Parallel Batch Inference
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Processing NYC taxi data using Ray Data</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#overview">
   Overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#walkthrough">
   Walkthrough
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#reading-and-inspecting-the-data">
     Reading and Inspecting the Data
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#advanced-aside-reading-partitioned-parquet-datasets">
       Advanced Aside - Reading Partitioned Parquet Datasets
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#data-exploration-and-cleaning">
     Data Exploration and Cleaning
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#advanced-aside-projection-and-filter-pushdown">
       Advanced Aside - Projection and Filter Pushdown
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#ingesting-into-model-trainers">
     Ingesting into Model Trainers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="nyc_taxi_basic_processing.html#parallel-batch-inference">
     Parallel Batch Inference
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="processing-nyc-taxi-data-using-ray-data">
<h1>Processing NYC taxi data using Ray Data<a class="headerlink" href="nyc_taxi_basic_processing.html#processing-nyc-taxi-data-using-ray-data" title="Permalink to this headline">#</a></h1>
<p>The <a class="reference external" href="https://www1.nyc.gov/site/tlc/about/tlc-trip-record-data.page">NYC Taxi dataset</a> is a popular tabular dataset.  In this example, we demonstrate some basic data processing on this dataset using Ray Data.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="nyc_taxi_basic_processing.html#overview" title="Permalink to this headline">#</a></h2>
<p>This tutorial will cover:</p>
<ul class="simple">
<li><p>Reading Parquet data</p></li>
<li><p>Inspecting the metadata and first few rows of a large Ray <a class="reference internal" href="../api/doc/ray.data.Dataset.html#ray.data.Dataset" title="ray.data.Dataset"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dataset</span></code></a></p></li>
<li><p>Calculating some common global and grouped statistics on the dataset</p></li>
<li><p>Dropping columns and rows</p></li>
<li><p>Adding a derived column</p></li>
<li><p>Shuffling the data</p></li>
<li><p>Sharding the data and feeding it to parallel consumers (trainers)</p></li>
<li><p>Applying batch (offline) inference to the data</p></li>
</ul>
</section>
<section id="walkthrough">
<h2>Walkthrough<a class="headerlink" href="nyc_taxi_basic_processing.html#walkthrough" title="Permalink to this headline">#</a></h2>
<p>Let’s start by importing Ray and initializing a local Ray cluster.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import ray and initialize a local Ray cluster.</span>
<span class="kn">import</span> <span class="nn">ray</span>
<span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="reading-and-inspecting-the-data">
<h3>Reading and Inspecting the Data<a class="headerlink" href="nyc_taxi_basic_processing.html#reading-and-inspecting-the-data" title="Permalink to this headline">#</a></h3>
<p>Next, we read a few of the files from the dataset. This read is lazy, where reading and all future transformations are delayed until a downstream operation triggers execution (e.g. consuming the data with <a class="reference internal" href="../api/doc/ray.data.Dataset.take.html#ray.data.Dataset.take" title="ray.data.Dataset.take"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ds.take()</span></code></a>)</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read two Parquet files in parallel.</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">([</span>
    <span class="s2">&quot;s3://anonymous@air-example-data/ursa-labs-taxi-data/downsampled_2009_01_data.parquet&quot;</span><span class="p">,</span>
    <span class="s2">&quot;s3://anonymous@air-example-data/ursa-labs-taxi-data/downsampled_2009_02_data.parquet&quot;</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>We can easily inspect the schema of this dataset. For Parquet files, we don’t even have to read the actual data to get the schema; we can read it from the lightweight Parquet metadata!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fetch the schema from the underlying Parquet metadata.</span>
<span class="n">ds</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>vendor_id: string
pickup_at: timestamp[us]
dropoff_at: timestamp[us]
passenger_count: int8
trip_distance: float
pickup_longitude: float
pickup_latitude: float
rate_code_id: null
store_and_fwd_flag: string
dropoff_longitude: float
dropoff_latitude: float
payment_type: string
fare_amount: float
extra: float
mta_tax: float
tip_amount: float
tolls_amount: float
total_amount: float
-- schema metadata --
pandas: &#39;{&quot;index_columns&quot;: [{&quot;kind&quot;: &quot;range&quot;, &quot;name&quot;: null, &quot;start&quot;: 0, &quot;&#39; + 2524
</pre></div>
</div>
</div>
</div>
<p>Parquet even stores the number of rows per file in the Parquet metadata, so we can get the number of rows in <code class="docutils literal notranslate"><span class="pre">ds</span></code> without triggering a full data read.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2749936
</pre></div>
</div>
</div>
</div>
<p>We can get a nice, cheap summary of the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> by leveraging it’s informative repr:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display some metadata about the dataset.</span>
<span class="n">ds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset(num_blocks=2, num_rows=2749936, schema={vendor_id: string, pickup_at: timestamp[us], dropoff_at: timestamp[us], passenger_count: int8, trip_distance: float, pickup_longitude: float, pickup_latitude: float, rate_code_id: null, store_and_fwd_flag: string, dropoff_longitude: float, dropoff_latitude: float, payment_type: string, fare_amount: float, extra: float, mta_tax: float, tip_amount: float, tolls_amount: float, total_amount: float})
</pre></div>
</div>
</div>
</div>
<p>We can also poke at the actual data, taking a peek at a single row. Since this is only returning a row from the first file, reading of the second file is <strong>not</strong> triggered yet.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ArrowRow({&#39;vendor_id&#39;: &#39;VTS&#39;,
           &#39;pickup_at&#39;: datetime.datetime(2009, 1, 21, 14, 58),
           &#39;dropoff_at&#39;: datetime.datetime(2009, 1, 21, 15, 3),
           &#39;passenger_count&#39;: 1,
           &#39;trip_distance&#39;: 0.5299999713897705,
           &#39;pickup_longitude&#39;: -73.99270629882812,
           &#39;pickup_latitude&#39;: 40.7529411315918,
           &#39;rate_code_id&#39;: None,
           &#39;store_and_fwd_flag&#39;: None,
           &#39;dropoff_longitude&#39;: -73.98814392089844,
           &#39;dropoff_latitude&#39;: 40.75956344604492,
           &#39;payment_type&#39;: &#39;CASH&#39;,
           &#39;fare_amount&#39;: 4.5,
           &#39;extra&#39;: 0.0,
           &#39;mta_tax&#39;: None,
           &#39;tip_amount&#39;: 0.0,
           &#39;tolls_amount&#39;: 0.0,
           &#39;total_amount&#39;: 4.5})]
</pre></div>
</div>
</div>
</div>
<p>To get a better sense of the data size, we can calculate the size in bytes of the full dataset. Note that for Parquet files, this size-in-bytes will be pulled from the Parquet metadata (not triggering a data read), and therefore might be significantly different than the in-memory size!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span><span class="o">.</span><span class="n">size_bytes</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>427503965
</pre></div>
</div>
</div>
</div>
<p>In order to get the in-memory size, we can trigger full reading of the dataset and inspect the size in bytes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span><span class="o">.</span><span class="n">materialize</span><span class="p">()</span><span class="o">.</span><span class="n">size_bytes</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Read progress: 100%|██████████| 2/2 [00:00&lt;00:00,  2.50it/s]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>226524489
</pre></div>
</div>
</div>
</div>
<section id="advanced-aside-reading-partitioned-parquet-datasets">
<h4>Advanced Aside - Reading Partitioned Parquet Datasets<a class="headerlink" href="nyc_taxi_basic_processing.html#advanced-aside-reading-partitioned-parquet-datasets" title="Permalink to this headline">#</a></h4>
<p>In addition to being able to read lists of individual files, <a class="reference internal" href="../api/doc/ray.data.read_parquet.html#ray.data.read_parquet" title="ray.data.read_parquet"><code class="xref py py-func docutils literal notranslate"><span class="pre">ray.data.read_parquet()</span></code></a> (as well as other <code class="docutils literal notranslate"><span class="pre">ray.data.read_*()</span></code> APIs) can read directories containing multiple Parquet files. For Parquet in particular, reading Parquet datasets partitioned by a particular column is supported, allowing for path-based (zero-read) partition filtering and (optionally) including the partition column value specified in the file paths directly in the read table data.</p>
<p>For the NYC taxi dataset, instead of reading individual per-month Parquet files, we can read the entire 2009 directory.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This could be a lot of data (downsampled with 0.01 ratio leads to ~50.2 MB on disk, ~147 MB in memory), so be careful triggering full reads on a limited-memory machine! This is one place where Dataset’s lazy reading comes in handy: Dataset will not execute any read tasks eagerly and will execute the minimum number of file reads to satisfy downstream operations, which allows us to inspect a subset of the data without having to read the entire dataset.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read all Parquet data for the year 2009.</span>
<span class="n">year_ds</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;s3://anonymous@air-example-data/ursa-labs-taxi-data/downsampled_2009_full_year_data.parquet&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<p>The metadata that Dataset prints in its repr is guaranteed to not trigger reads of all files; data such as the row count and the schema is pulled directly from the Parquet metadata.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">year_ds</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1710629
</pre></div>
</div>
</div>
</div>
<p>That’s a lot of rows! Since we’re not going to use this full-year data, let’s now delete this dataset to free up some memory in our Ray cluster.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">year_ds</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="data-exploration-and-cleaning">
<h3>Data Exploration and Cleaning<a class="headerlink" href="nyc_taxi_basic_processing.html#data-exploration-and-cleaning" title="Permalink to this headline">#</a></h3>
<p>Let’s calculate some stats to get a better picture of our data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># What&#39;s the longets trip distance, largest tip amount, and most number of passengers?</span>
<span class="n">ds</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="s2">&quot;trip_distance&quot;</span><span class="p">,</span> <span class="s2">&quot;tip_amount&quot;</span><span class="p">,</span> <span class="s2">&quot;passenger_count&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shuffle Map: 100%|██████████| 2/2 [00:00&lt;00:00, 50.69it/s]
Shuffle Reduce: 100%|██████████| 1/1 [00:00&lt;00:00, 114.04it/s]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ArrowRow({&#39;max(trip_distance)&#39;: 50.0,
          &#39;max(tip_amount)&#39;: 100.0,
          &#39;max(passenger_count)&#39;: 6})
</pre></div>
</div>
</div>
</div>
<p>We don’t have any use for the <code class="docutils literal notranslate"><span class="pre">store_and_fwd_flag</span></code> or <code class="docutils literal notranslate"><span class="pre">mta_tax</span></code> columns, so let’s drop those.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Drop some columns.</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_columns</span><span class="p">([</span><span class="s2">&quot;store_and_fwd_flag&quot;</span><span class="p">,</span> <span class="s2">&quot;mta_tax&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Map_Batches: 100%|██████████| 2/2 [00:03&lt;00:00,  1.59s/it]
</pre></div>
</div>
</div>
</div>
<p>Let’s say we want to know how many trips there are for each passenger count.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;passenger_count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">take</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sort Sample: 100%|██████████| 2/2 [00:00&lt;00:00,  5.01it/s]
Shuffle Map: 100%|██████████| 2/2 [03:21&lt;00:00, 100.61s/it]
Shuffle Reduce:   0%|          | 0/2 [00:00&lt;?, ?it/s](map pid=9272) E0725 14:35:16.665638988    9301 chttp2_transport.cc:1103]   Received a GOAWAY with error code ENHANCE_YOUR_CALM and debug data equal to &quot;too_many_pings&quot;
Shuffle Reduce: 100%|██████████| 2/2 [00:01&lt;00:00,  1.97it/s]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[PandasRow({&#39;passenger_count&#39;: -48, &#39;count()&#39;: 3}),
 PandasRow({&#39;passenger_count&#39;: 0, &#39;count()&#39;: 91}),
 PandasRow({&#39;passenger_count&#39;: 1, &#39;count()&#39;: 1865548}),
 PandasRow({&#39;passenger_count&#39;: 2, &#39;count()&#39;: 451452}),
 PandasRow({&#39;passenger_count&#39;: 3, &#39;count()&#39;: 119406}),
 PandasRow({&#39;passenger_count&#39;: 4, &#39;count()&#39;: 55547}),
 PandasRow({&#39;passenger_count&#39;: 5, &#39;count()&#39;: 245332}),
 PandasRow({&#39;passenger_count&#39;: 6, &#39;count()&#39;: 12557})]
</pre></div>
</div>
</div>
</div>
<p>Again, it looks like there are some more nonsensical passenger counts, i.e. the negative ones. Let’s filter those out too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filter our records with negative passenger counts.</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;passenger_count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Map_Batches: 100%|██████████| 2/2 [00:03&lt;00:00,  1.60s/it]
</pre></div>
</div>
</div>
</div>
<p>Do the passenger counts influences the typical trip distance?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mean trip distance grouped by passenger count.</span>
<span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;passenger_count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;trip_distance&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sort Sample: 100%|██████████| 2/2 [00:00&lt;00:00,  4.57it/s]
Shuffle Map: 100%|██████████| 2/2 [03:23&lt;00:00, 101.59s/it]
Shuffle Reduce: 100%|██████████| 2/2 [00:00&lt;00:00, 178.79it/s]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[PandasRow({&#39;passenger_count&#39;: 1, &#39;mean(trip_distance)&#39;: 2.543288084787955}),
 PandasRow({&#39;passenger_count&#39;: 2, &#39;mean(trip_distance)&#39;: 2.7043459216040686}),
 PandasRow({&#39;passenger_count&#39;: 3, &#39;mean(trip_distance)&#39;: 2.6233412684454716}),
 PandasRow({&#39;passenger_count&#39;: 4, &#39;mean(trip_distance)&#39;: 2.642096445352584}),
 PandasRow({&#39;passenger_count&#39;: 5, &#39;mean(trip_distance)&#39;: 2.6286944833939314}),
 PandasRow({&#39;passenger_count&#39;: 6, &#39;mean(trip_distance)&#39;: 2.5848625579855855})]
</pre></div>
</div>
</div>
</div>
<p>See <a class="reference internal" href="../transforming-data.html#transforming-data"><span class="std std-ref">Transforming Data</span></a> for more information on how we can process our data with Ray Data.</p>
<section id="advanced-aside-projection-and-filter-pushdown">
<h4>Advanced Aside - Projection and Filter Pushdown<a class="headerlink" href="nyc_taxi_basic_processing.html#advanced-aside-projection-and-filter-pushdown" title="Permalink to this headline">#</a></h4>
<p>Note that Ray Data’ Parquet reader supports projection (column selection) and row filter pushdown, where we can push the above column selection and the row-based filter to the Parquet read. If we specify column selection at Parquet read time, the unselected columns won’t even be read from disk!</p>
<p>The row-based filter is specified via
<a class="reference external" href="https://arrow.apache.org/docs/6.0/python/generated/pyarrow.dataset.Expression.html#pyarrow.dataset.Expression">Arrow’s dataset field expressions</a>. See the <a class="reference internal" href="../performance-tips.html#parquet-row-pruning"><span class="std std-ref">Parquet row pruning tips</span></a> for more information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Only read the passenger_count and trip_distance columns.</span>
<span class="kn">import</span> <span class="nn">pyarrow</span> <span class="k">as</span> <span class="nn">pa</span>
<span class="n">filter_expr</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;passenger_count&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;passenger_count&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">pushdown_ds</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;s3://anonymous@air-example-data/ursa-labs-taxi-data/downsampled_2009_01_data.parquet&quot;</span><span class="p">,</span>
        <span class="s2">&quot;s3://anonymous@air-example-data/ursa-labs-taxi-data/downsampled_2009_02_data.parquet&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;passenger_count&quot;</span><span class="p">,</span> <span class="s2">&quot;trip_distance&quot;</span><span class="p">],</span>
    <span class="nb">filter</span><span class="o">=</span><span class="n">filter_expr</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Force full execution of both of the file reads.</span>
<span class="n">pushdown_ds</span> <span class="o">=</span> <span class="n">pushdown_ds</span><span class="o">.</span><span class="n">materialize</span><span class="p">()</span>
<span class="n">pushdown_ds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>⚠️  The number of blocks in this dataset (2) limits its parallelism to 2 concurrent tasks. This is much less than the number of available CPU slots in the cluster. Use `.repartition(n)` to increase the number of dataset blocks.
Read progress: 100%|██████████| 2/2 [00:00&lt;00:00,  9.19it/s]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset(num_blocks=2, num_rows=2749842, schema={passenger_count: int8, trip_distance: float})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Delete the pushdown dataset. Deleting the Dataset object</span>
<span class="c1"># will release the underlying memory in the cluster.</span>
<span class="k">del</span> <span class="n">pushdown_ds</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="ingesting-into-model-trainers">
<h3>Ingesting into Model Trainers<a class="headerlink" href="nyc_taxi_basic_processing.html#ingesting-into-model-trainers" title="Permalink to this headline">#</a></h3>
<p>Now that we’ve learned more about our data and we have cleaned up our dataset a bit, we now look at how we can feed this dataset into some dummy model trainers.</p>
<p>First, let’s do a full global random shuffle of the dataset to decorrelate these samples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">random_shuffle</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shuffle Map: 100%|██████████| 2/2 [00:01&lt;00:00,  1.34it/s]
Shuffle Reduce: 100%|██████████| 2/2 [00:01&lt;00:00,  1.09it/s]
</pre></div>
</div>
</div>
</div>
<p>We define a dummy <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> actor, where each trainer will consume a dataset shard in batches and simulate model training.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In a real training workflow, we would feed <code class="docutils literal notranslate"><span class="pre">ds</span></code> to <a class="reference internal" href="../../train/train.html#train-docs"><span class="std std-ref">Ray Train</span></a>, which would do this sharding and creation of training actors for us, under the hood.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span>
<span class="k">class</span> <span class="nc">Trainer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rank</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shard</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">shard</span><span class="o">.</span><span class="n">iter_batches</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">shard</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

<span class="n">trainers</span> <span class="o">=</span> <span class="p">[</span><span class="n">Trainer</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">trainers</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Actor(Trainer, 9326d43345699213608f324003000000),
 Actor(Trainer, f0ce2ce44528fbf748c9c1a103000000),
 Actor(Trainer, 7ba39c8f82ebd78c68e92ec903000000),
 Actor(Trainer, b95fe3494b7bc2d8f42abbba03000000)]
</pre></div>
</div>
</div>
</div>
<p>Next, we split the dataset into <code class="docutils literal notranslate"><span class="pre">len(trainers)</span></code> shards, ensuring that the shards are of equal size.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shards</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">trainers</span><span class="p">),</span> <span class="n">equal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">shards</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Dataset(num_blocks=1, num_rows=687460, schema={vendor_id: object, pickup_at: datetime64[ns], dropoff_at: datetime64[ns], passenger_count: int8, trip_distance: float32, pickup_longitude: float32, pickup_latitude: float32, rate_code_id: object, dropoff_longitude: float32, dropoff_latitude: float32, payment_type: object, fare_amount: float32, extra: float32, tip_amount: float32, tolls_amount: float32, total_amount: float32}),
 Dataset(num_blocks=1, num_rows=687460, schema={vendor_id: object, pickup_at: datetime64[ns], dropoff_at: datetime64[ns], passenger_count: int8, trip_distance: float32, pickup_longitude: float32, pickup_latitude: float32, rate_code_id: object, dropoff_longitude: float32, dropoff_latitude: float32, payment_type: object, fare_amount: float32, extra: float32, tip_amount: float32, tolls_amount: float32, total_amount: float32}),
 Dataset(num_blocks=2, num_rows=687460, schema={vendor_id: object, pickup_at: datetime64[ns], dropoff_at: datetime64[ns], passenger_count: int8, trip_distance: float32, pickup_longitude: float32, pickup_latitude: float32, rate_code_id: object, dropoff_longitude: float32, dropoff_latitude: float32, payment_type: object, fare_amount: float32, extra: float32, tip_amount: float32, tolls_amount: float32, total_amount: float32}),
 Dataset(num_blocks=1, num_rows=687460, schema={vendor_id: object, pickup_at: datetime64[ns], dropoff_at: datetime64[ns], passenger_count: int8, trip_distance: float32, pickup_longitude: float32, pickup_latitude: float32, rate_code_id: object, dropoff_longitude: float32, dropoff_latitude: float32, payment_type: object, fare_amount: float32, extra: float32, tip_amount: float32, tolls_amount: float32, total_amount: float32})]
</pre></div>
</div>
</div>
</div>
<p>Finally, we simulate training, passing each shard to the corresponding trainer. The number of rows per shard is returned.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trainers</span><span class="p">,</span> <span class="n">shards</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[687460, 687460, 687460, 687460]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Delete trainer actor handle references, which should terminate the actors.</span>
<span class="k">del</span> <span class="n">trainers</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="parallel-batch-inference">
<h3>Parallel Batch Inference<a class="headerlink" href="nyc_taxi_basic_processing.html#parallel-batch-inference" title="Permalink to this headline">#</a></h3>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Refer to the blog on <a class="reference external" href="https://www.anyscale.com/blog/model-batch-inference-in-ray-actors-actorpool-and-datasets">Model Batch Inference in Ray</a> for an overview of batch inference strategies in Ray and additional examples.</p>
</div>
<p>After we’ve trained a model, we may want to perform batch (offline) inference on such a tabular dataset. With Ray Data, this is as easy as a <a class="reference internal" href="../api/doc/ray.data.Dataset.map_batches.html#ray.data.Dataset.map_batches" title="ray.data.Dataset.map_batches"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ds.map_batches()</span></code></a> call!</p>
<p>First, we define a callable class that will cache the loading of the model in its constructor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">def</span> <span class="nf">load_model</span><span class="p">():</span>
    <span class="c1"># A dummy model.</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;passenger_count&quot;</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">})</span>
    
    <span class="k">return</span> <span class="n">model</span>

<span class="k">class</span> <span class="nc">BatchInferModel</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BatchInferModel</span></code>’s constructor will only be called once per actor worker when using the actor pool compute strategy in <a class="reference internal" href="../api/doc/ray.data.Dataset.map_batches.html#ray.data.Dataset.map_batches" title="ray.data.Dataset.map_batches"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ds.map_batches()</span></code></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span><span class="n">BatchInferModel</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ActorPoolStrategy</span><span class="p">())</span><span class="o">.</span><span class="n">take</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Map Progress (2 actors 1 pending): 100%|██████████| 2/2 [00:05&lt;00:00,  2.57s/it]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False})]
</pre></div>
</div>
</div>
</div>
<p>If wanting to perform batch inference on GPUs, simply specify the number of GPUs you wish to provision for each batch inference worker.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This will only run successfully if your cluster has nodes with GPUs!</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span>
    <span class="n">BatchInferModel</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="c1">#num_gpus=1,  # Uncomment this to run this on GPUs!</span>
    <span class="n">compute</span><span class="o">=</span><span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ActorPoolStrategy</span><span class="p">(),</span>
<span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Map Progress (15 actors 4 pending): 100%|██████████| 2/2 [00:21&lt;00:00, 10.67s/it]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False})]
</pre></div>
</div>
</div>
</div>
<p>We can also configure the autoscaling actor pool that this inference stage uses, setting upper and lower bounds on the actor pool size, and even tweak the batch prefetching vs. inference task queueing tradeoff.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ray.data</span> <span class="kn">import</span> <span class="n">ActorPoolStrategy</span>

<span class="c1"># The actor pool will have at least 2 workers and at most 8 workers.</span>
<span class="n">strategy</span> <span class="o">=</span> <span class="n">ActorPoolStrategy</span><span class="p">(</span><span class="n">min_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="n">ds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span>
    <span class="n">BatchInferModel</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="c1">#num_gpus=1,  # Uncomment this to run this on GPUs!</span>
    <span class="n">compute</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Map Progress (8 actors 0 pending): 100%|██████████| 2/2 [00:21&lt;00:00, 10.71s/it]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: False}),
 PandasRow({&#39;score&#39;: True}),
 PandasRow({&#39;score&#39;: False})]
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="batch_inference_object_detection.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Object Detection Batch Inference with PyTorch</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="batch_training.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Batch Training with Ray Data</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The Ray Team<br/>
  
      &copy; Copyright 2023, The Ray Team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js@digest=1999514e3f237ded88cf"></script>


  </body>
</html>