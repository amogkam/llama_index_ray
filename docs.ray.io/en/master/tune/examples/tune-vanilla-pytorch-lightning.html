
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Using PyTorch Lightning with Tune &#8212; Ray 3.0.0.dev0</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css@digest=1999514e3f237ded88cf.css" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css@digest=1999514e3f237ded88cf.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css@digest=5115cc725059bd94278eecd172e13a965bf8f5a9.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/termynal.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_/static/css/badge_only.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js@digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/versionwarning.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script defer="defer" src="../../_static/js/docsearch.js"></script>
    <script src="../../_static/js/rate-the-docs.es.min.js"></script>
    <script defer="defer" src="../../_static/js/termynal.js"></script>
    <script defer="defer" src="../../_static/js/custom.js"></script>
    <script defer="defer" src="../../_static/js/top-navigation.js"></script>
    <script src="../../_static/js/tags.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js@digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script async="async" src="../../../../_/static/javascript/readthedocs-doc-embed.js"></script>
    <link rel="canonical" href="https://docs.ray.io/en/latest/tune/examples/tune-vanilla-pytorch-lightning.html" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://deer.ray.io/script.js" data-site="WYYANYOS" defer></script>
<!-- / Fathom -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110413294-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110413294-1');
</script>

<script
  src="https://widget.kapa.ai/kapa-widget.bundle.js"
  data-website-id="18a8c339-4ec5-43c8-8182-db3f2bc8c6b6"
  data-project-name="Ray"
  data-project-color="#2C2C2C"
  data-project-logo="https://global.discourse-cdn.com/business7/uploads/ray/original/1X/8f4dcb72f7cd34e2a332d548bd65860994bc8ff1.png"
></script>

<script>
(function(apiKey){
    (function(p,e,n,d,o){var v,w,x,y,z;o=p[d]=p[d]||{};o._q=o._q||[];
    v=['initialize','identify','updateOptions','pageLoad','track'];for(w=0,x=v.length;w<x;++w)(function(m){
        o[m]=o[m]||function(){o._q[m===v[0]?'unshift':'push']([m].concat([].slice.call(arguments,0)));};})(v[w]);
        y=e.createElement(n);y.async=!0;y.src='https://cdn.pendo.io/agent/static/'+apiKey+'/pendo.js';
        z=e.getElementsByTagName(n)[0];z.parentNode.insertBefore(y,z);})(window,document,'script','pendo');

        pendo.initialize({
            visitor: {
                id: 'VISITOR-UNIQUE-ID'
            },
            account: {
                id: 'ACCOUNT-UNIQUE-ID'
            }
        });
})('f89fa48a-6dd7-4d7c-67cf-a8051ed891f2');
</script>



  
<!-- RTD Extra Head -->

<link rel="stylesheet" href="../../../../_/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="application/json" id="READTHEDOCS_DATA">{"ad_free": true, "api_host": "https://readthedocs.org", "builder": "sphinx", "canonical_url": null, "docroot": "/doc/source/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-1", "language": "en", "page": "tune/examples/tune-vanilla-pytorch-lightning", "programming_language": "py", "project": "ray", "proxied_api_host": "/_", "source_suffix": ".ipynb", "subprojects": {}, "theme": "sphinx_book_theme", "user_analytics_code": "", "version": "master"}</script>

<!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
-->
<script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script>

<script type="text/javascript" src="../../../../_/static/javascript/readthedocs-analytics.js" async="async"></script>

<!-- end RTD <extrahead> -->
</head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"><div class='topnav'></div></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ray 3.0.0.dev0</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main Navigation">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Welcome to Ray!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ray
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/index.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/getting-started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-more-libs/installation.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/use-cases.html">
   Use Cases
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/examples.html">
   Example Gallery
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/ray-libraries.html">
   Ecosystem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-core/walkthrough.html">
   Ray Core
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-air/getting-started.html">
   Ray AI Runtime (AIR)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../data/data.html">
   Ray Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../train/train.html">
   Ray Train
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tune.html">
   Ray Tune
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../serve/index.html">
   Ray Serve
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../rllib/index.html">
   Ray RLlib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-more-libs/index.html">
   More Libraries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-core/cluster/index.html">
   Ray Clusters
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-observability/index.html">
   Monitoring and Debugging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-references/api.html">
   References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-contribute/stability.html">
   Developer Guides
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ray-project/ray"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/issues/new?title=Issue%20on%20page%20%2Ftune/examples/tune-vanilla-pytorch-lightning.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/edit/master/doc/source/tune/examples/tune-vanilla-pytorch-lightning.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/tune/examples/tune-vanilla-pytorch-lightning.ipynb.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#pytorch-lightning-classifier-for-mnist">
   PyTorch Lightning classifier for MNIST
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#tuning-the-model-parameters">
   Tuning the model parameters
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#talking-to-tune-with-a-pytorch-lightning-callback">
     Talking to Tune with a PyTorch Lightning callback
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#adding-the-tune-training-function">
     Adding the Tune training function
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#configuring-the-search-space">
     Configuring the search space
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#selecting-a-scheduler">
     Selecting a scheduler
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#changing-the-cli-output">
     Changing the CLI output
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#passing-constants-to-the-train-function">
     Passing constants to the train function
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#training-with-gpus">
     Training with GPUs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#putting-it-together">
     Putting it together
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#using-population-based-training-to-find-the-best-parameters">
   Using Population Based Training to find the best parameters
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#adding-checkpoints-to-the-pytorch-lightning-module">
     Adding checkpoints to the PyTorch Lightning module
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#configuring-and-running-population-based-training">
     Configuring and running Population Based Training
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#more-pytorch-lightning-examples">
   More PyTorch Lightning Examples
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Using PyTorch Lightning with Tune</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#pytorch-lightning-classifier-for-mnist">
   PyTorch Lightning classifier for MNIST
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#tuning-the-model-parameters">
   Tuning the model parameters
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#talking-to-tune-with-a-pytorch-lightning-callback">
     Talking to Tune with a PyTorch Lightning callback
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#adding-the-tune-training-function">
     Adding the Tune training function
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#configuring-the-search-space">
     Configuring the search space
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#selecting-a-scheduler">
     Selecting a scheduler
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#changing-the-cli-output">
     Changing the CLI output
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#passing-constants-to-the-train-function">
     Passing constants to the train function
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#training-with-gpus">
     Training with GPUs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#putting-it-together">
     Putting it together
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#using-population-based-training-to-find-the-best-parameters">
   Using Population Based Training to find the best parameters
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#adding-checkpoints-to-the-pytorch-lightning-module">
     Adding checkpoints to the PyTorch Lightning module
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#configuring-and-running-population-based-training">
     Configuring and running Population Based Training
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="tune-vanilla-pytorch-lightning.html#more-pytorch-lightning-examples">
   More PyTorch Lightning Examples
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="using-pytorch-lightning-with-tune">
<h1>Using PyTorch Lightning with Tune<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#using-pytorch-lightning-with-tune" title="Permalink to this headline">#</a></h1>
<p id="tune-vanilla-pytorch-lightning-ref">PyTorch Lightning is a framework which brings structure into training PyTorch models. It
aims to avoid boilerplate code, so you don’t have to write the same training
loops all over again when building a new model.</p>
<img alt="../../_images/pytorch_lightning_full.png" class="align-center" src="../../_images/pytorch_lightning_full.png" />
<p>The main abstraction of PyTorch Lightning is the <code class="docutils literal notranslate"><span class="pre">LightningModule</span></code> class, which
should be extended by your application. There is <a class="reference external" href="https://towardsdatascience.com/from-pytorch-to-pytorch-lightning-a-gentle-introduction-b371b7caaf09">a great post on how to transfer your models from vanilla PyTorch to Lightning</a>.</p>
<p>The class structure of PyTorch Lightning makes it very easy to define and tune model
parameters. This tutorial will show you how to use Tune to find the best set of
parameters for your application on the example of training a MNIST classifier. Notably,
the <code class="docutils literal notranslate"><span class="pre">LightningModule</span></code> does not have to be altered at all for this - so you can
use it plug and play for your existing models, assuming their parameters are configurable!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To run this example, you will need to install the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install <span class="s2">&quot;ray[tune]&quot;</span> torch torchvision pytorch-lightning
</pre></div>
</div>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="tune-vanilla-pytorch-lightning.html#pytorch-lightning-classifier-for-mnist" id="id1">PyTorch Lightning classifier for MNIST</a></p></li>
<li><p><a class="reference internal" href="tune-vanilla-pytorch-lightning.html#tuning-the-model-parameters" id="id2">Tuning the model parameters</a></p>
<ul>
<li><p><a class="reference internal" href="tune-vanilla-pytorch-lightning.html#talking-to-tune-with-a-pytorch-lightning-callback" id="id3">Talking to Tune with a PyTorch Lightning callback</a></p></li>
<li><p><a class="reference internal" href="tune-vanilla-pytorch-lightning.html#adding-the-tune-training-function" id="id4">Adding the Tune training function</a></p></li>
<li><p><a class="reference internal" href="tune-vanilla-pytorch-lightning.html#configuring-the-search-space" id="id5">Configuring the search space</a></p></li>
<li><p><a class="reference internal" href="tune-vanilla-pytorch-lightning.html#selecting-a-scheduler" id="id6">Selecting a scheduler</a></p></li>
<li><p><a class="reference internal" href="tune-vanilla-pytorch-lightning.html#changing-the-cli-output" id="id7">Changing the CLI output</a></p></li>
<li><p><a class="reference internal" href="tune-vanilla-pytorch-lightning.html#passing-constants-to-the-train-function" id="id8">Passing constants to the train function</a></p></li>
<li><p><a class="reference internal" href="tune-vanilla-pytorch-lightning.html#training-with-gpus" id="id9">Training with GPUs</a></p></li>
<li><p><a class="reference internal" href="tune-vanilla-pytorch-lightning.html#putting-it-together" id="id10">Putting it together</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="tune-vanilla-pytorch-lightning.html#using-population-based-training-to-find-the-best-parameters" id="id11">Using Population Based Training to find the best parameters</a></p>
<ul>
<li><p><a class="reference internal" href="tune-vanilla-pytorch-lightning.html#adding-checkpoints-to-the-pytorch-lightning-module" id="id12">Adding checkpoints to the PyTorch Lightning module</a></p></li>
<li><p><a class="reference internal" href="tune-vanilla-pytorch-lightning.html#configuring-and-running-population-based-training" id="id13">Configuring and running Population Based Training</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="tune-vanilla-pytorch-lightning.html#more-pytorch-lightning-examples" id="id14">More PyTorch Lightning Examples</a></p></li>
</ul>
</div>
<section id="pytorch-lightning-classifier-for-mnist">
<h2>PyTorch Lightning classifier for MNIST<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#pytorch-lightning-classifier-for-mnist" title="Permalink to this headline">#</a></h2>
<p>Let’s first start with the basic PyTorch Lightning implementation of an MNIST classifier.
This classifier does not include any tuning code at this point.</p>
<p>Our example builds on the MNIST example from the <a class="reference external" href="https://towardsdatascience.com/from-pytorch-to-pytorch-lightning-a-gentle-introduction-b371b7caaf09">blog post we talked about
earlier</a>.</p>
<p>First, we run some imports:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">pytorch_lightning</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">from</span> <span class="nn">filelock</span> <span class="kn">import</span> <span class="n">FileLock</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">random_split</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span> <span class="nn">torchvision.datasets</span> <span class="kn">import</span> <span class="n">MNIST</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
<p>And then there is the Lightning model adapted from the blog post.
Note that we left out the test set validation and made the model parameters
configurable through a <code class="docutils literal notranslate"><span class="pre">config</span></code> dict that is passed on initialization.
Also, we specify a <code class="docutils literal notranslate"><span class="pre">data_dir</span></code> where the MNIST data will be stored. Note that
we use a <code class="docutils literal notranslate"><span class="pre">FileLock</span></code> for downloading data so that the dataset is only downloaded
once per node.
Lastly, we added a new metric, the validation accuracy, to the logs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LightningMNISTClassifier</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This has been adapted from</span>
<span class="sd">    https://towardsdatascience.com/from-pytorch-to-pytorch-lightning-a-gentle-introduction-b371b7caaf09</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LightningMNISTClassifier</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layer_1_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layer_1_size&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_2_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layer_2_size&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;lr&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>

        <span class="c1"># mnist images are (1, 28, 28) (channels, width, height)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_1_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_1_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_2_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_2_size</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">cross_entropy_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">accuracy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">train_batch</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_entropy_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accuracy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;ptl/train_loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;ptl/train_accuracy&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val_batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">val_batch</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_entropy_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accuracy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;val_loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span> <span class="s2">&quot;val_accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validation_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">avg_acc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;val_accuracy&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;ptl/val_loss&quot;</span><span class="p">,</span> <span class="n">avg_loss</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;ptl/val_accuracy&quot;</span><span class="p">,</span> <span class="n">avg_acc</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">download_data</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.1307</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mf">0.3081</span><span class="p">,</span> <span class="p">))</span>
        <span class="p">])</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/.data.lock&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">MNIST</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mnist_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mnist_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mnist_val</span> <span class="o">=</span> <span class="n">random_split</span><span class="p">(</span>
            <span class="n">mnist_train</span><span class="p">,</span> <span class="p">[</span><span class="mi">55000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">train_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mnist_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">val_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mnist_val</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">optimizer</span>


<span class="k">def</span> <span class="nf">train_mnist</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">LightningMNISTClassifier</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">max_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">enable_progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And that’s it! You can now run <code class="docutils literal notranslate"><span class="pre">train_mnist(config)</span></code> to train the classifier, e.g.
like so:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train_mnist_no_tune</span><span class="p">():</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;layer_1_size&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
        <span class="s2">&quot;layer_2_size&quot;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
        <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">64</span>
    <span class="p">}</span>
    <span class="n">train_mnist</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="tuning-the-model-parameters">
<h2>Tuning the model parameters<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#tuning-the-model-parameters" title="Permalink to this headline">#</a></h2>
<p>The parameters above should give you a good accuracy of over 90% already. However,
we might improve on this simply by changing some of the hyperparameters. For instance,
maybe we get an even higher accuracy if we used a larger batch size.</p>
<p>Instead of guessing the parameter values, let’s use Tune to systematically try out
parameter combinations and find the best performing set.</p>
<p>First, we need some additional imports:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytorch_lightning.loggers</span> <span class="kn">import</span> <span class="n">TensorBoardLogger</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">air</span><span class="p">,</span> <span class="n">tune</span>
<span class="kn">from</span> <span class="nn">ray.air</span> <span class="kn">import</span> <span class="n">session</span>
<span class="kn">from</span> <span class="nn">ray.tune</span> <span class="kn">import</span> <span class="n">CLIReporter</span>
<span class="kn">from</span> <span class="nn">ray.tune.schedulers</span> <span class="kn">import</span> <span class="n">ASHAScheduler</span><span class="p">,</span> <span class="n">PopulationBasedTraining</span>
<span class="kn">from</span> <span class="nn">ray.tune.integration.pytorch_lightning</span> <span class="kn">import</span> <span class="n">TuneReportCallback</span><span class="p">,</span> \
    <span class="n">TuneReportCheckpointCallback</span>
</pre></div>
</div>
</div>
</div>
<section id="talking-to-tune-with-a-pytorch-lightning-callback">
<h3>Talking to Tune with a PyTorch Lightning callback<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#talking-to-tune-with-a-pytorch-lightning-callback" title="Permalink to this headline">#</a></h3>
<p>PyTorch Lightning introduced <a class="reference external" href="https://pytorch-lightning.readthedocs.io/en/latest/extensions/callbacks.html">Callbacks</a>
that can be used to plug custom functions into the training loop. This way the original
<code class="docutils literal notranslate"><span class="pre">LightningModule</span></code> does not have to be altered at all. Also, we could use the same
callback for multiple modules.</p>
<p>Ray Tune comes with ready-to-use PyTorch Lightning callbacks. To report metrics
back to Tune after each validation epoch, we will use the <code class="docutils literal notranslate"><span class="pre">TuneReportCallback</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TuneReportCallback</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="s2">&quot;ptl/val_loss&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mean_accuracy&quot;</span><span class="p">:</span> <span class="s2">&quot;ptl/val_accuracy&quot;</span>
    <span class="p">},</span>
    <span class="n">on</span><span class="o">=</span><span class="s2">&quot;validation_end&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ray.tune.integration.pytorch_lightning.TuneReportCallback at 0x17b305710&gt;
</pre></div>
</div>
</div>
</div>
<p>This callback will take the <code class="docutils literal notranslate"><span class="pre">val_loss</span></code> and <code class="docutils literal notranslate"><span class="pre">val_accuracy</span></code> values
from the PyTorch Lightning trainer and report them to Tune as the <code class="docutils literal notranslate"><span class="pre">loss</span></code>
and <code class="docutils literal notranslate"><span class="pre">mean_accuracy</span></code>, respectively.</p>
</section>
<section id="adding-the-tune-training-function">
<h3>Adding the Tune training function<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#adding-the-tune-training-function" title="Permalink to this headline">#</a></h3>
<p>Then we specify our training function. Note that we added the <code class="docutils literal notranslate"><span class="pre">data_dir</span></code> as a
parameter here to avoid
that each training run downloads the full MNIST dataset. Instead, we want to access
a shared data location.</p>
<p>We are also able to specify the number of epochs to train each model, and the number
of GPUs we want to use for training. We also create a TensorBoard logger that writes
logfiles directly into Tune’s root trial directory - if we didn’t do that PyTorch
Lightning would create subdirectories, and each trial would thus be shown twice in
TensorBoard, one time for Tune’s logs, and another time for PyTorch Lightning’s logs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train_mnist_tune</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_gpus</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="s2">&quot;~/data&quot;</span><span class="p">):</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">LightningMNISTClassifier</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">)</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
        <span class="n">max_epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
        <span class="c1"># If fractional GPUs passed in, convert to int.</span>
        <span class="n">gpus</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">num_gpus</span><span class="p">),</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">TensorBoardLogger</span><span class="p">(</span>
            <span class="n">save_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">),</span>
        <span class="n">enable_progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span>
            <span class="n">TuneReportCallback</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="s2">&quot;ptl/val_loss&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;mean_accuracy&quot;</span><span class="p">:</span> <span class="s2">&quot;ptl/val_accuracy&quot;</span>
                <span class="p">},</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;validation_end&quot;</span><span class="p">)</span>
        <span class="p">])</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="configuring-the-search-space">
<h3>Configuring the search space<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#configuring-the-search-space" title="Permalink to this headline">#</a></h3>
<p>Now we configure the parameter search space. We would like to choose between three
different layer and batch sizes. The learning rate should be sampled uniformly between
<code class="docutils literal notranslate"><span class="pre">0.0001</span></code> and <code class="docutils literal notranslate"><span class="pre">0.1</span></code>. The <code class="docutils literal notranslate"><span class="pre">tune.loguniform()</span></code> function is syntactic sugar to make
sampling between these different orders of magnitude easier, specifically
we are able to also sample small values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;layer_1_size&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]),</span>
    <span class="s2">&quot;layer_2_size&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">]),</span>
    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">loguniform</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">),</span>
    <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]),</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="selecting-a-scheduler">
<h3>Selecting a scheduler<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#selecting-a-scheduler" title="Permalink to this headline">#</a></h3>
<p>In this example, we use an <a class="reference external" href="https://blog.ml.cmu.edu/2018/12/12/massively-parallel-hyperparameter-optimization/">Asynchronous Hyperband</a>
scheduler. This scheduler decides at each iteration which trials are likely to perform
badly, and stops these trials. This way we don’t waste any resources on bad hyperparameter
configurations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">scheduler</span> <span class="o">=</span> <span class="n">ASHAScheduler</span><span class="p">(</span>
    <span class="n">max_t</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
    <span class="n">grace_period</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">reduction_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="changing-the-cli-output">
<h3>Changing the CLI output<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#changing-the-cli-output" title="Permalink to this headline">#</a></h3>
<p>We instantiate a <code class="docutils literal notranslate"><span class="pre">CLIReporter</span></code> to specify which metrics we would like to see in our
output tables in the command line. This is optional, but can be used to make sure our
output tables only include information we would like to see.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reporter</span> <span class="o">=</span> <span class="n">CLIReporter</span><span class="p">(</span>
    <span class="n">parameter_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;layer_1_size&quot;</span><span class="p">,</span> <span class="s2">&quot;layer_2_size&quot;</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">,</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">],</span>
    <span class="n">metric_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="s2">&quot;mean_accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;training_iteration&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="passing-constants-to-the-train-function">
<h3>Passing constants to the train function<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#passing-constants-to-the-train-function" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">data_dir</span></code>, <code class="docutils literal notranslate"><span class="pre">num_epochs</span></code> and <code class="docutils literal notranslate"><span class="pre">num_gpus</span></code> we pass to the training function
are constants. To avoid including them as non-configurable parameters in the <code class="docutils literal notranslate"><span class="pre">config</span></code>
specification, we can use <code class="docutils literal notranslate"><span class="pre">tune.with_parameters</span></code> to wrap around the training function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gpus_per_trial</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s2">&quot;~/data&quot;</span>

<span class="n">train_fn_with_parameters</span> <span class="o">=</span> <span class="n">tune</span><span class="o">.</span><span class="n">with_parameters</span><span class="p">(</span><span class="n">train_mnist_tune</span><span class="p">,</span>
                                                <span class="n">num_epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
                                                <span class="n">num_gpus</span><span class="o">=</span><span class="n">gpus_per_trial</span><span class="p">,</span>
                                                <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="training-with-gpus">
<h3>Training with GPUs<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#training-with-gpus" title="Permalink to this headline">#</a></h3>
<p>We can specify how many resources Tune should request for each trial.
This also includes GPUs.</p>
<p>PyTorch Lightning takes care of moving the training to the GPUs. We
already made sure that our code is compatible with that, so there’s
nothing more to do here other than to specify the number of GPUs
we would like to use:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resources_per_trial</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;gpu&quot;</span><span class="p">:</span> <span class="n">gpus_per_trial</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>You can also specify <a class="reference internal" href="../tutorials/tune-resources.html#tune-parallelism"><span class="std std-ref">fractional GPUs for Tune</span></a>,
allowing multiple trials to share GPUs and thus increase concurrency under resource constraints.
While the <code class="docutils literal notranslate"><span class="pre">gpus_per_trial</span></code> passed into
Tune is a decimal value, the <code class="docutils literal notranslate"><span class="pre">gpus</span></code> passed into the <code class="docutils literal notranslate"><span class="pre">pl.Trainer</span></code> should still be an integer.
Please note that if using fractional GPUs, it is the user’s responsibility to
make sure multiple trials can share GPUs and there is enough memory to do so.
Ray does not automatically handle this for you.</p>
<p>If you want to use multiple GPUs per trial, you should check out the
<a class="reference external" href="https://github.com/ray-project/ray_lightning">Ray Lightning Library</a>.
This library makes it easy to run multiple concurrent trials with Ray Tune, with each trial also running
in a distributed fashion using Ray.</p>
</section>
<section id="putting-it-together">
<h3>Putting it together<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#putting-it-together" title="Permalink to this headline">#</a></h3>
<p>Lastly, we need to create a <code class="docutils literal notranslate"><span class="pre">Tuner()</span></code> object and start Ray Tune with <code class="docutils literal notranslate"><span class="pre">tuner.fit()</span></code>.</p>
<p>The full code looks like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tune_mnist_asha</span><span class="p">(</span><span class="n">num_samples</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">gpus_per_trial</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="s2">&quot;~/data&quot;</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;layer_1_size&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]),</span>
        <span class="s2">&quot;layer_2_size&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">]),</span>
        <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">loguniform</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">),</span>
        <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]),</span>
    <span class="p">}</span>

    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">ASHAScheduler</span><span class="p">(</span>
        <span class="n">max_t</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
        <span class="n">grace_period</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">reduction_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">reporter</span> <span class="o">=</span> <span class="n">CLIReporter</span><span class="p">(</span>
        <span class="n">parameter_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;layer_1_size&quot;</span><span class="p">,</span> <span class="s2">&quot;layer_2_size&quot;</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">,</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">],</span>
        <span class="n">metric_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="s2">&quot;mean_accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;training_iteration&quot;</span><span class="p">])</span>

    <span class="n">train_fn_with_parameters</span> <span class="o">=</span> <span class="n">tune</span><span class="o">.</span><span class="n">with_parameters</span><span class="p">(</span><span class="n">train_mnist_tune</span><span class="p">,</span>
                                                    <span class="n">num_epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
                                                    <span class="n">num_gpus</span><span class="o">=</span><span class="n">gpus_per_trial</span><span class="p">,</span>
                                                    <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>
    <span class="n">resources_per_trial</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;gpu&quot;</span><span class="p">:</span> <span class="n">gpus_per_trial</span><span class="p">}</span>
    
    <span class="n">tuner</span> <span class="o">=</span> <span class="n">tune</span><span class="o">.</span><span class="n">Tuner</span><span class="p">(</span>
        <span class="n">tune</span><span class="o">.</span><span class="n">with_resources</span><span class="p">(</span>
            <span class="n">train_fn_with_parameters</span><span class="p">,</span>
            <span class="n">resources</span><span class="o">=</span><span class="n">resources_per_trial</span>
        <span class="p">),</span>
        <span class="n">tune_config</span><span class="o">=</span><span class="n">tune</span><span class="o">.</span><span class="n">TuneConfig</span><span class="p">(</span>
            <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span>
            <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">run_config</span><span class="o">=</span><span class="n">air</span><span class="o">.</span><span class="n">RunConfig</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;tune_mnist_asha&quot;</span><span class="p">,</span>
            <span class="n">progress_reporter</span><span class="o">=</span><span class="n">reporter</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">param_space</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">tuner</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best hyperparameters found were: &quot;</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">get_best_result</span><span class="p">()</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In the example above, Tune runs 10 trials with different hyperparameter configurations.
An example output could look like so:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>  +------------------------------+------------+-------+----------------+----------------+-------------+--------------+----------+-----------------+----------------------+
  <span class="p">|</span> Trial name                   <span class="p">|</span> status     <span class="p">|</span> loc   <span class="p">|</span>   layer_1_size <span class="p">|</span>   layer_2_size <span class="p">|</span>          lr <span class="p">|</span>   batch_size <span class="p">|</span>     loss <span class="p">|</span>   mean_accuracy <span class="p">|</span>   training_iteration <span class="p">|</span>
  <span class="p">|</span>------------------------------+------------+-------+----------------+----------------+-------------+--------------+----------+-----------------+----------------------<span class="p">|</span>
  <span class="p">|</span> train_mnist_tune_63ecc_00000 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span>             <span class="m">64</span> <span class="p">|</span> <span class="m">0</span>.00121197  <span class="p">|</span>          <span class="m">128</span> <span class="p">|</span> <span class="m">0</span>.120173 <span class="p">|</span>       <span class="m">0</span>.972461  <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
  <span class="p">|</span> train_mnist_tune_63ecc_00001 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>             <span class="m">64</span> <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span> <span class="m">0</span>.0301395   <span class="p">|</span>          <span class="m">128</span> <span class="p">|</span> <span class="m">0</span>.454836 <span class="p">|</span>       <span class="m">0</span>.868164  <span class="p">|</span>                    <span class="m">4</span> <span class="p">|</span>
  <span class="p">|</span> train_mnist_tune_63ecc_00002 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>             <span class="m">64</span> <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span> <span class="m">0</span>.0432097   <span class="p">|</span>          <span class="m">128</span> <span class="p">|</span> <span class="m">0</span>.718396 <span class="p">|</span>       <span class="m">0</span>.718359  <span class="p">|</span>                    <span class="m">1</span> <span class="p">|</span>
  <span class="p">|</span> train_mnist_tune_63ecc_00003 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>             <span class="m">32</span> <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span> <span class="m">0</span>.000294669 <span class="p">|</span>           <span class="m">32</span> <span class="p">|</span> <span class="m">0</span>.111475 <span class="p">|</span>       <span class="m">0</span>.965764  <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
  <span class="p">|</span> train_mnist_tune_63ecc_00004 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>             <span class="m">32</span> <span class="p">|</span>            <span class="m">256</span> <span class="p">|</span> <span class="m">0</span>.000386664 <span class="p">|</span>           <span class="m">64</span> <span class="p">|</span> <span class="m">0</span>.133538 <span class="p">|</span>       <span class="m">0</span>.960839  <span class="p">|</span>                    <span class="m">8</span> <span class="p">|</span>
  <span class="p">|</span> train_mnist_tune_63ecc_00005 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span> <span class="m">0</span>.0837395   <span class="p">|</span>           <span class="m">32</span> <span class="p">|</span> <span class="m">2</span>.32628  <span class="p">|</span>       <span class="m">0</span>.0991242 <span class="p">|</span>                    <span class="m">1</span> <span class="p">|</span>
  <span class="p">|</span> train_mnist_tune_63ecc_00006 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>             <span class="m">64</span> <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span> <span class="m">0</span>.000158761 <span class="p">|</span>          <span class="m">128</span> <span class="p">|</span> <span class="m">0</span>.134595 <span class="p">|</span>       <span class="m">0</span>.959766  <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
  <span class="p">|</span> train_mnist_tune_63ecc_00007 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>             <span class="m">64</span> <span class="p">|</span>             <span class="m">64</span> <span class="p">|</span> <span class="m">0</span>.000672126 <span class="p">|</span>           <span class="m">64</span> <span class="p">|</span> <span class="m">0</span>.118182 <span class="p">|</span>       <span class="m">0</span>.972903  <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
<span class="hll">  <span class="p">|</span> train_mnist_tune_63ecc_00008 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span>             <span class="m">64</span> <span class="p">|</span> <span class="m">0</span>.000502428 <span class="p">|</span>           <span class="m">32</span> <span class="p">|</span> <span class="m">0</span>.11082  <span class="p">|</span>       <span class="m">0</span>.975518  <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
</span>  <span class="p">|</span> train_mnist_tune_63ecc_00009 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>             <span class="m">64</span> <span class="p">|</span>            <span class="m">256</span> <span class="p">|</span> <span class="m">0</span>.00112894  <span class="p">|</span>           <span class="m">32</span> <span class="p">|</span> <span class="m">0</span>.13472  <span class="p">|</span>       <span class="m">0</span>.971935  <span class="p">|</span>                    <span class="m">8</span> <span class="p">|</span>
  +------------------------------+------------+-------+----------------+----------------+-------------+--------------+----------+-----------------+----------------------+
</pre></div>
</div>
<p>As you can see in the <code class="docutils literal notranslate"><span class="pre">training_iteration</span></code> column, trials with a high loss
(and low accuracy) have been terminated early. The best performing trial used
<code class="docutils literal notranslate"><span class="pre">layer_1_size=128</span></code>, <code class="docutils literal notranslate"><span class="pre">layer_2_size=64</span></code>, <code class="docutils literal notranslate"><span class="pre">lr=0.000502428</span></code> and
<code class="docutils literal notranslate"><span class="pre">batch_size=32</span></code>.</p>
</section>
</section>
<section id="using-population-based-training-to-find-the-best-parameters">
<h2>Using Population Based Training to find the best parameters<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#using-population-based-training-to-find-the-best-parameters" title="Permalink to this headline">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ASHAScheduler</span></code> terminates those trials early that show bad performance.
Sometimes, this stops trials that would get better after more training steps,
and which might eventually even show better performance than other configurations.</p>
<p>Another popular method for hyperparameter tuning, called
<a class="reference external" href="https://deepmind.com/blog/article/population-based-training-neural-networks">Population Based Training</a>,
instead perturbs hyperparameters during the training run. Tune implements PBT, and
we only need to make some slight adjustments to our code.</p>
<section id="adding-checkpoints-to-the-pytorch-lightning-module">
<h3>Adding checkpoints to the PyTorch Lightning module<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#adding-checkpoints-to-the-pytorch-lightning-module" title="Permalink to this headline">#</a></h3>
<p>First, we need to introduce
another callback to save model checkpoints. Since Tune requires a call to
<code class="docutils literal notranslate"><span class="pre">session.report()</span></code> after creating a new checkpoint to register it, we will use
a combined reporting and checkpointing callback:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TuneReportCheckpointCallback</span><span class="p">(</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="s2">&quot;ptl/val_loss&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mean_accuracy&quot;</span><span class="p">:</span> <span class="s2">&quot;ptl/val_accuracy&quot;</span>
    <span class="p">},</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;checkpoint&quot;</span><span class="p">,</span>
    <span class="n">on</span><span class="o">=</span><span class="s2">&quot;validation_end&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ray.tune.integration.pytorch_lightning.TuneReportCheckpointCallback at 0x17a626090&gt;
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">checkpoint</span></code> value is the name of the checkpoint file within the
checkpoint directory.</p>
<p>We also include checkpoint loading in our training function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train_mnist_tune_checkpoint</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                                <span class="n">checkpoint_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">num_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                <span class="n">num_gpus</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                <span class="n">data_dir</span><span class="o">=</span><span class="s2">&quot;~/data&quot;</span><span class="p">):</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;max_epochs&quot;</span><span class="p">:</span> <span class="n">num_epochs</span><span class="p">,</span>
        <span class="c1"># If fractional GPUs passed in, convert to int.</span>
        <span class="s2">&quot;gpus&quot;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">num_gpus</span><span class="p">),</span>
        <span class="s2">&quot;logger&quot;</span><span class="p">:</span> <span class="n">TensorBoardLogger</span><span class="p">(</span>
            <span class="n">save_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">),</span>
        <span class="s2">&quot;enable_progress_bar&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;callbacks&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">TuneReportCheckpointCallback</span><span class="p">(</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="s2">&quot;ptl/val_loss&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;mean_accuracy&quot;</span><span class="p">:</span> <span class="s2">&quot;ptl/val_accuracy&quot;</span>
                <span class="p">},</span>
                <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;checkpoint&quot;</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;validation_end&quot;</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">checkpoint_dir</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;resume_from_checkpoint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">checkpoint_dir</span><span class="p">,</span> <span class="s2">&quot;checkpoint&quot;</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">LightningMNISTClassifier</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="configuring-and-running-population-based-training">
<h3>Configuring and running Population Based Training<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#configuring-and-running-population-based-training" title="Permalink to this headline">#</a></h3>
<p>We need to call Tune slightly differently:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tune_mnist_pbt</span><span class="p">(</span><span class="n">num_samples</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">gpus_per_trial</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="s2">&quot;~/data&quot;</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;layer_1_size&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]),</span>
        <span class="s2">&quot;layer_2_size&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">]),</span>
        <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">PopulationBasedTraining</span><span class="p">(</span>
        <span class="n">perturbation_interval</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">hyperparam_mutations</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">loguniform</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">),</span>
            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
        <span class="p">})</span>

    <span class="n">reporter</span> <span class="o">=</span> <span class="n">CLIReporter</span><span class="p">(</span>
        <span class="n">parameter_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;layer_1_size&quot;</span><span class="p">,</span> <span class="s2">&quot;layer_2_size&quot;</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">,</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">],</span>
        <span class="n">metric_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="s2">&quot;mean_accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;training_iteration&quot;</span><span class="p">])</span>
    
    <span class="n">tuner</span> <span class="o">=</span> <span class="n">tune</span><span class="o">.</span><span class="n">Tuner</span><span class="p">(</span>
        <span class="n">tune</span><span class="o">.</span><span class="n">with_resources</span><span class="p">(</span>
            <span class="n">tune</span><span class="o">.</span><span class="n">with_parameters</span><span class="p">(</span>
                <span class="n">train_mnist_tune_checkpoint</span><span class="p">,</span>
                <span class="n">num_epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
                <span class="n">num_gpus</span><span class="o">=</span><span class="n">gpus_per_trial</span><span class="p">,</span>
                <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">),</span>
            <span class="n">resources</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;gpu&quot;</span><span class="p">:</span> <span class="n">gpus_per_trial</span>
            <span class="p">}</span>
        <span class="p">),</span>
        <span class="n">tune_config</span><span class="o">=</span><span class="n">tune</span><span class="o">.</span><span class="n">TuneConfig</span><span class="p">(</span>
            <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span>
            <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">run_config</span><span class="o">=</span><span class="n">air</span><span class="o">.</span><span class="n">RunConfig</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;tune_mnist_asha&quot;</span><span class="p">,</span>
            <span class="n">progress_reporter</span><span class="o">=</span><span class="n">reporter</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">param_space</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">tuner</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best hyperparameters found were: &quot;</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">get_best_result</span><span class="p">()</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Instead of passing tune parameters to the <code class="docutils literal notranslate"><span class="pre">config</span></code> dict, we start
with fixed values, though we are also able to sample some of them, like the
layer sizes. Additionally, we have to tell PBT how to perturb the hyperparameters.
Note that the layer sizes are not tuned right here. This is because we cannot simply
change layer sizes during a training run - which is what would happen in PBT.</p>
<p>To test running both of our main scripts (<code class="docutils literal notranslate"><span class="pre">tune_mnist_asha</span></code> and <code class="docutils literal notranslate"><span class="pre">tune_mnist_pbt</span></code>), all you have to do is specify
a <code class="docutils literal notranslate"><span class="pre">data_dir</span></code> folder and run the scripts with reasonable parameters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dir</span> <span class="o">=</span> <span class="s2">&quot;~/data/&quot;</span>

<span class="n">tune_mnist_asha</span><span class="p">(</span><span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">gpus_per_trial</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>
<span class="n">tune_mnist_pbt</span><span class="p">(</span><span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">gpus_per_trial</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>== Status ==
Current time: 2022-07-22 16:24:58 (running for 00:00:00.16)
Memory usage on this node: 11.2/16.0 GiB
Using AsyncHyperBand: num_stopped=0
Bracket: Iter 4.000: None | Iter 2.000: None | Iter 1.000: None
Resources requested: 1.0/16 CPUs, 0/0 GPUs, 0.0/4.72 GiB heap, 0.0/2.0 GiB objects
Result logdir: /Users/kai/ray_results/tune_mnist_asha
Number of trials: 1/1 (1 RUNNING)
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+
| Trial name                   | status   | loc             |   layer_1_size |   layer_2_size |         lr |   batch_size |
|------------------------------+----------+-----------------+----------------+----------------+------------+--------------|
| train_mnist_tune_727f7_00000 | RUNNING  | 127.0.0.1:52355 |            128 |            128 | 0.00165008 |           64 |
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> GPU available: False, used: False
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> TPU available: False, using: 0 TPU cores
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> IPU available: False, using: 0 IPUs
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> HPU available: False, using: 0 HPUs
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> /Users/kai/.pyenv/versions/3.7.7/lib/python3.7/site-packages/pytorch_lightning/trainer/configuration_validator.py:336: LightningDeprecationWarning: The `on_keyboard_interrupt` callback hook was deprecated in v1.5 and will be removed in v1.7. Please use the `on_exception` callback hook instead.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span>   &quot;The `on_keyboard_interrupt` callback hook was deprecated in v1.5 and will be removed in v1.7.&quot;
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> /Users/kai/.pyenv/versions/3.7.7/lib/python3.7/site-packages/pytorch_lightning/trainer/configuration_validator.py:348: LightningDeprecationWarning: The `on_init_start` callback hook was deprecated in v1.6 and will be removed in v1.8.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span>   &quot;The `on_init_start` callback hook was deprecated in v1.6 and will be removed in v1.8.&quot;
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> /Users/kai/.pyenv/versions/3.7.7/lib/python3.7/site-packages/pytorch_lightning/trainer/configuration_validator.py:351: LightningDeprecationWarning: The `on_init_end` callback hook was deprecated in v1.6 and will be removed in v1.8.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span>   rank_zero_deprecation(&quot;The `on_init_end` callback hook was deprecated in v1.6 and will be removed in v1.8.&quot;)
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> /Users/kai/.pyenv/versions/3.7.7/lib/python3.7/site-packages/pytorch_lightning/trainer/configuration_validator.py:377: LightningDeprecationWarning: The `Callback.on_batch_start` hook was deprecated in v1.6 and will be removed in v1.8. Please use `Callback.on_train_batch_start` instead.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span>   f&quot;The `Callback.{hook}` hook was deprecated in v1.6 and&quot;
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> /Users/kai/.pyenv/versions/3.7.7/lib/python3.7/site-packages/pytorch_lightning/trainer/configuration_validator.py:377: LightningDeprecationWarning: The `Callback.on_batch_end` hook was deprecated in v1.6 and will be removed in v1.8. Please use `Callback.on_train_batch_end` instead.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span>   f&quot;The `Callback.{hook}` hook was deprecated in v1.6 and&quot;
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> /Users/kai/.pyenv/versions/3.7.7/lib/python3.7/site-packages/pytorch_lightning/trainer/configuration_validator.py:386: LightningDeprecationWarning: The `Callback.on_epoch_start` hook was deprecated in v1.6 and will be removed in v1.8. Please use `Callback.on_&lt;train/validation/test&gt;_epoch_start` instead.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span>   f&quot;The `Callback.{hook}` hook was deprecated in v1.6 and&quot;
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> /Users/kai/.pyenv/versions/3.7.7/lib/python3.7/site-packages/pytorch_lightning/trainer/configuration_validator.py:386: LightningDeprecationWarning: The `Callback.on_epoch_end` hook was deprecated in v1.6 and will be removed in v1.8. Please use `Callback.on_&lt;train/validation/test&gt;_epoch_end` instead.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span>   f&quot;The `Callback.{hook}` hook was deprecated in v1.6 and&quot;
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> 
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span>   | Name    | Type   | Params
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> -----------------------------------
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> 0 | layer_1 | Linear | 100 K 
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> 1 | layer_2 | Linear | 16.5 K
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> 2 | layer_3 | Linear | 1.3 K 
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> -----------------------------------
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> 118 K     Trainable params
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> 0         Non-trainable params
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> 118 K     Total params
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> 0.473     Total estimated model params size (MB)
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> /Users/kai/.pyenv/versions/3.7.7/lib/python3.7/site-packages/pytorch_lightning/trainer/connectors/data_connector.py:245: PossibleUserWarning: The dataloader, val_dataloader 0, does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` (try 16 which is the number of cpus on this machine) in the `DataLoader` init to improve performance.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span>   category=PossibleUserWarning,
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span> /Users/kai/.pyenv/versions/3.7.7/lib/python3.7/site-packages/pytorch_lightning/trainer/connectors/data_connector.py:245: PossibleUserWarning: The dataloader, train_dataloader, does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` (try 16 which is the number of cpus on this machine) in the `DataLoader` init to improve performance.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(train_mnist_tune pid=52355)</span>   category=PossibleUserWarning,
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>== Status ==
Current time: 2022-07-22 16:25:13 (running for 00:00:15.04)
Memory usage on this node: 11.7/16.0 GiB
Using AsyncHyperBand: num_stopped=0
Bracket: Iter 4.000: None | Iter 2.000: None | Iter 1.000: None
Resources requested: 1.0/16 CPUs, 0/0 GPUs, 0.0/4.72 GiB heap, 0.0/2.0 GiB objects
Result logdir: /Users/kai/ray_results/tune_mnist_asha
Number of trials: 1/1 (1 RUNNING)
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+
| Trial name                   | status   | loc             |   layer_1_size |   layer_2_size |         lr |   batch_size |
|------------------------------+----------+-----------------+----------------+----------------+------------+--------------|
| train_mnist_tune_727f7_00000 | RUNNING  | 127.0.0.1:52355 |            128 |            128 | 0.00165008 |           64 |
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+


== Status ==
Current time: 2022-07-22 16:25:18 (running for 00:00:20.06)
Memory usage on this node: 11.7/16.0 GiB
Using AsyncHyperBand: num_stopped=0
Bracket: Iter 4.000: None | Iter 2.000: None | Iter 1.000: None
Resources requested: 1.0/16 CPUs, 0/0 GPUs, 0.0/4.72 GiB heap, 0.0/2.0 GiB objects
Result logdir: /Users/kai/ray_results/tune_mnist_asha
Number of trials: 1/1 (1 RUNNING)
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+
| Trial name                   | status   | loc             |   layer_1_size |   layer_2_size |         lr |   batch_size |
|------------------------------+----------+-----------------+----------------+----------------+------------+--------------|
| train_mnist_tune_727f7_00000 | RUNNING  | 127.0.0.1:52355 |            128 |            128 | 0.00165008 |           64 |
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+


Result for train_mnist_tune_727f7_00000:
  date: 2022-07-22_16-25-19
  done: false
  experiment_id: d137534eb136478c9e9c4514a538f9da
  hostname: Kais-MacBook-Pro.local
  iterations_since_restore: 1
  loss: 0.12323953211307526
  mean_accuracy: 0.9600474834442139
  node_ip: 127.0.0.1
  pid: 52355
  time_since_restore: 11.140714168548584
  time_this_iter_s: 11.140714168548584
  time_total_s: 11.140714168548584
  timestamp: 1658503519
  timesteps_since_restore: 0
  training_iteration: 1
  trial_id: 727f7_00000
  warmup_time: 0.0038437843322753906
  
== Status ==
Current time: 2022-07-22 16:25:24 (running for 00:00:26.19)
Memory usage on this node: 12.0/16.0 GiB
Using AsyncHyperBand: num_stopped=0
Bracket: Iter 4.000: None | Iter 2.000: None | Iter 1.000: -0.12323953211307526
Resources requested: 1.0/16 CPUs, 0/0 GPUs, 0.0/4.72 GiB heap, 0.0/2.0 GiB objects
Current best trial: 727f7_00000 with loss=0.12323953211307526 and parameters={&#39;layer_1_size&#39;: 128, &#39;layer_2_size&#39;: 128, &#39;lr&#39;: 0.001650077499050015, &#39;batch_size&#39;: 64}
Result logdir: /Users/kai/ray_results/tune_mnist_asha
Number of trials: 1/1 (1 RUNNING)
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+---------+-----------------+----------------------+
| Trial name                   | status   | loc             |   layer_1_size |   layer_2_size |         lr |   batch_size |    loss |   mean_accuracy |   training_iteration |
|------------------------------+----------+-----------------+----------------+----------------+------------+--------------+---------+-----------------+----------------------|
| train_mnist_tune_727f7_00000 | RUNNING  | 127.0.0.1:52355 |            128 |            128 | 0.00165008 |           64 | 0.12324 |        0.960047 |                    1 |
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+---------+-----------------+----------------------+


== Status ==
Current time: 2022-07-22 16:25:29 (running for 00:00:31.21)
Memory usage on this node: 11.9/16.0 GiB
Using AsyncHyperBand: num_stopped=0
Bracket: Iter 4.000: None | Iter 2.000: None | Iter 1.000: -0.12323953211307526
Resources requested: 1.0/16 CPUs, 0/0 GPUs, 0.0/4.72 GiB heap, 0.0/2.0 GiB objects
Current best trial: 727f7_00000 with loss=0.12323953211307526 and parameters={&#39;layer_1_size&#39;: 128, &#39;layer_2_size&#39;: 128, &#39;lr&#39;: 0.001650077499050015, &#39;batch_size&#39;: 64}
Result logdir: /Users/kai/ray_results/tune_mnist_asha
Number of trials: 1/1 (1 RUNNING)
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+---------+-----------------+----------------------+
| Trial name                   | status   | loc             |   layer_1_size |   layer_2_size |         lr |   batch_size |    loss |   mean_accuracy |   training_iteration |
|------------------------------+----------+-----------------+----------------+----------------+------------+--------------+---------+-----------------+----------------------|
| train_mnist_tune_727f7_00000 | RUNNING  | 127.0.0.1:52355 |            128 |            128 | 0.00165008 |           64 | 0.12324 |        0.960047 |                    1 |
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+---------+-----------------+----------------------+


Result for train_mnist_tune_727f7_00000:
  date: 2022-07-22_16-25-31
  done: false
  experiment_id: d137534eb136478c9e9c4514a538f9da
  hostname: Kais-MacBook-Pro.local
  iterations_since_restore: 2
  loss: 0.09032993763685226
  mean_accuracy: 0.9731012582778931
  node_ip: 127.0.0.1
  pid: 52355
  time_since_restore: 22.593159914016724
  time_this_iter_s: 11.45244574546814
  time_total_s: 22.593159914016724
  timestamp: 1658503531
  timesteps_since_restore: 0
  training_iteration: 2
  trial_id: 727f7_00000
  warmup_time: 0.0038437843322753906
  
== Status ==
Current time: 2022-07-22 16:25:36 (running for 00:00:37.64)
Memory usage on this node: 12.1/16.0 GiB
Using AsyncHyperBand: num_stopped=0
Bracket: Iter 4.000: None | Iter 2.000: -0.09032993763685226 | Iter 1.000: -0.12323953211307526
Resources requested: 1.0/16 CPUs, 0/0 GPUs, 0.0/4.72 GiB heap, 0.0/2.0 GiB objects
Current best trial: 727f7_00000 with loss=0.09032993763685226 and parameters={&#39;layer_1_size&#39;: 128, &#39;layer_2_size&#39;: 128, &#39;lr&#39;: 0.001650077499050015, &#39;batch_size&#39;: 64}
Result logdir: /Users/kai/ray_results/tune_mnist_asha
Number of trials: 1/1 (1 RUNNING)
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------+
| Trial name                   | status   | loc             |   layer_1_size |   layer_2_size |         lr |   batch_size |      loss |   mean_accuracy |   training_iteration |
|------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------|
| train_mnist_tune_727f7_00000 | RUNNING  | 127.0.0.1:52355 |            128 |            128 | 0.00165008 |           64 | 0.0903299 |        0.973101 |                    2 |
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------+


== Status ==
Current time: 2022-07-22 16:25:41 (running for 00:00:42.66)
Memory usage on this node: 12.1/16.0 GiB
Using AsyncHyperBand: num_stopped=0
Bracket: Iter 4.000: None | Iter 2.000: -0.09032993763685226 | Iter 1.000: -0.12323953211307526
Resources requested: 1.0/16 CPUs, 0/0 GPUs, 0.0/4.72 GiB heap, 0.0/2.0 GiB objects
Current best trial: 727f7_00000 with loss=0.09032993763685226 and parameters={&#39;layer_1_size&#39;: 128, &#39;layer_2_size&#39;: 128, &#39;lr&#39;: 0.001650077499050015, &#39;batch_size&#39;: 64}
Result logdir: /Users/kai/ray_results/tune_mnist_asha
Number of trials: 1/1 (1 RUNNING)
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------+
| Trial name                   | status   | loc             |   layer_1_size |   layer_2_size |         lr |   batch_size |      loss |   mean_accuracy |   training_iteration |
|------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------|
| train_mnist_tune_727f7_00000 | RUNNING  | 127.0.0.1:52355 |            128 |            128 | 0.00165008 |           64 | 0.0903299 |        0.973101 |                    2 |
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------+


Result for train_mnist_tune_727f7_00000:
  date: 2022-07-22_16-25-42
  done: false
  experiment_id: d137534eb136478c9e9c4514a538f9da
  hostname: Kais-MacBook-Pro.local
  iterations_since_restore: 3
  loss: 0.09614239633083344
  mean_accuracy: 0.9754746556282043
  node_ip: 127.0.0.1
  pid: 52355
  time_since_restore: 33.65132713317871
  time_this_iter_s: 11.058167219161987
  time_total_s: 33.65132713317871
  timestamp: 1658503542
  timesteps_since_restore: 0
  training_iteration: 3
  trial_id: 727f7_00000
  warmup_time: 0.0038437843322753906
  
== Status ==
Current time: 2022-07-22 16:25:47 (running for 00:00:48.70)
Memory usage on this node: 12.1/16.0 GiB
Using AsyncHyperBand: num_stopped=0
Bracket: Iter 4.000: None | Iter 2.000: -0.09032993763685226 | Iter 1.000: -0.12323953211307526
Resources requested: 1.0/16 CPUs, 0/0 GPUs, 0.0/4.72 GiB heap, 0.0/2.0 GiB objects
Current best trial: 727f7_00000 with loss=0.09614239633083344 and parameters={&#39;layer_1_size&#39;: 128, &#39;layer_2_size&#39;: 128, &#39;lr&#39;: 0.001650077499050015, &#39;batch_size&#39;: 64}
Result logdir: /Users/kai/ray_results/tune_mnist_asha
Number of trials: 1/1 (1 RUNNING)
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------+
| Trial name                   | status   | loc             |   layer_1_size |   layer_2_size |         lr |   batch_size |      loss |   mean_accuracy |   training_iteration |
|------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------|
| train_mnist_tune_727f7_00000 | RUNNING  | 127.0.0.1:52355 |            128 |            128 | 0.00165008 |           64 | 0.0961424 |        0.975475 |                    3 |
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------+


== Status ==
Current time: 2022-07-22 16:25:52 (running for 00:00:53.72)
Memory usage on this node: 12.1/16.0 GiB
Using AsyncHyperBand: num_stopped=0
Bracket: Iter 4.000: None | Iter 2.000: -0.09032993763685226 | Iter 1.000: -0.12323953211307526
Resources requested: 1.0/16 CPUs, 0/0 GPUs, 0.0/4.72 GiB heap, 0.0/2.0 GiB objects
Current best trial: 727f7_00000 with loss=0.09614239633083344 and parameters={&#39;layer_1_size&#39;: 128, &#39;layer_2_size&#39;: 128, &#39;lr&#39;: 0.001650077499050015, &#39;batch_size&#39;: 64}
Result logdir: /Users/kai/ray_results/tune_mnist_asha
Number of trials: 1/1 (1 RUNNING)
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------+
| Trial name                   | status   | loc             |   layer_1_size |   layer_2_size |         lr |   batch_size |      loss |   mean_accuracy |   training_iteration |
|------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------|
| train_mnist_tune_727f7_00000 | RUNNING  | 127.0.0.1:52355 |            128 |            128 | 0.00165008 |           64 | 0.0961424 |        0.975475 |                    3 |
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------+


Result for train_mnist_tune_727f7_00000:
  date: 2022-07-22_16-25-53
  done: false
  experiment_id: d137534eb136478c9e9c4514a538f9da
  hostname: Kais-MacBook-Pro.local
  iterations_since_restore: 4
  loss: 0.09530177712440491
  mean_accuracy: 0.9760680198669434
  node_ip: 127.0.0.1
  pid: 52355
  time_since_restore: 44.58630990982056
  time_this_iter_s: 10.934982776641846
  time_total_s: 44.58630990982056
  timestamp: 1658503553
  timesteps_since_restore: 0
  training_iteration: 4
  trial_id: 727f7_00000
  warmup_time: 0.0038437843322753906
  
== Status ==
Current time: 2022-07-22 16:25:58 (running for 00:00:59.63)
Memory usage on this node: 11.9/16.0 GiB
Using AsyncHyperBand: num_stopped=0
Bracket: Iter 4.000: -0.09530177712440491 | Iter 2.000: -0.09032993763685226 | Iter 1.000: -0.12323953211307526
Resources requested: 1.0/16 CPUs, 0/0 GPUs, 0.0/4.72 GiB heap, 0.0/2.0 GiB objects
Current best trial: 727f7_00000 with loss=0.09530177712440491 and parameters={&#39;layer_1_size&#39;: 128, &#39;layer_2_size&#39;: 128, &#39;lr&#39;: 0.001650077499050015, &#39;batch_size&#39;: 64}
Result logdir: /Users/kai/ray_results/tune_mnist_asha
Number of trials: 1/1 (1 RUNNING)
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------+
| Trial name                   | status   | loc             |   layer_1_size |   layer_2_size |         lr |   batch_size |      loss |   mean_accuracy |   training_iteration |
|------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------|
| train_mnist_tune_727f7_00000 | RUNNING  | 127.0.0.1:52355 |            128 |            128 | 0.00165008 |           64 | 0.0953018 |        0.976068 |                    4 |
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------+


== Status ==
Current time: 2022-07-22 16:26:03 (running for 00:01:04.65)
Memory usage on this node: 11.9/16.0 GiB
Using AsyncHyperBand: num_stopped=0
Bracket: Iter 4.000: -0.09530177712440491 | Iter 2.000: -0.09032993763685226 | Iter 1.000: -0.12323953211307526
Resources requested: 1.0/16 CPUs, 0/0 GPUs, 0.0/4.72 GiB heap, 0.0/2.0 GiB objects
Current best trial: 727f7_00000 with loss=0.09530177712440491 and parameters={&#39;layer_1_size&#39;: 128, &#39;layer_2_size&#39;: 128, &#39;lr&#39;: 0.001650077499050015, &#39;batch_size&#39;: 64}
Result logdir: /Users/kai/ray_results/tune_mnist_asha
Number of trials: 1/1 (1 RUNNING)
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------+
| Trial name                   | status   | loc             |   layer_1_size |   layer_2_size |         lr |   batch_size |      loss |   mean_accuracy |   training_iteration |
|------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------|
| train_mnist_tune_727f7_00000 | RUNNING  | 127.0.0.1:52355 |            128 |            128 | 0.00165008 |           64 | 0.0953018 |        0.976068 |                    4 |
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+-----------+-----------------+----------------------+


Result for train_mnist_tune_727f7_00000:
  date: 2022-07-22_16-26-04
  done: false
  experiment_id: d137534eb136478c9e9c4514a538f9da
  hostname: Kais-MacBook-Pro.local
  iterations_since_restore: 5
  loss: 0.10016436874866486
  mean_accuracy: 0.9750791192054749
  node_ip: 127.0.0.1
  pid: 52355
  time_since_restore: 55.61101007461548
  time_this_iter_s: 11.024700164794922
  time_total_s: 55.61101007461548
  timestamp: 1658503564
  timesteps_since_restore: 0
  training_iteration: 5
  trial_id: 727f7_00000
  warmup_time: 0.0038437843322753906
  
== Status ==
Current time: 2022-07-22 16:26:09 (running for 00:01:10.66)
Memory usage on this node: 12.0/16.0 GiB
Using AsyncHyperBand: num_stopped=0
Bracket: Iter 4.000: -0.09530177712440491 | Iter 2.000: -0.09032993763685226 | Iter 1.000: -0.12323953211307526
Resources requested: 1.0/16 CPUs, 0/0 GPUs, 0.0/4.72 GiB heap, 0.0/2.0 GiB objects
Current best trial: 727f7_00000 with loss=0.10016436874866486 and parameters={&#39;layer_1_size&#39;: 128, &#39;layer_2_size&#39;: 128, &#39;lr&#39;: 0.001650077499050015, &#39;batch_size&#39;: 64}
Result logdir: /Users/kai/ray_results/tune_mnist_asha
Number of trials: 1/1 (1 RUNNING)
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+----------+-----------------+----------------------+
| Trial name                   | status   | loc             |   layer_1_size |   layer_2_size |         lr |   batch_size |     loss |   mean_accuracy |   training_iteration |
|------------------------------+----------+-----------------+----------------+----------------+------------+--------------+----------+-----------------+----------------------|
| train_mnist_tune_727f7_00000 | RUNNING  | 127.0.0.1:52355 |            128 |            128 | 0.00165008 |           64 | 0.100164 |        0.975079 |                    5 |
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+----------+-----------------+----------------------+


== Status ==
Current time: 2022-07-22 16:26:14 (running for 00:01:15.67)
Memory usage on this node: 12.0/16.0 GiB
Using AsyncHyperBand: num_stopped=0
Bracket: Iter 4.000: -0.09530177712440491 | Iter 2.000: -0.09032993763685226 | Iter 1.000: -0.12323953211307526
Resources requested: 1.0/16 CPUs, 0/0 GPUs, 0.0/4.72 GiB heap, 0.0/2.0 GiB objects
Current best trial: 727f7_00000 with loss=0.10016436874866486 and parameters={&#39;layer_1_size&#39;: 128, &#39;layer_2_size&#39;: 128, &#39;lr&#39;: 0.001650077499050015, &#39;batch_size&#39;: 64}
Result logdir: /Users/kai/ray_results/tune_mnist_asha
Number of trials: 1/1 (1 RUNNING)
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+----------+-----------------+----------------------+
| Trial name                   | status   | loc             |   layer_1_size |   layer_2_size |         lr |   batch_size |     loss |   mean_accuracy |   training_iteration |
|------------------------------+----------+-----------------+----------------+----------------+------------+--------------+----------+-----------------+----------------------|
| train_mnist_tune_727f7_00000 | RUNNING  | 127.0.0.1:52355 |            128 |            128 | 0.00165008 |           64 | 0.100164 |        0.975079 |                    5 |
+------------------------------+----------+-----------------+----------------+----------------+------------+--------------+----------+-----------------+----------------------+
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-07-22 16:26:15,433	INFO tune.py:738 -- Total run time: 76.74 seconds (76.61 seconds for the tuning loop).
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Result for train_mnist_tune_727f7_00000:
  date: 2022-07-22_16-26-15
  done: true
  experiment_id: d137534eb136478c9e9c4514a538f9da
  hostname: Kais-MacBook-Pro.local
  iterations_since_restore: 6
  loss: 0.10947871953248978
  mean_accuracy: 0.9756724834442139
  node_ip: 127.0.0.1
  pid: 52355
  time_since_restore: 66.58598804473877
  time_this_iter_s: 10.974977970123291
  time_total_s: 66.58598804473877
  timestamp: 1658503575
  timesteps_since_restore: 0
  training_iteration: 6
  trial_id: 727f7_00000
  warmup_time: 0.0038437843322753906
  
== Status ==
Current time: 2022-07-22 16:26:15 (running for 00:01:16.62)
Memory usage on this node: 12.1/16.0 GiB
Using AsyncHyperBand: num_stopped=1
Bracket: Iter 4.000: -0.09530177712440491 | Iter 2.000: -0.09032993763685226 | Iter 1.000: -0.12323953211307526
Resources requested: 0/16 CPUs, 0/0 GPUs, 0.0/4.72 GiB heap, 0.0/2.0 GiB objects
Current best trial: 727f7_00000 with loss=0.10947871953248978 and parameters={&#39;layer_1_size&#39;: 128, &#39;layer_2_size&#39;: 128, &#39;lr&#39;: 0.001650077499050015, &#39;batch_size&#39;: 64}
Result logdir: /Users/kai/ray_results/tune_mnist_asha
Number of trials: 1/1 (1 TERMINATED)
+------------------------------+------------+-----------------+----------------+----------------+------------+--------------+----------+-----------------+----------------------+
| Trial name                   | status     | loc             |   layer_1_size |   layer_2_size |         lr |   batch_size |     loss |   mean_accuracy |   training_iteration |
|------------------------------+------------+-----------------+----------------+----------------+------------+--------------+----------+-----------------+----------------------|
| train_mnist_tune_727f7_00000 | TERMINATED | 127.0.0.1:52355 |            128 |            128 | 0.00165008 |           64 | 0.109479 |        0.975672 |                    6 |
+------------------------------+------------+-----------------+----------------+----------------+------------+--------------+----------+-----------------+----------------------+


Best hyperparameters found were:  {&#39;layer_1_size&#39;: 128, &#39;layer_2_size&#39;: 128, &#39;lr&#39;: 0.001650077499050015, &#39;batch_size&#39;: 64}
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">b2</span><span class="o">/</span><span class="mi">0_91</span><span class="n">bd757rz02lrmr920v0gw0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_52122</span><span class="o">/</span><span class="mf">1146224506.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> 
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tune_mnist_asha</span><span class="p">(</span><span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">gpus_per_trial</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">4</span> <span class="n">tune_mnist_pbt</span><span class="p">(</span><span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">gpus_per_trial</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>

<span class="nn">/var/folders/b2/0_91bd757rz02lrmr920v0gw0000gn/T/ipykernel_52122/328169407.py</span> in <span class="ni">tune_mnist_pbt</span><span class="nt">(num_samples, num_epochs, gpus_per_trial, data_dir)</span>
<span class="g g-Whitespace">     </span><span class="mi">38</span>         <span class="n">run_config</span><span class="o">=</span><span class="n">air</span><span class="o">.</span><span class="n">RunConfig</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">39</span>             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;tune_mnist_asha&quot;</span><span class="p">,</span>
<span class="ne">---&gt; </span><span class="mi">40</span>             <span class="n">tune_mnist_pbt</span><span class="o">=</span><span class="n">reporter</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">41</span>         <span class="p">),</span>
<span class="g g-Whitespace">     </span><span class="mi">42</span>         <span class="n">param_space</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>

<span class="ne">TypeError</span>: __init__() got an unexpected keyword argument &#39;tune_mnist_pbt&#39;
</pre></div>
</div>
</div>
</div>
<p>If you have more resources available (e.g. a GPU), you can modify the above parameters accordingly.</p>
<p>An example output of a run could look like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>+-----------------------------------------+------------+-------+----------------+----------------+-----------+--------------+-----------+-----------------+----------------------+
<span class="p">|</span> Trial name                              <span class="p">|</span> status     <span class="p">|</span> loc   <span class="p">|</span>   layer_1_size <span class="p">|</span>   layer_2_size <span class="p">|</span>        lr <span class="p">|</span>   batch_size <span class="p">|</span>      loss <span class="p">|</span>   mean_accuracy <span class="p">|</span>   training_iteration <span class="p">|</span>
<span class="p">|</span>-----------------------------------------+------------+-------+----------------+----------------+-----------+--------------+-----------+-----------------+----------------------<span class="p">|</span>
<span class="p">|</span> train_mnist_tune_checkpoint_85489_00000 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span> <span class="m">0</span>.001     <span class="p">|</span>           <span class="m">64</span> <span class="p">|</span> <span class="m">0</span>.108734  <span class="p">|</span>        <span class="m">0</span>.973101 <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
<span class="p">|</span> train_mnist_tune_checkpoint_85489_00001 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span> <span class="m">0</span>.001     <span class="p">|</span>           <span class="m">64</span> <span class="p">|</span> <span class="m">0</span>.093577  <span class="p">|</span>        <span class="m">0</span>.978639 <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
<span class="p">|</span> train_mnist_tune_checkpoint_85489_00002 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span>            <span class="m">256</span> <span class="p">|</span> <span class="m">0</span>.0008    <span class="p">|</span>           <span class="m">32</span> <span class="p">|</span> <span class="m">0</span>.0922348 <span class="p">|</span>        <span class="m">0</span>.979299 <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
<span class="p">|</span> train_mnist_tune_checkpoint_85489_00003 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>             <span class="m">64</span> <span class="p">|</span>            <span class="m">256</span> <span class="p">|</span> <span class="m">0</span>.001     <span class="p">|</span>           <span class="m">64</span> <span class="p">|</span> <span class="m">0</span>.124648  <span class="p">|</span>        <span class="m">0</span>.973892 <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
<span class="p">|</span> train_mnist_tune_checkpoint_85489_00004 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span>             <span class="m">64</span> <span class="p">|</span> <span class="m">0</span>.001     <span class="p">|</span>           <span class="m">64</span> <span class="p">|</span> <span class="m">0</span>.101717  <span class="p">|</span>        <span class="m">0</span>.975079 <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
<span class="p">|</span> train_mnist_tune_checkpoint_85489_00005 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>             <span class="m">64</span> <span class="p">|</span>             <span class="m">64</span> <span class="p">|</span> <span class="m">0</span>.001     <span class="p">|</span>           <span class="m">64</span> <span class="p">|</span> <span class="m">0</span>.121467  <span class="p">|</span>        <span class="m">0</span>.969146 <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
<span class="p">|</span> train_mnist_tune_checkpoint_85489_00006 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span>            <span class="m">256</span> <span class="p">|</span> <span class="m">0</span>.00064   <span class="p">|</span>           <span class="m">32</span> <span class="p">|</span> <span class="m">0</span>.053446  <span class="p">|</span>        <span class="m">0</span>.987062 <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
<span class="p">|</span> train_mnist_tune_checkpoint_85489_00007 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>            <span class="m">128</span> <span class="p">|</span>            <span class="m">256</span> <span class="p">|</span> <span class="m">0</span>.001     <span class="p">|</span>           <span class="m">64</span> <span class="p">|</span> <span class="m">0</span>.129804  <span class="p">|</span>        <span class="m">0</span>.973497 <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
<span class="p">|</span> train_mnist_tune_checkpoint_85489_00008 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>             <span class="m">64</span> <span class="p">|</span>            <span class="m">256</span> <span class="p">|</span> <span class="m">0</span>.0285125 <span class="p">|</span>          <span class="m">128</span> <span class="p">|</span> <span class="m">0</span>.363236  <span class="p">|</span>        <span class="m">0</span>.913867 <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
<span class="p">|</span> train_mnist_tune_checkpoint_85489_00009 <span class="p">|</span> TERMINATED <span class="p">|</span>       <span class="p">|</span>             <span class="m">32</span> <span class="p">|</span>            <span class="m">256</span> <span class="p">|</span> <span class="m">0</span>.001     <span class="p">|</span>           <span class="m">64</span> <span class="p">|</span> <span class="m">0</span>.150946  <span class="p">|</span>        <span class="m">0</span>.964201 <span class="p">|</span>                   <span class="m">10</span> <span class="p">|</span>
+-----------------------------------------+------------+-------+----------------+----------------+-----------+--------------+-----------+-----------------+----------------------+
</pre></div>
</div>
<p>As you can see, each sample ran the full number of 10 iterations.
All trials ended with quite good parameter combinations and showed relatively good performances.
In some runs, the parameters have been perturbed. And the best configuration even reached a
mean validation accuracy of <code class="docutils literal notranslate"><span class="pre">0.987062</span></code>!</p>
<p>In summary, PyTorch Lightning Modules are easy to extend to use with Tune. It just took
us importing one or two callbacks and a small wrapper function to get great performing
parameter configurations.</p>
</section>
</section>
<section id="more-pytorch-lightning-examples">
<h2>More PyTorch Lightning Examples<a class="headerlink" href="tune-vanilla-pytorch-lightning.html#more-pytorch-lightning-examples" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="includes/mnist_ptl_mini.html"><span class="doc">MNIST PyTorch Lightning Example</span></a>:
A minimal example of using <a class="reference external" href="https://github.com/PyTorchLightning/pytorch-lightning">Pytorch Lightning</a>
to train a MNIST model. This example utilizes the Ray Tune-provided
<a class="reference internal" href="../api/integration.html#tune-integration-pytorch-lightning"><span class="std std-ref">PyTorch Lightning callbacks</span></a>.
See also <a class="reference internal" href="tune-pytorch-lightning.html#tune-pytorch-lightning-ref"><span class="std std-ref">this tutorial for a full walkthrough</span></a>.</p></li>
<li><p><a class="reference internal" href="tune-pytorch-lightning.html#tune-pytorch-lightning-ref"><span class="std std-ref">A walkthrough tutorial for using Ray Tune with Pytorch-Lightning</span></a>.</p></li>
<li><p><a class="reference internal" href="includes/mlflow_ptl_example.html"><span class="doc">MLflow PyTorch Lightning Example</span></a>: Example for using <a class="reference external" href="https://github.com/mlflow/mlflow/">MLflow</a>
and <a class="reference external" href="https://github.com/PyTorchLightning/pytorch-lightning">Pytorch Lightning</a> with Ray Tune.</p></li>
</ul>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The Ray Team<br/>
  
      &copy; Copyright 2023, The Ray Team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js@digest=1999514e3f237ded88cf"></script>


  </body>
</html>