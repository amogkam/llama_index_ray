
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ray.tune.execution.ray_trial_executor &#8212; Ray 3.0.0.dev0</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css@digest=1999514e3f237ded88cf.css" rel="stylesheet">
<link href="../../../../_static/styles/pydata-sphinx-theme.css@digest=1999514e3f237ded88cf.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../../_static/styles/sphinx-book-theme.css@digest=5115cc725059bd94278eecd172e13a965bf8f5a9.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/termynal.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_/static/css/badge_only.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js@digest=1999514e3f237ded88cf">

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/js/versionwarning.js"></script>
    <script src="../../../../_static/togglebutton.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script defer="defer" src="../../../../_static/js/docsearch.js"></script>
    <script src="../../../../_static/js/rate-the-docs.es.min.js"></script>
    <script defer="defer" src="../../../../_static/js/termynal.js"></script>
    <script defer="defer" src="../../../../_static/js/custom.js"></script>
    <script defer="defer" src="../../../../_static/js/top-navigation.js"></script>
    <script src="../../../../_static/js/tags.js"></script>
    <script src="../../../../_static/tabs.js"></script>
    <script src="../../../../_static/scripts/sphinx-book-theme.js@digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../../_static/design-tabs.js"></script>
    <script async="async" src="../../../../../../_/static/javascript/readthedocs-doc-embed.js"></script>
    <link rel="canonical" href="https://docs.ray.io/en/latest/_modules/ray/tune/execution/ray_trial_executor.html" />
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://deer.ray.io/script.js" data-site="WYYANYOS" defer></script>
<!-- / Fathom -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110413294-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110413294-1');
</script>

<script
  src="https://widget.kapa.ai/kapa-widget.bundle.js"
  data-website-id="18a8c339-4ec5-43c8-8182-db3f2bc8c6b6"
  data-project-name="Ray"
  data-project-color="#2C2C2C"
  data-project-logo="https://global.discourse-cdn.com/business7/uploads/ray/original/1X/8f4dcb72f7cd34e2a332d548bd65860994bc8ff1.png"
></script>

<script>
(function(apiKey){
    (function(p,e,n,d,o){var v,w,x,y,z;o=p[d]=p[d]||{};o._q=o._q||[];
    v=['initialize','identify','updateOptions','pageLoad','track'];for(w=0,x=v.length;w<x;++w)(function(m){
        o[m]=o[m]||function(){o._q[m===v[0]?'unshift':'push']([m].concat([].slice.call(arguments,0)));};})(v[w]);
        y=e.createElement(n);y.async=!0;y.src='https://cdn.pendo.io/agent/static/'+apiKey+'/pendo.js';
        z=e.getElementsByTagName(n)[0];z.parentNode.insertBefore(y,z);})(window,document,'script','pendo');

        pendo.initialize({
            visitor: {
                id: 'VISITOR-UNIQUE-ID'
            },
            account: {
                id: 'ACCOUNT-UNIQUE-ID'
            }
        });
})('f89fa48a-6dd7-4d7c-67cf-a8051ed891f2');
</script>



  
<!-- RTD Extra Head -->

<link rel="stylesheet" href="../../../../../../_/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="application/json" id="READTHEDOCS_DATA">{"ad_free": true, "api_host": "https://readthedocs.org", "builder": "sphinx", "canonical_url": null, "docroot": "/doc/source/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-1", "language": "en", "page": "_modules/ray/tune/execution/ray_trial_executor", "programming_language": "py", "project": "ray", "proxied_api_host": "/_", "source_suffix": ".rst", "subprojects": {}, "theme": "sphinx_book_theme", "user_analytics_code": "", "version": "master"}</script>

<!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
-->
<script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script>

<script type="text/javascript" src="../../../../../../_/static/javascript/readthedocs-analytics.js" async="async"></script>

<!-- end RTD <extrahead> -->
</head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"><div class='topnav'></div></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ray 3.0.0.dev0</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main Navigation">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../../index.html">
                    Welcome to Ray!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ray
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../ray-overview/index.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../ray-overview/getting-started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../ray-more-libs/installation.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../ray-overview/use-cases.html">
   Use Cases
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../ray-overview/examples.html">
   Example Gallery
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../ray-overview/ray-libraries.html">
   Ecosystem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../ray-core/walkthrough.html">
   Ray Core
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../ray-air/getting-started.html">
   Ray AI Runtime (AIR)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../data/data.html">
   Ray Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../train/train.html">
   Ray Train
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../tune.html">
   Ray Tune
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../serve/index.html">
   Ray Serve
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../rllib/index.html">
   Ray RLlib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../ray-more-libs/index.html">
   More Libraries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../ray-core/cluster/index.html">
   Ray Clusters
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../ray-observability/index.html">
   Monitoring and Debugging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../ray-references/api.html">
   References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../ray-contribute/stability.html">
   Developer Guides
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ray-project/ray"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/issues/new?title=Issue%20on%20page%20%2F_modules/ray/tune/execution/ray_trial_executor.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <h1>Source code for ray.tune.execution.ray_trial_executor</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">ray.actor</span> <span class="kn">import</span> <span class="n">ActorHandle</span>
<span class="kn">from</span> <span class="nn">ray.air</span> <span class="kn">import</span> <span class="n">Checkpoint</span><span class="p">,</span> <span class="n">AcquiredResources</span>
<span class="kn">from</span> <span class="nn">ray.air._internal.checkpoint_manager</span> <span class="kn">import</span> <span class="n">CheckpointStorage</span><span class="p">,</span> <span class="n">_TrackedCheckpoint</span>
<span class="kn">from</span> <span class="nn">ray.air.constants</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">COPY_DIRECTORY_CHECKPOINTS_INSTEAD_OF_MOVING_ENV</span><span class="p">,</span>
    <span class="n">DISABLE_LAZY_CHECKPOINTING_ENV</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ray.air.execution</span> <span class="kn">import</span> <span class="n">ResourceManager</span>
<span class="kn">from</span> <span class="nn">ray.air.execution.resources.placement_group</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PlacementGroupResourceManager</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ray.exceptions</span> <span class="kn">import</span> <span class="n">GetTimeoutError</span><span class="p">,</span> <span class="n">RayTaskError</span>
<span class="kn">from</span> <span class="nn">ray.tune.error</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TuneError</span><span class="p">,</span>
    <span class="n">_AbortTrialExecution</span><span class="p">,</span>
    <span class="n">_TuneNoNextExecutorEventError</span><span class="p">,</span>
    <span class="n">_TuneStartTrialError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ray.tune.result</span> <span class="kn">import</span> <span class="n">STDERR_FILE</span><span class="p">,</span> <span class="n">STDOUT_FILE</span><span class="p">,</span> <span class="n">TRIAL_INFO</span>
<span class="kn">from</span> <span class="nn">ray.tune.experiment.trial</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Trial</span><span class="p">,</span>
    <span class="n">_Location</span><span class="p">,</span>
    <span class="n">_TrialInfo</span><span class="p">,</span>
    <span class="n">_change_working_directory</span><span class="p">,</span>
    <span class="n">_get_trainable_kwargs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ray.tune.utils</span> <span class="kn">import</span> <span class="n">warn_if_slow</span>
<span class="kn">from</span> <span class="nn">ray.tune.utils.object_cache</span> <span class="kn">import</span> <span class="n">_ObjectCache</span>
<span class="kn">from</span> <span class="nn">ray.tune.utils.resource_updater</span> <span class="kn">import</span> <span class="n">_ResourceUpdater</span>
<span class="kn">from</span> <span class="nn">ray.tune.trainable.util</span> <span class="kn">import</span> <span class="n">TrainableUtil</span>
<span class="kn">from</span> <span class="nn">ray.util</span> <span class="kn">import</span> <span class="n">log_once</span>
<span class="kn">from</span> <span class="nn">ray.util.annotations</span> <span class="kn">import</span> <span class="n">DeveloperAPI</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">DEFAULT_GET_TIMEOUT</span> <span class="o">=</span> <span class="mf">60.0</span>  <span class="c1"># seconds</span>

<span class="n">DEFAULT_ENV_VARS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># https://github.com/ray-project/ray/issues/28197</span>
    <span class="s2">&quot;PL_DISABLE_FORK&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
<span class="p">}</span>
<span class="n">ENV_VARS_TO_PROPAGATE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">DISABLE_LAZY_CHECKPOINTING_ENV</span><span class="p">,</span>
    <span class="n">COPY_DIRECTORY_CHECKPOINTS_INSTEAD_OF_MOVING_ENV</span><span class="p">,</span>
    <span class="s2">&quot;TUNE_CHECKPOINT_CLOUD_RETRY_NUM&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TUNE_CHECKPOINT_CLOUD_RETRY_WAIT_TIME_S&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AWS_ACCESS_KEY_ID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AWS_SECURITY_TOKEN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AWS_SESSION_TOKEN&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">_ActorClassCache</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Caches actor classes.</span>

<span class="sd">    ray.remote is a registration call. It sends the serialized object to the</span>
<span class="sd">    key value store (redis), and will be fetched at an arbitrary worker</span>
<span class="sd">    later. Registration does not use any Ray scheduling resources.</span>

<span class="sd">    Later, class.remote() actually creates the remote actor. The</span>
<span class="sd">    actor will be instantiated on some arbitrary machine,</span>
<span class="sd">    according to the underlying Ray scheduler.</span>

<span class="sd">    Without this cache, you would register the same serialized object</span>
<span class="sd">    over and over again. Naturally, since redis doesnâ€™t spill to disk,</span>
<span class="sd">    this can easily nuke the redis instance (and basically blow up Ray).</span>
<span class="sd">    This cache instead allows us to register once and only once.</span>

<span class="sd">    Note that we assume there can be multiple trainables in the</span>
<span class="sd">    system at once.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainable_cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the wrapped trainable_cls, otherwise calls ray.remote.&quot;&quot;&quot;</span>
        <span class="n">env_vars</span> <span class="o">=</span> <span class="n">DEFAULT_ENV_VARS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">env_var_to_propagate</span> <span class="ow">in</span> <span class="n">ENV_VARS_TO_PROPAGATE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">env_var_to_propagate</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="n">env_vars</span><span class="p">[</span><span class="n">env_var_to_propagate</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">env_var_to_propagate</span><span class="p">]</span>

        <span class="n">runtime_env</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;env_vars&quot;</span><span class="p">:</span> <span class="n">env_vars</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">trainable_cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="n">remote_cls</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">runtime_env</span><span class="o">=</span><span class="n">runtime_env</span><span class="p">)(</span><span class="n">trainable_cls</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">trainable_cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">remote_cls</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">trainable_cls</span><span class="p">]</span>


<span class="n">_class_cache</span> <span class="o">=</span> <span class="n">_ActorClassCache</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_LocalWrapper</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">unwrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the wrapped result.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span>


<span class="k">class</span> <span class="nc">_TrialCleanup</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Responsible for triggering force cleanup of remote actors,</span>
<span class="sd">    without waiting for `Trainable.stop()` to finish.</span>

<span class="sd">    Only instantiated when `TUNE_FORCE_TRIAL_CLEANUP_S` is set up.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_cleanup</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">force_cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_force_cleanup</span> <span class="o">=</span> <span class="n">force_cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_future_to_insert_time</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_future_to_insert_time</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">future</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">get_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the next future that is eligible to be cleaned up forcibly.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_future_to_insert_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_future_to_insert_time</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force_cleanup</span> <span class="o">&lt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">future</span><span class="p">,</span> <span class="n">_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future_to_insert_time</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">future</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_future_to_insert_time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>


<span class="k">class</span> <span class="nc">_ExecutorEventType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The executor event type.</span>

<span class="sd">    Some of the events are internal events to executor while others</span>
<span class="sd">    are handled by runner.&quot;&quot;&quot;</span>

    <span class="n">NO_RUNNING_TRIAL_TIMEOUT</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">PG_READY</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">TRAINING_RESULT</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">SAVING_RESULT</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">RESTORING_RESULT</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">STOP_RESULT</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Internally to executor only.</span>
    <span class="n">YIELD</span> <span class="o">=</span> <span class="mi">7</span>  <span class="c1"># Yielding back to TrialRunner&#39;s main event loop.</span>


<span class="k">class</span> <span class="nc">_ExecutorEvent</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A struct that describes the event to be processed by TrialRunner.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        result: A dict with keys of &quot;future_result&quot; and &quot;exception&quot;.</span>
<span class="sd">            &quot;future_result&quot; is the corresponding result when future returns</span>
<span class="sd">            successfully.</span>
<span class="sd">            &quot;exception&quot; is the exception as caught during ``ray.get(future)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">KEY_FUTURE_RESULT</span> <span class="o">=</span> <span class="s2">&quot;future_result&quot;</span>
    <span class="n">KEY_EXCEPTION</span> <span class="o">=</span> <span class="s2">&quot;exception&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">event_type</span><span class="p">:</span> <span class="n">_ExecutorEventType</span><span class="p">,</span>
        <span class="n">trial</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Trial</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">event_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trial</span> <span class="o">=</span> <span class="n">trial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">] for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trial</span><span class="si">}</span><span class="s2">&quot;</span>


<div class="viewcode-block" id="RayTrialExecutor"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor">[docs]</a><span class="nd">@DeveloperAPI</span>
<span class="k">class</span> <span class="nc">RayTrialExecutor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;An implementation of TrialExecutor based on Ray.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">resource_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ResourceManager</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reuse_actors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">result_buffer_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">refresh_period</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">chdir_to_trial_dir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Trial metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_trial_state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trials_to_cache</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># future --&gt; (type, trial/pg)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Cache futures that are ready to reduce the number times we iterate through</span>
        <span class="c1"># all futures (and e.g. shuffle them)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_ready_futures</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Cleanup</span>
        <span class="n">force_trial_cleanup</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TUNE_FORCE_TRIAL_CLEANUP_S&quot;</span><span class="p">,</span> <span class="s2">&quot;600&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_next_event_wait</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TUNE_GET_EXECUTOR_EVENT_WAIT_S&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">force_trial_cleanup</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trial_cleanup</span> <span class="o">=</span> <span class="n">_TrialCleanup</span><span class="p">(</span><span class="n">force_trial_cleanup</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trial_cleanup</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># For printing used resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_updater</span> <span class="o">=</span> <span class="n">_ResourceUpdater</span><span class="p">(</span><span class="n">refresh_period</span><span class="p">)</span>

        <span class="c1"># Resource management.</span>
        <span class="c1"># For details, see docstring of `_stage_and_update_status()`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_staged_actors</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span> <span class="o">=</span> <span class="n">resource_manager</span> <span class="ow">or</span> <span class="n">PlacementGroupResourceManager</span><span class="p">()</span>

        <span class="c1"># Actor re-use.</span>
        <span class="c1"># For details, see docstring of `_maybe_cache_trial_actor()`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reuse_actors</span> <span class="o">=</span> <span class="n">reuse_actors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_actor_cache</span> <span class="o">=</span> <span class="n">_ObjectCache</span><span class="p">(</span><span class="n">may_keep_one</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Trials for which we requested resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Staged trials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trial_to_acquired_resources</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Trial</span><span class="p">,</span> <span class="n">AcquiredResources</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Result buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_length</span> <span class="o">=</span> <span class="n">result_buffer_length</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TUNE_RESULT_BUFFER_LENGTH&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_min_time_s</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TUNE_RESULT_BUFFER_MIN_TIME_S&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_max_time_s</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TUNE_RESULT_BUFFER_MAX_TIME_S&quot;</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Default kwargs to pass to trainable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trainable_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Trial dir behavior</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chdir_to_trial_dir</span> <span class="o">=</span> <span class="n">chdir_to_trial_dir</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">max_pending_trials</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">trainable_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actor_cache</span><span class="o">.</span><span class="n">num_cached_objects</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Cannot update maximum number of queued actors for reuse &quot;</span>
                <span class="s2">&quot;during a run.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_staged_actors</span> <span class="o">=</span> <span class="n">max_pending_trials</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_trainable_kwargs</span> <span class="o">=</span> <span class="n">trainable_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

<div class="viewcode-block" id="RayTrialExecutor.set_status"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.set_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sets status and checkpoints metadata if needed.</span>

<span class="sd">        Only checkpoints metadata if trial status is a terminal condition.</span>
<span class="sd">        PENDING, PAUSED, and RUNNING switches have checkpoints taken care of</span>
<span class="sd">        in the TrialRunner.</span>

<span class="sd">        Args:</span>
<span class="sd">            trial: Trial to checkpoint.</span>
<span class="sd">            status: Status to set trial to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">trial</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">status</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trial </span><span class="si">%s</span><span class="s2">: Status </span><span class="si">%s</span><span class="s2"> unchanged.&quot;</span><span class="p">,</span> <span class="n">trial</span><span class="p">,</span> <span class="n">trial</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Trial </span><span class="si">%s</span><span class="s2">: Changing status from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">trial</span><span class="p">,</span> <span class="n">trial</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span>
            <span class="p">)</span>
        <span class="n">trial</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Trial</span><span class="o">.</span><span class="n">TERMINATED</span><span class="p">,</span> <span class="n">Trial</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trials_to_cache</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">mark_trial_to_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trials_to_cache</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>

<div class="viewcode-block" id="RayTrialExecutor.get_checkpoints"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.get_checkpoints">[docs]</a>    <span class="k">def</span> <span class="nf">get_checkpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns a copy of mapping of the trial ID to pickled metadata.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trials_to_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_trial_state</span><span class="p">[</span><span class="n">trial</span><span class="o">.</span><span class="n">trial_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">get_json_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trials_to_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_trial_state</span></div>

    <span class="k">def</span> <span class="nf">_stage_and_update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trials</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Trial</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Check and update statuses of scheduled placement groups.</span>

<span class="sd">        Stages placement groups of all trials.</span>

<span class="sd">        We will never request resources for more than `_max_staged_actors` at the same</span>
<span class="sd">        time. This does not include running actors.</span>

<span class="sd">        Thus, if max_staged_actors=4 and e.g. 8 trials can run at the same time,</span>
<span class="sd">        we will occupy resources for up to 8 actors and have requests pending</span>
<span class="sd">        for 4 more.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="n">trials</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_staged_actors</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">trial</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Trial</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">Trial</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">trial</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">resource_request</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">placement_group_factory</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_actor_cache</span><span class="o">.</span><span class="n">increase_max</span><span class="p">(</span><span class="n">resource_request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">request_resources</span><span class="p">(</span><span class="n">resource_request</span><span class="o">=</span><span class="n">resource_request</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">update_state</span><span class="p">()</span>

<div class="viewcode-block" id="RayTrialExecutor.get_ready_trial"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.get_ready_trial">[docs]</a>    <span class="k">def</span> <span class="nf">get_ready_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Trial</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get a trial whose resources are ready and that thus can be started.</span>

<span class="sd">        Can also return None if no trial is available.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Trial object or None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span><span class="p">:</span>
            <span class="n">resource_request</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">placement_group_factory</span>
            <span class="c1"># If we have a cached actor for these resources, return</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actor_cache</span><span class="o">.</span><span class="n">has_cached_object</span><span class="p">(</span><span class="n">resource_request</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">trial</span>

            <span class="c1"># If the resources are available from the resource manager, return</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">has_resources_ready</span><span class="p">(</span>
                <span class="n">resource_request</span><span class="o">=</span><span class="n">resource_request</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">trial</span>

        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_maybe_use_cached_actor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">,</span> <span class="n">logger_creator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ActorHandle</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reuse_actors</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">resource_request</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">placement_group_factory</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actor_cache</span><span class="o">.</span><span class="n">has_cached_object</span><span class="p">(</span><span class="n">resource_request</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">actor</span><span class="p">,</span> <span class="n">acquired_resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actor_cache</span><span class="o">.</span><span class="n">pop_cached_object</span><span class="p">(</span>
            <span class="n">resource_request</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trial </span><span class="si">{</span><span class="n">trial</span><span class="si">}</span><span class="s2">: Reusing cached actor </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">trial</span><span class="o">.</span><span class="n">set_runner</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_trial</span><span class="p">(</span>
            <span class="n">trial</span><span class="p">,</span> <span class="n">trial</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">trial</span><span class="o">.</span><span class="n">experiment_tag</span><span class="p">,</span> <span class="n">logger_creator</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">_AbortTrialExecution</span><span class="p">(</span>
                <span class="s2">&quot;Trainable runner reuse requires reset_config() to be &quot;</span>
                <span class="s2">&quot;implemented and return True.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_trial_to_acquired_resources</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span> <span class="o">=</span> <span class="n">acquired_resources</span>

        <span class="c1"># We are reusing an existing actor (and its resources),</span>
        <span class="c1"># so we need to cancel the resource request that we originally scheduled</span>
        <span class="c1"># for this trial.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">cancel_resource_request</span><span class="p">(</span><span class="n">resource_request</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">actor</span>

    <span class="k">def</span> <span class="nf">_setup_remote_runner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">):</span>
        <span class="c1"># We checkpoint metadata here to try mitigating logdir duplication</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trials_to_cache</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>

        <span class="n">trainable_kwargs</span> <span class="o">=</span> <span class="n">_get_trainable_kwargs</span><span class="p">(</span>
            <span class="n">trial</span><span class="p">,</span>
            <span class="n">additional_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trainable_kwargs</span><span class="p">,</span>
            <span class="n">should_chdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chdir_to_trial_dir</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger_creator</span> <span class="o">=</span> <span class="n">trainable_kwargs</span><span class="p">[</span><span class="s2">&quot;logger_creator&quot;</span><span class="p">]</span>

        <span class="n">existing_runner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_use_cached_actor</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">logger_creator</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing_runner</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">existing_runner</span>

        <span class="n">trainable_cls</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">get_trainable_cls</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trainable_cls</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_AbortTrialExecution</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid trainable: </span><span class="si">{</span><span class="n">trial</span><span class="o">.</span><span class="n">trainable_name</span><span class="si">}</span><span class="s2">. If you passed &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;a string, make sure the trainable was registered before.&quot;</span>
            <span class="p">)</span>
        <span class="n">_actor_cls</span> <span class="o">=</span> <span class="n">_class_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">trainable_cls</span><span class="p">)</span>

        <span class="n">resource_request</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">placement_group_factory</span>
        <span class="n">acquired_resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">acquire_resources</span><span class="p">(</span>
            <span class="n">resource_request</span><span class="o">=</span><span class="n">resource_request</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">acquired_resources</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_trial_to_acquired_resources</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span> <span class="o">=</span> <span class="n">acquired_resources</span>

        <span class="p">[</span><span class="n">full_actor_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">acquired_resources</span><span class="o">.</span><span class="n">annotate_remote_entities</span><span class="p">([</span><span class="n">_actor_cls</span><span class="p">])</span>

        <span class="c1"># Clear the Trial&#39;s location (to be updated later on result)</span>
        <span class="c1"># since we don&#39;t know where the remote runner is placed.</span>
        <span class="n">trial</span><span class="o">.</span><span class="n">set_location</span><span class="p">(</span><span class="n">_Location</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trial </span><span class="si">%s</span><span class="s2">: Setting up new remote runner.&quot;</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">_change_working_directory</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">full_actor_class</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="o">**</span><span class="n">trainable_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start one iteration of training and save remote id.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_future</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Trial </span><span class="si">{}</span><span class="s2"> already has a queued future. Skipping this &quot;</span>
                <span class="s2">&quot;`train` call. This may occur if a trial has &quot;</span>
                <span class="s2">&quot;been unpaused within a scheduler callback.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">trial</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">assert</span> <span class="n">trial</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Trial</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span> <span class="n">trial</span><span class="o">.</span><span class="n">status</span>
        <span class="n">buffer_time_s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_min_time_s</span><span class="p">,</span>
            <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer_max_time_s</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">_change_working_directory</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
            <span class="n">buffer_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_length</span>
            <span class="k">if</span> <span class="n">buffer_length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">trial</span><span class="o">.</span><span class="n">checkpoint_at_end</span><span class="p">:</span>
                <span class="c1"># If a trial checkpoint can be triggered externally,</span>
                <span class="c1"># it is not safe to buffer results.</span>
                <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;trial_executor_buffer_checkpoint&quot;</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Disabling buffered training as you passed &quot;</span>
                        <span class="s2">&quot;`checkpoint_at_end` to `air.CheckpointConfig()`.&quot;</span>
                    <span class="p">)</span>
                <span class="n">buffer_length</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">buffer_length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trial</span><span class="o">.</span><span class="n">checkpoint_freq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">buffer_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">buffer_length</span><span class="p">,</span> <span class="n">trial</span><span class="o">.</span><span class="n">checkpoint_freq</span><span class="p">)</span>
                <span class="n">remote</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">train_buffered</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span>
                    <span class="n">buffer_time_s</span><span class="p">,</span> <span class="n">buffer_length</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remote</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>

        <span class="c1"># Local Mode</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">remote</span> <span class="o">=</span> <span class="n">_LocalWrapper</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="p">[</span><span class="n">remote</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">TRAINING_RESULT</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
        <span class="n">trial_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_future</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">trial_item</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">trial_item</span>

    <span class="k">def</span> <span class="nf">_start_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Starts trial and restores last result if trial was paused.</span>

<span class="sd">        Args:</span>
<span class="sd">            trial: The trial to start.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if trial was started successfully, False otherwise.</span>

<span class="sd">        See `RayTrialExecutor.restore` for possible errors raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">Trial</span><span class="o">.</span><span class="n">PENDING</span><span class="p">)</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_remote_runner</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">runner</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">trial</span><span class="o">.</span><span class="n">set_runner</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">Trial</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_unstage_trial_with_resources</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">trial</span><span class="o">.</span><span class="n">is_restoring</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_train</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_unstage_trial_with_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">):</span>
        <span class="c1"># Case 1: The trial we started was staged. Just remove it</span>
        <span class="k">if</span> <span class="n">trial</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_actor_cache</span><span class="o">.</span><span class="n">decrease_max</span><span class="p">(</span><span class="n">trial</span><span class="o">.</span><span class="n">placement_group_factory</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Case 2: We staged a trial &quot;A&quot; with the same resources, but our trial &quot;B&quot;</span>
        <span class="c1"># was selected by the scheduler to run. The resource manager does not care</span>
        <span class="c1"># about &quot;trials&quot;, it just cares about resources being available. Thus we</span>
        <span class="c1"># look for a staged trial with the same resource requirements and remove it</span>

        <span class="n">resource_request</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">placement_group_factory</span>
        <span class="c1"># Remove staged trial with same resource requirements</span>
        <span class="n">candidate_trial</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">staged_trial</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span><span class="p">:</span>
            <span class="n">staged_resources</span> <span class="o">=</span> <span class="n">staged_trial</span><span class="o">.</span><span class="n">placement_group_factory</span>
            <span class="k">if</span> <span class="n">staged_resources</span> <span class="o">==</span> <span class="n">resource_request</span><span class="p">:</span>
                <span class="n">candidate_trial</span> <span class="o">=</span> <span class="n">staged_trial</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">candidate_trial</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">candidate_trial</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_actor_cache</span><span class="o">.</span><span class="n">decrease_max</span><span class="p">(</span><span class="n">candidate_trial</span><span class="o">.</span><span class="n">placement_group_factory</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Started a trial with resources requested by a different trial, but &quot;</span>
            <span class="s2">&quot;this trial was lost. This is an error in Ray Tune&#39;s execution &quot;</span>
            <span class="s2">&quot;logic. Please raise a GitHub issue at &quot;</span>
            <span class="s2">&quot;https://github.com/ray-project/ray/issues&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_maybe_cache_trial_actor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cache trial actor for reuse, if needed.</span>

<span class="sd">        We will only cache as many actors as are needed to fulfill any pending</span>
<span class="sd">        resource requests for actors with the same resource requirements.</span>
<span class="sd">        E.g. if we have 6 running trials and 4 additional staged actors, we will only</span>
<span class="sd">        cache up to 4 of the running trial actors when they finish.</span>

<span class="sd">        One exception is the case when we have no cached actors, yet. In that case,</span>
<span class="sd">        we will always cache the actor in this method.</span>

<span class="sd">        Later, in `_cleanup_cached_actors`, we will check again if we need this cached</span>
<span class="sd">        actor. That method will keep the actor if we don&#39;t have any staged trials,</span>
<span class="sd">        because we don&#39;t know at that point if the next trial might require the same</span>
<span class="sd">        resources. But because there is no staged trial, it is safe to keep the actor</span>
<span class="sd">        around, as it won&#39;t occupy resources needed by another trial until it&#39;s staged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reuse_actors</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">acquired_resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trial_to_acquired_resources</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span>
        <span class="n">cached_resource_request</span> <span class="o">=</span> <span class="n">acquired_resources</span><span class="o">.</span><span class="n">resource_request</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actor_cache</span><span class="o">.</span><span class="n">cache_object</span><span class="p">(</span>
            <span class="n">cached_resource_request</span><span class="p">,</span> <span class="p">(</span><span class="n">trial</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span> <span class="n">acquired_resources</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not cache actor of trial </span><span class="si">{</span><span class="n">trial</span><span class="si">}</span><span class="s2"> for &quot;</span>
                <span class="s2">&quot;reuse, as there are no pending trials &quot;</span>
                <span class="s2">&quot;requiring its resources.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Caching actor of trial </span><span class="si">{</span><span class="n">trial</span><span class="si">}</span><span class="s2"> for re-use&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_trial_to_acquired_resources</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>

        <span class="n">trial</span><span class="o">.</span><span class="n">set_runner</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_stop_trial</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">,</span>
        <span class="n">error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">exc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">TuneError</span><span class="p">,</span> <span class="n">RayTaskError</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stops this trial.</span>

<span class="sd">        Stops this trial, releasing all allocating resources. If stopping the</span>
<span class="sd">        trial fails, the run will be marked as terminated in error, but no</span>
<span class="sd">        exception will be thrown.</span>

<span class="sd">        Args:</span>
<span class="sd">            error: Whether to mark this trial as terminated in error.</span>
<span class="sd">            exc: Optional exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">Trial</span><span class="o">.</span><span class="n">ERROR</span> <span class="k">if</span> <span class="n">error</span> <span class="ow">or</span> <span class="n">exc</span> <span class="k">else</span> <span class="n">Trial</span><span class="o">.</span><span class="n">TERMINATED</span><span class="p">)</span>
        <span class="n">trial</span><span class="o">.</span><span class="n">set_location</span><span class="p">(</span><span class="n">_Location</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="s2">&quot;runner&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">trial</span><span class="o">.</span><span class="n">runner</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">trial</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_cache_trial_actor</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
            <span class="c1"># Trial runner has been cached</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trial </span><span class="si">%s</span><span class="s2">: Destroying actor.&quot;</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">_change_working_directory</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
                <span class="n">future</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>

            <span class="n">acquired_resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trial_to_acquired_resources</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="p">[</span><span class="n">future</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">STOP_RESULT</span><span class="p">,</span>
                <span class="n">acquired_resources</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trial_cleanup</span><span class="p">:</span>  <span class="c1"># force trial cleanup within a deadline</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_trial_cleanup</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Trial </span><span class="si">%s</span><span class="s2">: Error stopping runner.&quot;</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">Trial</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">trial</span><span class="o">.</span><span class="n">set_runner</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="RayTrialExecutor.start_trial"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.start_trial">[docs]</a>    <span class="k">def</span> <span class="nf">start_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Starts the trial.</span>

<span class="sd">        Will not return resources if trial repeatedly fails on start.</span>

<span class="sd">        Args:</span>
<span class="sd">            trial: Trial to be started.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the remote runner has been started. False if trial was</span>
<span class="sd">                not started (e.g. because of lacking resources/pending PG).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_trial</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">_AbortTrialExecution</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Trial </span><span class="si">%s</span><span class="s2">: Error starting runner, aborting!&quot;</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_trial</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Trial </span><span class="si">%s</span><span class="s2">: Unexpected error starting runner.&quot;</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">TuneError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stop_trial</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stop_trial</span><span class="p">(</span>
                    <span class="n">trial</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="n">_TuneStartTrialError</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="p">)</span>
            <span class="c1"># Note that we don&#39;t return the resources, since they may</span>
            <span class="c1"># have been lost. TODO(ujvl): is this the right thing to do?</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">_find_future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">rid</span> <span class="k">for</span> <span class="n">rid</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="n">trial</span><span class="p">]</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="p">),</span> <span class="s2">&quot;Expecting one future for any given trial at any given time.&quot;</span>
        <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="RayTrialExecutor.stop_trial"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.stop_trial">[docs]</a>    <span class="k">def</span> <span class="nf">stop_trial</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">,</span>
        <span class="n">error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">exc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">TuneError</span><span class="p">,</span> <span class="n">RayTaskError</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Stops the trial, releasing held resources and removing futures related to</span>
<span class="sd">        this trial from the execution queue.</span>

<span class="sd">        Args:</span>
<span class="sd">            trial: Trial to stop.</span>
<span class="sd">            error: Whether to mark this trial as terminated in error. The trial status</span>
<span class="sd">                will be set to either `Trial.ERROR` or `Trial.TERMINATED` based on this.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            exc: Optional exception to log (as a reason for stopping). Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prior_status</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">status</span>
        <span class="k">if</span> <span class="n">prior_status</span> <span class="o">==</span> <span class="n">Trial</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trial </span><span class="si">%s</span><span class="s2">: Returning resources.&quot;</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_future</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">result_id</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">result_id</span><span class="p">)</span>
        <span class="n">trial</span><span class="o">.</span><span class="n">saving_to</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">trial</span><span class="o">.</span><span class="n">restoring_from</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_trial</span><span class="p">(</span>
            <span class="n">trial</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="n">error</span> <span class="ow">or</span> <span class="n">exc</span><span class="p">,</span>
            <span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="RayTrialExecutor.continue_training"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.continue_training">[docs]</a>    <span class="k">def</span> <span class="nf">continue_training</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Continues the training of this trial.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span></div>

<div class="viewcode-block" id="RayTrialExecutor.pause_trial"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.pause_trial">[docs]</a>    <span class="k">def</span> <span class="nf">pause_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">,</span> <span class="n">should_checkpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Pauses the trial, releasing resources (specifically GPUs)</span>

<span class="sd">        We do this by:</span>
<span class="sd">        1. Checkpoint the trial (if `should_checkpoint`) in memory to allow us to resume</span>
<span class="sd">        from this state in the future. We may not always  want to checkpoint, if we</span>
<span class="sd">        know that the checkpoint will not be used.</span>
<span class="sd">        2. Stop the trial and release resources, see `RayTrialExecutor.stop_trial` above</span>
<span class="sd">        3. Set the trial status to `Trial.PAUSED`, which is similar to</span>
<span class="sd">        `Trial.TERMINATED`, except we have the intention of resuming the trial.</span>

<span class="sd">        Args:</span>
<span class="sd">            trial: Trial to pause.</span>
<span class="sd">            should_checkpoint: Whether to save an in-memory checkpoint before stopping.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">trial</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Trial</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span> <span class="n">trial</span><span class="o">.</span><span class="n">status</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">should_checkpoint</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">CheckpointStorage</span><span class="o">.</span><span class="n">MEMORY</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_trial</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">Trial</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error pausing runner.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">Trial</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span></div>

<div class="viewcode-block" id="RayTrialExecutor.reset_trial"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.reset_trial">[docs]</a>    <span class="k">def</span> <span class="nf">reset_trial</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">,</span>
        <span class="n">new_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">new_experiment_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">logger_creator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">],</span> <span class="s2">&quot;ray.tune.Logger&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tries to invoke `Trainable.reset()` to reset trial.</span>

<span class="sd">        Args:</span>
<span class="sd">            trial: Trial to be reset.</span>
<span class="sd">            new_config: New configuration for Trial trainable.</span>
<span class="sd">            new_experiment_tag: New experiment name for trial.</span>
<span class="sd">            logger_creator: Function that instantiates a logger on the</span>
<span class="sd">                actor process.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if `reset_config` is successful else False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trial</span><span class="o">.</span><span class="n">set_experiment_tag</span><span class="p">(</span><span class="n">new_experiment_tag</span><span class="p">)</span>
        <span class="n">trial</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">new_config</span><span class="p">)</span>
        <span class="n">trainable</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">runner</span>

        <span class="c1"># Pass magic variables</span>
        <span class="n">extra_config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_config</span><span class="p">)</span>
        <span class="n">extra_config</span><span class="p">[</span><span class="n">TRIAL_INFO</span><span class="p">]</span> <span class="o">=</span> <span class="n">_TrialInfo</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>

        <span class="n">stdout_file</span><span class="p">,</span> <span class="n">stderr_file</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">log_to_file</span>
        <span class="n">extra_config</span><span class="p">[</span><span class="n">STDOUT_FILE</span><span class="p">]</span> <span class="o">=</span> <span class="n">stdout_file</span>
        <span class="n">extra_config</span><span class="p">[</span><span class="n">STDERR_FILE</span><span class="p">]</span> <span class="o">=</span> <span class="n">stderr_file</span>

        <span class="k">with</span> <span class="n">_change_working_directory</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">warn_if_slow</span><span class="p">(</span><span class="s2">&quot;reset&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">reset_val</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">trainable</span><span class="o">.</span><span class="n">reset</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span>
                            <span class="n">extra_config</span><span class="p">,</span>
                            <span class="n">logger_creator</span><span class="o">=</span><span class="n">logger_creator</span><span class="p">,</span>
                            <span class="n">remote_checkpoint_dir</span><span class="o">=</span><span class="n">trial</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_GET_TIMEOUT</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">GetTimeoutError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Trial </span><span class="si">%s</span><span class="s2">: reset timed out.&quot;</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">reset_val</span></div>

<div class="viewcode-block" id="RayTrialExecutor.has_resources_for_trial"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.has_resources_for_trial">[docs]</a>    <span class="k">def</span> <span class="nf">has_resources_for_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns whether there are resources available for this trial.</span>

<span class="sd">        This will return True as long as we didn&#39;t reach the maximum number</span>
<span class="sd">        of pending trials. It will also return True if the trial placement</span>
<span class="sd">        group is already staged.</span>

<span class="sd">        Args:</span>
<span class="sd">            trial: Trial object which should be scheduled.</span>

<span class="sd">        Returns:</span>
<span class="sd">            boolean</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resource_request</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">placement_group_factory</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">trial</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actor_cache</span><span class="o">.</span><span class="n">has_cached_object</span><span class="p">(</span><span class="n">resource_request</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_staged_actors</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">has_resources_ready</span><span class="p">(</span><span class="n">resource_request</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_allocated_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">total_resources</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;CPU&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;GPU&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">allocated_resource</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trial_to_acquired_resources</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">resource_request</span> <span class="o">=</span> <span class="n">allocated_resource</span><span class="o">.</span><span class="n">resource_request</span>
            <span class="k">for</span> <span class="n">bundle_resources</span> <span class="ow">in</span> <span class="n">resource_request</span><span class="o">.</span><span class="n">bundles</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">bundle_resources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">total_resources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">total_resources</span>

<div class="viewcode-block" id="RayTrialExecutor.debug_string"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.debug_string">[docs]</a>    <span class="k">def</span> <span class="nf">debug_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns a human readable message for printing to the console.&quot;&quot;&quot;</span>
        <span class="n">allocated_resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocated_resources</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_updater</span><span class="o">.</span><span class="n">debug_string</span><span class="p">(</span><span class="n">allocated_resources</span><span class="p">)</span></div>

<div class="viewcode-block" id="RayTrialExecutor.on_step_begin"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.on_step_begin">[docs]</a>    <span class="k">def</span> <span class="nf">on_step_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Before step() is called, update the available resources.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_updater</span><span class="o">.</span><span class="n">update_avail_resources</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">on_step_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_ended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_cached_actors</span><span class="p">(</span><span class="n">search_ended</span><span class="o">=</span><span class="n">search_ended</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_force_trial_cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_cleanup_cached_actors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">search_ended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">force_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clean up unneeded cached actors.</span>

<span class="sd">        Ray Tune caches actors for re-use to avoid initialization overhead. This is</span>
<span class="sd">        useful in two situations: a) to avoid scheduling overhead of actors when</span>
<span class="sd">        trials run for a short time (e.g. &lt; 1 second), and b) to avoid setup overhead</span>
<span class="sd">        when trials initialize a heavy environment/dependencies (e.g. rllib).</span>

<span class="sd">        Actors are cached when a trial is stopped. However, at that point in time</span>
<span class="sd">        we don&#39;t always know if we will need the actor later or not. E.g. if all</span>
<span class="sd">        subsequent trials have different resource requirements, we wouldn&#39;t need to</span>
<span class="sd">        cache the actor.</span>

<span class="sd">        Tune will generate a new trial in the next iteration of step(). Only once</span>
<span class="sd">        this new trial is generated can we know if we will actually use the cached</span>
<span class="sd">        actor soon. This is especially the case when we only run one trial at the time</span>
<span class="sd">        and don&#39;t allow more pending trials: At the point of caching there would be</span>
<span class="sd">        _no_ pending trial, so we would never cache the actor.</span>

<span class="sd">        To circumvent this problem, we always cache an actor once the trial is</span>
<span class="sd">        gracefully stopped (and when `reuse_actors=True`). We only remove this</span>
<span class="sd">        cached actor once we have at least one new staged trial, so that we know</span>
<span class="sd">        if we need to keep the actor or not. So if we create a new trial in the next</span>
<span class="sd">        iteration, we can either reuse the cached actor (if resources match) or</span>
<span class="sd">        remove it (if resources don&#39;t match and the cached actor is thus not required).</span>

<span class="sd">        This method fetches the required resources for all pending trials and the</span>
<span class="sd">        resources for all cached actors. If we cached more actors than we need, we</span>
<span class="sd">        terminate the excess actors and free the resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_all</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">search_ended</span><span class="p">:</span>
            <span class="c1"># If we don&#39;t have any staged trials, keep cached actors,</span>
            <span class="c1"># unless cleanup is forced or no new trials are going to be generated</span>
            <span class="c1"># (if the search ended).</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">search_ended</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actor_cache</span><span class="o">.</span><span class="n">total_max_objects</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="c1"># If there are no more trials coming in, no trials are pending execution,</span>
            <span class="c1"># and we don&#39;t explicitly want to cache objects, we can evict the full</span>
            <span class="c1"># cache.</span>
            <span class="n">force_all</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">actor</span><span class="p">,</span> <span class="n">acquired_resources</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actor_cache</span><span class="o">.</span><span class="n">flush_cached_objects</span><span class="p">(</span>
            <span class="n">force_all</span><span class="o">=</span><span class="n">force_all</span>
        <span class="p">):</span>
            <span class="n">future</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="p">[</span><span class="n">future</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">STOP_RESULT</span><span class="p">,</span>
                <span class="n">acquired_resources</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trial_cleanup</span><span class="p">:</span>  <span class="c1"># force trial cleanup within a deadline</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_trial_cleanup</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resolve_stop_event</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">future</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">,</span>
        <span class="n">acquired_resources</span><span class="p">:</span> <span class="n">AcquiredResources</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resolve stopping future (Trainable.cleanup() and free resources.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Let&#39;s check one more time if the future resolved. If not,</span>
            <span class="c1"># we remove the PG which will terminate the actor.</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">GetTimeoutError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;tune_trial_cleanup_timeout&quot;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Timed out when trying to stop the Ray actor gracefully. &quot;</span>
                    <span class="s2">&quot;Consider making `stop` a faster operation.&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;tune_trial_cleanup_exception&quot;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;An exception occurred when trying to stop the Ray actor:&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">free_resources</span><span class="p">(</span><span class="n">acquired_resources</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_do_force_trial_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trial_cleanup</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">next_future_to_clean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trial_cleanup</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">next_future_to_clean</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">next_future_to_clean</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="p">:</span>
                    <span class="n">event_type</span><span class="p">,</span> <span class="n">acquired_resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                        <span class="n">next_future_to_clean</span>
                    <span class="p">)</span>

                    <span class="k">assert</span> <span class="n">event_type</span> <span class="o">==</span> <span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">STOP_RESULT</span>

                    <span class="c1"># Clean this future</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_stop_event</span><span class="p">(</span>
                        <span class="n">next_future_to_clean</span><span class="p">,</span> <span class="n">acquired_resources</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.01</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># This just means that before the deadline reaches,</span>
                    <span class="c1"># the future is already cleaned up.</span>
                    <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">force_reconcilation_on_next_step_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">update_state</span><span class="p">()</span>

<div class="viewcode-block" id="RayTrialExecutor.save"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">,</span>
        <span class="n">storage</span><span class="p">:</span> <span class="n">CheckpointStorage</span> <span class="o">=</span> <span class="n">CheckpointStorage</span><span class="o">.</span><span class="n">PERSISTENT</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_TrackedCheckpoint</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Saves the trial&#39;s state to a checkpoint asynchronously.</span>

<span class="sd">        Args:</span>
<span class="sd">            trial: The trial to be saved.</span>
<span class="sd">            storage: Where to store the checkpoint. Defaults to</span>
<span class="sd">                PERSISTENT.</span>
<span class="sd">            result: The state of this trial as a dictionary to be saved.</span>
<span class="sd">                If result is None, the trial&#39;s last result will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">             Checkpoint object, or None if an Exception occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;saving trial </span><span class="si">{</span><span class="n">trial</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="ow">or</span> <span class="n">trial</span><span class="o">.</span><span class="n">last_result</span>
        <span class="k">with</span> <span class="n">_change_working_directory</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">storage</span> <span class="o">==</span> <span class="n">CheckpointStorage</span><span class="o">.</span><span class="n">MEMORY</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">save_to_object</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
                <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">_TrackedCheckpoint</span><span class="p">(</span>
                    <span class="n">dir_or_data</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">storage_mode</span><span class="o">=</span><span class="n">storage</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">result</span>
                <span class="p">)</span>
                <span class="n">trial</span><span class="o">.</span><span class="n">on_checkpoint</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
                <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">_TrackedCheckpoint</span><span class="p">(</span>
                    <span class="n">dir_or_data</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">storage_mode</span><span class="o">=</span><span class="n">storage</span><span class="p">,</span>
                    <span class="n">metrics</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">trial</span><span class="o">.</span><span class="n">saving_to</span> <span class="o">=</span> <span class="n">checkpoint</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">SAVING_RESULT</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">checkpoint</span></div>

<div class="viewcode-block" id="RayTrialExecutor.restore"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.restore">[docs]</a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Restores training state from a given model checkpoint.</span>

<span class="sd">        Args:</span>
<span class="sd">            trial: The trial to be restored.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: This error is raised if no runner is found.</span>
<span class="sd">            AbortTrialExecution: This error is raised if the trial is</span>
<span class="sd">                ineligible for restoration, given the Tune input arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">checkpoint</span>
        <span class="k">if</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">dir_or_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">trial</span><span class="o">.</span><span class="n">runner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Trial </span><span class="si">{}</span><span class="s2">: Unable to restore - no runner found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">dir_or_data</span>
        <span class="n">node_ip</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">node_ip</span>
        <span class="k">if</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">storage_mode</span> <span class="o">==</span> <span class="n">CheckpointStorage</span><span class="o">.</span><span class="n">MEMORY</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trial </span><span class="si">%s</span><span class="s2">: Attempting restore from object&quot;</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
            <span class="c1"># Note that we don&#39;t store the remote since in-memory checkpoints</span>
            <span class="c1"># don&#39;t guarantee fault tolerance and don&#39;t need to be waited on.</span>
            <span class="k">with</span> <span class="n">_change_working_directory</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
                <span class="n">trial</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">restore_from_object</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trial </span><span class="si">%s</span><span class="s2">: Attempting restore from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">trial</span><span class="p">,</span> <span class="n">checkpoint_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">trial</span><span class="o">.</span><span class="n">uses_cloud_checkpointing</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="n">trial</span><span class="o">.</span><span class="n">sync_on_checkpoint</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># If using cloud checkpointing, trial will get cp from cloud.</span>
                <span class="c1"># If not syncing to driver, assume it has access to the cp</span>
                <span class="c1"># on the local fs.</span>
                <span class="n">fallback_to_latest</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TUNE_FALLBACK_TO_LATEST_CHECKPOINT&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
                <span class="p">)</span>

                <span class="k">with</span> <span class="n">_change_working_directory</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
                    <span class="n">remote</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">restore</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span>
                        <span class="n">checkpoint_dir</span><span class="p">,</span>
                        <span class="n">checkpoint_node_ip</span><span class="o">=</span><span class="n">node_ip</span><span class="p">,</span>
                        <span class="n">fallback_to_latest</span><span class="o">=</span><span class="n">fallback_to_latest</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">elif</span> <span class="n">trial</span><span class="o">.</span><span class="n">sync_on_checkpoint</span><span class="p">:</span>
                <span class="c1"># This provides FT backwards compatibility in the</span>
                <span class="c1"># case where no cloud checkpoints are provided.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trial </span><span class="si">%s</span><span class="s2">: Reading checkpoint into memory&quot;</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
                <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">TrainableUtil</span><span class="o">.</span><span class="n">find_checkpoint_dir</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">Checkpoint</span><span class="o">.</span><span class="n">from_directory</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">_change_working_directory</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
                    <span class="n">remote</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">restore_from_object</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_AbortTrialExecution</span><span class="p">(</span>
                    <span class="s2">&quot;Pass in `sync_on_checkpoint=True` for driver-based trial&quot;</span>
                    <span class="s2">&quot;restoration. Pass in an `upload_dir` for remote &quot;</span>
                    <span class="s2">&quot;storage-based restoration&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="p">[</span><span class="n">remote</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">RESTORING_RESULT</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
            <span class="n">trial</span><span class="o">.</span><span class="n">restoring_from</span> <span class="o">=</span> <span class="n">checkpoint</span></div>

<div class="viewcode-block" id="RayTrialExecutor.export_trial_if_needed"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.export_trial_if_needed">[docs]</a>    <span class="k">def</span> <span class="nf">export_trial_if_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Exports model of this trial based on trial.export_formats.</span>

<span class="sd">        Return:</span>
<span class="sd">            A dict that maps ExportFormats to successfully exported models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">trial</span><span class="o">.</span><span class="n">export_formats</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">trial</span><span class="o">.</span><span class="n">export_formats</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">_change_working_directory</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">trial</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">export_model</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">trial</span><span class="o">.</span><span class="n">export_formats</span><span class="p">),</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_GET_TIMEOUT</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span></div>

    <span class="k">def</span> <span class="nf">has_gpus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_updater</span><span class="o">.</span><span class="n">get_num_gpus</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_cached_actors</span><span class="p">(</span><span class="n">force_all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trial_cleanup</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trial_cleanup</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="k">break</span>

            <span class="c1"># Non-blocking trial cleanup futures</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_force_trial_cleanup</span><span class="p">()</span>

            <span class="c1"># Deal with other futures</span>
            <span class="n">ready</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ready</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">event_type</span><span class="p">,</span> <span class="n">acquired_resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ready</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># It could be STOP future after all, if so, deal with it here.</span>
            <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">STOP_RESULT</span><span class="p">:</span>
                <span class="c1"># Blocking here is ok as the future returned</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_stop_event</span><span class="p">(</span><span class="n">ready</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">acquired_resources</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">staged_trial</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span><span class="p">:</span>
            <span class="n">resource_request</span> <span class="o">=</span> <span class="n">staged_trial</span><span class="o">.</span><span class="n">placement_group_factory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">cancel_resource_request</span><span class="p">(</span>
                <span class="n">resource_request</span><span class="o">=</span><span class="n">resource_request</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<div class="viewcode-block" id="RayTrialExecutor.get_next_executor_event"><a class="viewcode-back" href="../../../../tune/api/internals.html#ray.tune.execution.ray_trial_executor.RayTrialExecutor.get_next_executor_event">[docs]</a>    <span class="k">def</span> <span class="nf">get_next_executor_event</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">live_trials</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Trial</span><span class="p">],</span> <span class="n">next_trial_exists</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_ExecutorEvent</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the next executor event to be processed in TrialRunner.</span>

<span class="sd">        In case there are multiple events available for handling, the next</span>
<span class="sd">        event is determined by the following priority:</span>
<span class="sd">        1. if there is `next_trial_exists`, and if there is cached resources</span>
<span class="sd">        to use, PG_READY is emitted.</span>
<span class="sd">        2. if there is `next_trial_exists` and there is no cached resources</span>
<span class="sd">        to use, wait on pg future and randomized other futures. If multiple</span>
<span class="sd">        futures are ready, pg future will take priority to be handled first.</span>
<span class="sd">        3. if there is no `next_trial_exists`, wait on just randomized other</span>
<span class="sd">        futures.</span>

<span class="sd">        An example of #3 would be synchronous hyperband. Although there are pgs</span>
<span class="sd">        ready, the scheduler is holding back scheduling new trials since the</span>
<span class="sd">        whole band of trials is waiting for the slowest trial to finish. In</span>
<span class="sd">        this case, we prioritize handling training result to avoid deadlock</span>
<span class="sd">        situation.</span>

<span class="sd">        This is a blocking wait with a timeout (specified with env var).</span>
<span class="sd">        The reason for the timeout is</span>
<span class="sd">        we still want to print status info periodically in TrialRunner for</span>
<span class="sd">        better user experience.</span>

<span class="sd">        The handle of `ExecutorEvent.STOP_RESULT` is purely internal to</span>
<span class="sd">        RayTrialExecutor itself. All the other future results are handled by</span>
<span class="sd">        TrialRunner.</span>

<span class="sd">        In the future we may want to do most of the handle of</span>
<span class="sd">        `ExecutorEvent.RESTORE_RESULT` and `SAVING_RESULT` in</span>
<span class="sd">        RayTrialExecutor itself and only notify TrialRunner to invoke</span>
<span class="sd">        corresponding callbacks. This view is more consistent with our goal</span>
<span class="sd">        of TrialRunner responsible for external facing Trial state transition,</span>
<span class="sd">        while RayTrialExecutor responsible for internal facing transitions,</span>
<span class="sd">        namely, `is_saving`, `is_restoring` etc.</span>

<span class="sd">        Also you may notice that the boundary between RayTrialExecutor and</span>
<span class="sd">        PlacementGroupManager right now is really blurry. This will be</span>
<span class="sd">        improved once we move to an ActorPool abstraction.</span>

<span class="sd">        `next_trial_exists` means that there is a trial to run - prioritize</span>
<span class="sd">        returning PG_READY in this case.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First update status of staged placement groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stage_and_update_status</span><span class="p">(</span><span class="n">live_trials</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1">###################################################################</span>
            <span class="c1"># when next_trial_exists and there are cached resources</span>
            <span class="c1">###################################################################</span>
            <span class="c1"># There could be existing PGs from either</span>
            <span class="c1"># `self._actor_cache`</span>
            <span class="c1"># or from ready trials. If so and if there is indeed</span>
            <span class="c1"># a next trial to run, we return `PG_READY` future for trial</span>
            <span class="c1"># runner. The next trial can then be scheduled on this PG.</span>
            <span class="k">if</span> <span class="n">next_trial_exists</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actor_cache</span><span class="o">.</span><span class="n">num_cached_objects</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_ExecutorEvent</span><span class="p">(</span><span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">PG_READY</span><span class="p">)</span>
                <span class="c1"># TODO(xwjiang): Expose proper API when we decide to do</span>
                <span class="c1">#  ActorPool abstraction.</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">has_resources_ready</span><span class="p">(</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">placement_group_factory</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staged_trials</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="n">_ExecutorEvent</span><span class="p">(</span><span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">PG_READY</span><span class="p">)</span>

            <span class="c1">###################################################################</span>
            <span class="c1"># Prepare for futures to wait</span>
            <span class="c1">###################################################################</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_ready_futures</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">next_trial_exists</span><span class="p">:</span>
                <span class="c1"># If there are cached ready futures, handle the first.</span>
                <span class="c1"># But: If next trial exists, we want to prioritize PG_READY events.</span>
                <span class="n">ready_futures</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cached_ready_futures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Otherwise, wait for new futures</span>
                <span class="n">futures_to_wait</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">futures_to_wait</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">next_trial_exists</span><span class="p">:</span>
                    <span class="c1"># Only wait for pg explicitly if there is next trial to run.</span>
                    <span class="c1"># In which case, handling PG_READY triumphs handling other events.</span>
                    <span class="c1"># Since we want to place pending trial ASAP.</span>
                    <span class="n">futures_to_wait</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">get_resource_futures</span><span class="p">()</span> <span class="o">+</span> <span class="n">futures_to_wait</span>
                    <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;get_next_executor_event before wait with futures &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">futures_to_wait</span><span class="si">}</span><span class="s2"> and &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;next_trial_exists=</span><span class="si">{</span><span class="n">next_trial_exists</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Try to resolve all ready futures that are immediately ready</span>
                <span class="n">ready</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span>
                    <span class="n">futures_to_wait</span><span class="p">,</span> <span class="n">num_returns</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">futures_to_wait</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">ready</span><span class="p">:</span>
                    <span class="c1"># If at least one future resolved, use that one. Cache the other</span>
                    <span class="c1"># ones.</span>
                    <span class="n">ready_futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">ready</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_ready_futures</span> <span class="o">=</span> <span class="n">ready</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Otherwise, wait for next future with timeout.</span>
                    <span class="n">ready_futures</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span>
                        <span class="n">futures_to_wait</span><span class="p">,</span>
                        <span class="n">num_returns</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_next_event_wait</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="c1">###################################################################</span>
            <span class="c1"># Dealing with no future returned case.</span>
            <span class="c1">###################################################################</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ready_futures</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># No running trial and timing out with wait, could be we may</span>
                    <span class="c1"># have insufficient cluster resources that makes tune run</span>
                    <span class="c1"># infeasible.</span>
                    <span class="c1"># TODO: Move InsufficientResourceManager&#39;s logic</span>
                    <span class="c1">#  to TrialExecutor. It is not Runner&#39;s responsibility!</span>
                    <span class="k">return</span> <span class="n">_ExecutorEvent</span><span class="p">(</span><span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">NO_RUNNING_TRIAL_TIMEOUT</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Training simply takes long time, yield the control back to main</span>
                    <span class="c1"># event loop to print progress info etc.</span>
                    <span class="k">return</span> <span class="n">_ExecutorEvent</span><span class="p">(</span><span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">YIELD</span><span class="p">)</span>

            <span class="c1">###################################################################</span>
            <span class="c1"># If there is future returned.</span>
            <span class="c1">###################################################################</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ready_futures</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">ready_future</span> <span class="o">=</span> <span class="n">ready_futures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1">###################################################################</span>
            <span class="c1"># If it is a PG_READY event.</span>
            <span class="c1">###################################################################</span>
            <span class="k">if</span> <span class="n">ready_future</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">update_state</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">_ExecutorEvent</span><span class="p">(</span><span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">PG_READY</span><span class="p">)</span>

            <span class="c1">###################################################################</span>
            <span class="c1"># non PG_READY event</span>
            <span class="c1">###################################################################</span>
            <span class="n">result_type</span><span class="p">,</span> <span class="n">trial_or_acquired_resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ready_future</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result_type</span> <span class="o">==</span> <span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">STOP_RESULT</span><span class="p">:</span>
                <span class="c1"># This will block, which is ok as the stop future returned</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_stop_event</span><span class="p">(</span>
                    <span class="n">ready_future</span><span class="p">,</span> <span class="n">trial_or_acquired_resources</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trial</span> <span class="o">=</span> <span class="n">trial_or_acquired_resources</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">Trial</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">result_type</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">TRAINING_RESULT</span><span class="p">,</span>
                    <span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">SAVING_RESULT</span><span class="p">,</span>
                    <span class="n">_ExecutorEventType</span><span class="o">.</span><span class="n">RESTORING_RESULT</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">future_result</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ready_future</span><span class="p">)</span>
                    <span class="c1"># For local mode</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">future_result</span><span class="p">,</span> <span class="n">_LocalWrapper</span><span class="p">):</span>
                        <span class="n">future_result</span> <span class="o">=</span> <span class="n">future_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Returning [</span><span class="si">{</span><span class="n">result_type</span><span class="si">}</span><span class="s2">] for trial </span><span class="si">{</span><span class="n">trial</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">_ExecutorEvent</span><span class="p">(</span>
                        <span class="n">result_type</span><span class="p">,</span>
                        <span class="n">trial</span><span class="p">,</span>
                        <span class="n">result</span><span class="o">=</span><span class="p">{</span><span class="n">_ExecutorEvent</span><span class="o">.</span><span class="n">KEY_FUTURE_RESULT</span><span class="p">:</span> <span class="n">future_result</span><span class="p">},</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_ExecutorEvent</span><span class="p">(</span>
                        <span class="n">result_type</span><span class="p">,</span>
                        <span class="n">trial</span><span class="p">,</span>
                        <span class="n">result</span><span class="o">=</span><span class="p">{</span>
                            <span class="n">_ExecutorEvent</span><span class="o">.</span><span class="n">KEY_EXCEPTION</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">as_instanceof_cause</span><span class="p">()</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">RayTaskError</span><span class="p">)</span>
                            <span class="k">else</span> <span class="n">_TuneNoNextExecutorEventError</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="p">},</span>
                    <span class="p">)</span></div></div>
</pre></div>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The Ray Team<br/>
  
      &copy; Copyright 2023, The Ray Team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../_static/scripts/pydata-sphinx-theme.js@digest=1999514e3f237ded88cf"></script>


  </body>
</html>