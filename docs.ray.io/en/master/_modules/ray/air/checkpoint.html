
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ray.air.checkpoint &#8212; Ray 3.0.0.dev0</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css@digest=1999514e3f237ded88cf.css" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css@digest=1999514e3f237ded88cf.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css@digest=5115cc725059bd94278eecd172e13a965bf8f5a9.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/termynal.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_/static/css/badge_only.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js@digest=1999514e3f237ded88cf">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/js/versionwarning.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script defer="defer" src="../../../_static/js/docsearch.js"></script>
    <script src="../../../_static/js/rate-the-docs.es.min.js"></script>
    <script defer="defer" src="../../../_static/js/termynal.js"></script>
    <script defer="defer" src="../../../_static/js/custom.js"></script>
    <script defer="defer" src="../../../_static/js/top-navigation.js"></script>
    <script src="../../../_static/js/tags.js"></script>
    <script src="../../../_static/tabs.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js@digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script async="async" src="../../../../../_/static/javascript/readthedocs-doc-embed.js"></script>
    <link rel="canonical" href="https://docs.ray.io/en/latest/_modules/ray/air/checkpoint.html" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://deer.ray.io/script.js" data-site="WYYANYOS" defer></script>
<!-- / Fathom -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110413294-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110413294-1');
</script>

<script
  src="https://widget.kapa.ai/kapa-widget.bundle.js"
  data-website-id="18a8c339-4ec5-43c8-8182-db3f2bc8c6b6"
  data-project-name="Ray"
  data-project-color="#2C2C2C"
  data-project-logo="https://global.discourse-cdn.com/business7/uploads/ray/original/1X/8f4dcb72f7cd34e2a332d548bd65860994bc8ff1.png"
></script>

<script>
(function(apiKey){
    (function(p,e,n,d,o){var v,w,x,y,z;o=p[d]=p[d]||{};o._q=o._q||[];
    v=['initialize','identify','updateOptions','pageLoad','track'];for(w=0,x=v.length;w<x;++w)(function(m){
        o[m]=o[m]||function(){o._q[m===v[0]?'unshift':'push']([m].concat([].slice.call(arguments,0)));};})(v[w]);
        y=e.createElement(n);y.async=!0;y.src='https://cdn.pendo.io/agent/static/'+apiKey+'/pendo.js';
        z=e.getElementsByTagName(n)[0];z.parentNode.insertBefore(y,z);})(window,document,'script','pendo');

        pendo.initialize({
            visitor: {
                id: 'VISITOR-UNIQUE-ID'
            },
            account: {
                id: 'ACCOUNT-UNIQUE-ID'
            }
        });
})('f89fa48a-6dd7-4d7c-67cf-a8051ed891f2');
</script>



  
<!-- RTD Extra Head -->

<link rel="stylesheet" href="../../../../../_/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="application/json" id="READTHEDOCS_DATA">{"ad_free": true, "api_host": "https://readthedocs.org", "builder": "sphinx", "canonical_url": null, "docroot": "/doc/source/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-1", "language": "en", "page": "_modules/ray/air/checkpoint", "programming_language": "py", "project": "ray", "proxied_api_host": "/_", "source_suffix": ".rst", "subprojects": {}, "theme": "sphinx_book_theme", "user_analytics_code": "", "version": "master"}</script>

<!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
-->
<script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script>

<script type="text/javascript" src="../../../../../_/static/javascript/readthedocs-analytics.js" async="async"></script>

<!-- end RTD <extrahead> -->
</head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"><div class='topnav'></div></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ray 3.0.0.dev0</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main Navigation">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    Welcome to Ray!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ray
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-overview/index.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-overview/getting-started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-more-libs/installation.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-overview/use-cases.html">
   Use Cases
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-overview/examples.html">
   Example Gallery
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-overview/ray-libraries.html">
   Ecosystem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-core/walkthrough.html">
   Ray Core
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-air/getting-started.html">
   Ray AI Runtime (AIR)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../data/data.html">
   Ray Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../train/train.html">
   Ray Train
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../tune.html">
   Ray Tune
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../serve/index.html">
   Ray Serve
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../rllib/index.html">
   Ray RLlib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-more-libs/index.html">
   More Libraries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-core/cluster/index.html">
   Ray Clusters
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-observability/index.html">
   Monitoring and Debugging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-references/api.html">
   References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-contribute/stability.html">
   Developer Guides
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ray-project/ray"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/issues/new?title=Issue%20on%20page%20%2F_modules/ray/air/checkpoint.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <h1>Source code for ray.air.checkpoint</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">cloudpickle</span> <span class="k">as</span> <span class="n">pickle</span>
<span class="kn">from</span> <span class="nn">ray.air._internal.checkpointing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">load_preprocessor_from_dir</span><span class="p">,</span>
    <span class="n">save_preprocessor_to_dir</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ray.air._internal.filelock</span> <span class="kn">import</span> <span class="n">TempFileLock</span>
<span class="kn">from</span> <span class="nn">ray.air._internal.remote_storage</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">download_from_uri</span><span class="p">,</span>
    <span class="n">fs_hint</span><span class="p">,</span>
    <span class="n">is_non_local_path_uri</span><span class="p">,</span>
    <span class="n">read_file_from_uri</span><span class="p">,</span>
    <span class="n">upload_to_uri</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ray.air._internal.util</span> <span class="kn">import</span> <span class="n">_copy_dir_ignore_conflicts</span>
<span class="kn">from</span> <span class="nn">ray.air.constants</span> <span class="kn">import</span> <span class="n">PREPROCESSOR_KEY</span><span class="p">,</span> <span class="n">CHECKPOINT_ID_ATTR</span>
<span class="kn">from</span> <span class="nn">ray.util.annotations</span> <span class="kn">import</span> <span class="n">DeveloperAPI</span><span class="p">,</span> <span class="n">PublicAPI</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ray.data.preprocessor</span> <span class="kn">import</span> <span class="n">Preprocessor</span>


<span class="n">_DICT_CHECKPOINT_FILE_NAME</span> <span class="o">=</span> <span class="s2">&quot;dict_checkpoint.pkl&quot;</span>
<span class="n">_CHECKPOINT_METADATA_FILE_NAME</span> <span class="o">=</span> <span class="s2">&quot;.metadata.pkl&quot;</span>
<span class="n">_DICT_CHECKPOINT_ADDITIONAL_FILE_KEY</span> <span class="o">=</span> <span class="s2">&quot;_ray_additional_checkpoint_files&quot;</span>
<span class="n">_METADATA_CHECKPOINT_SUFFIX</span> <span class="o">=</span> <span class="s2">&quot;.meta.pkl&quot;</span>
<span class="n">_FS_CHECKPOINT_KEY</span> <span class="o">=</span> <span class="s2">&quot;fs_checkpoint&quot;</span>
<span class="n">_BYTES_DATA_KEY</span> <span class="o">=</span> <span class="s2">&quot;bytes_data&quot;</span>
<span class="n">_METADATA_KEY</span> <span class="o">=</span> <span class="s2">&quot;_metadata&quot;</span>
<span class="n">_CHECKPOINT_DIR_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;checkpoint_tmp_&quot;</span>
<span class="c1"># The namespace is a constant UUID to prevent conflicts, as defined in RFC-4122</span>
<span class="n">_CHECKPOINT_UUID_URI_NAMESPACE</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="s2">&quot;627fe696-f135-436f-bc4b-bda0306e0181&quot;</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">_CheckpointMetadata</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Metadata about a checkpoint.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        checkpoint_type: The checkpoint class. For example, ``TorchCheckpoint``.</span>
<span class="sd">        checkpoint_state: A dictionary that maps object attributes to their values. When</span>
<span class="sd">            you load a serialized checkpoint, restore these values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">checkpoint_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Checkpoint&quot;</span><span class="p">]</span>
    <span class="n">checkpoint_state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>


<div class="viewcode-block" id="Checkpoint"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.html#ray.air.checkpoint.Checkpoint">[docs]</a><span class="nd">@PublicAPI</span><span class="p">(</span><span class="n">stability</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Checkpoint</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Ray AIR Checkpoint.</span>

<span class="sd">    An AIR Checkpoint are a common interface for accessing models across</span>
<span class="sd">    different AIR components and libraries. A Checkpoint can have its data</span>
<span class="sd">    represented in one of three ways:</span>

<span class="sd">    - as a directory on local (on-disk) storage</span>
<span class="sd">    - as a directory on an external storage (e.g., cloud storage)</span>
<span class="sd">    - as an in-memory dictionary</span>

<span class="sd">    The Checkpoint object also has methods to translate between different checkpoint</span>
<span class="sd">    storage locations. These storage representations provide flexibility in</span>
<span class="sd">    distributed environments, where you may want to recreate an instance of</span>
<span class="sd">    the same model on multiple nodes or across different Ray clusters.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from ray.air.checkpoint import Checkpoint</span>

<span class="sd">        # Create checkpoint data dict</span>
<span class="sd">        checkpoint_data = {&quot;data&quot;: 123}</span>

<span class="sd">        # Create checkpoint object from data</span>
<span class="sd">        checkpoint = Checkpoint.from_dict(checkpoint_data)</span>

<span class="sd">        # Save checkpoint to a directory on the file system.</span>
<span class="sd">        path = checkpoint.to_directory()</span>

<span class="sd">        # This path can then be passed around,</span>
<span class="sd">        # # e.g. to a different function or a different script.</span>
<span class="sd">        # You can also use `checkpoint.to_uri/from_uri` to</span>
<span class="sd">        # read from/write to cloud storage</span>

<span class="sd">        # In another function or script, recover Checkpoint object from path</span>
<span class="sd">        checkpoint = Checkpoint.from_directory(path)</span>

<span class="sd">        # Convert into dictionary again</span>
<span class="sd">        recovered_data = checkpoint.to_dict()</span>

<span class="sd">        # It is guaranteed that the original data has been recovered</span>
<span class="sd">        assert recovered_data == checkpoint_data</span>

<span class="sd">    Checkpoints can be used to instantiate a :class:`Predictor`,</span>
<span class="sd">    :class:`BatchPredictor`, or :class:`PredictorDeployment` class.</span>

<span class="sd">    The constructor is a private API, instead the ``from_`` methods should</span>
<span class="sd">    be used to create checkpoint objects</span>
<span class="sd">    (e.g. ``Checkpoint.from_directory()``).</span>

<span class="sd">    **Other implementation notes:**</span>

<span class="sd">    When converting between different checkpoint formats, it is guaranteed</span>
<span class="sd">    that a full round trip of conversions (e.g. directory --&gt; dict --&gt;</span>
<span class="sd">    --&gt; directory) will recover the original checkpoint data.</span>
<span class="sd">    There are no guarantees made about compatibility of intermediate</span>
<span class="sd">    representations.</span>

<span class="sd">    New data can be added to a Checkpoint</span>
<span class="sd">    during conversion. Consider the following conversion:</span>
<span class="sd">    directory --&gt; dict (adding dict[&quot;foo&quot;] = &quot;bar&quot;)</span>
<span class="sd">    --&gt; directory --&gt; dict (expect to see dict[&quot;foo&quot;] = &quot;bar&quot;). Note that</span>
<span class="sd">    the second directory will contain pickle files with the serialized additional</span>
<span class="sd">    field data in them.</span>

<span class="sd">    Similarly with a dict as a source: dict --&gt; directory (add file &quot;foo.txt&quot;)</span>
<span class="sd">    --&gt; dict --&gt; directory (will have &quot;foo.txt&quot; in it again). Note that the second</span>
<span class="sd">    dict representation will contain an extra field with the serialized additional</span>
<span class="sd">    files in it.</span>

<span class="sd">    Checkpoints can be pickled and sent to remote processes.</span>
<span class="sd">    Please note that checkpoints pointing to local directories will be</span>
<span class="sd">    pickled as data representations, so the full checkpoint data will be</span>
<span class="sd">    contained in the checkpoint object. If you want to avoid this,</span>
<span class="sd">    consider passing only the checkpoint directory to the remote task</span>
<span class="sd">    and re-construct your checkpoint object in that function. Note that</span>
<span class="sd">    this will only work if the &quot;remote&quot; task is scheduled on the</span>
<span class="sd">    same node or a node that also has access to the local data path (e.g.</span>
<span class="sd">    on a shared file system like NFS).</span>

<span class="sd">    If you need persistence across clusters, use the ``to_uri()``</span>
<span class="sd">    or ``to_directory()`` methods to persist your checkpoints to disk.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># A list of object attributes to persist. For example, if</span>
    <span class="c1"># `_SERIALIZED_ATTRS = (&quot;spam&quot;,)`, then the value of `&quot;spam&quot;` is serialized with</span>
    <span class="c1"># the checkpoint data. When a user constructs a checkpoint from the serialized data,</span>
    <span class="c1"># the value of `&quot;spam&quot;` is restored.</span>
    <span class="c1"># In subclasses, do _SERIALIZED_ATTRS = Checkpoint._SERIALIZED_ATTRS + (&quot;spam&quot;,)</span>
    <span class="c1"># `&quot;_checkpoint_id` is used to track checkpoints in TuneCheckpointManager</span>
    <span class="c1"># and is unset otherwise</span>
    <span class="n">_SERIALIZED_ATTRS</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHECKPOINT_ID_ATTR</span><span class="p">,)</span>

<div class="viewcode-block" id="Checkpoint.__init__"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.__init__.html#ray.air.checkpoint.Checkpoint.__init__">[docs]</a>    <span class="nd">@DeveloperAPI</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">local_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># First, resolve file:// URIs to local paths</span>
        <span class="k">if</span> <span class="n">uri</span><span class="p">:</span>
            <span class="n">local_path</span> <span class="o">=</span> <span class="n">_get_local_path</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">local_path</span><span class="p">:</span>
                <span class="n">uri</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Only one data type can be set at any time</span>
        <span class="k">if</span> <span class="n">local_path</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">data_dict</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">uri</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                <span class="n">local_path</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot create checkpoint from path as it does &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;not exist on local node: </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot create checkpoint from path as it does &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;not point to a directory: </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2">. If your checkpoint &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;is a single file, consider passing the enclosing directory &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;instead.&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">local_path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">uri</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot create checkpoint from dict as no &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;dict was passed: </span><span class="si">{</span><span class="n">data_dict</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">uri</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">local_path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">data_dict</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">_get_external_path</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot create checkpoint from URI as it is not &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;supported: </span><span class="si">{</span><span class="n">resolved</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">resolved</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot create checkpoint without data.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span> <span class="k">if</span> <span class="n">local_path</span> <span class="k">else</span> <span class="n">local_path</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_override_preprocessor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Preprocessor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_override_preprocessor_set</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># When using a cloud URI, we make sure that the uuid is constant.</span>
        <span class="c1"># This ensures we do not download the data multiple times on one node.</span>
        <span class="c1"># Note that this is not a caching mechanism - instead, this</span>
        <span class="c1"># only ensures that if there are several processes downloading</span>
        <span class="c1"># from the same URI, only one process does the actual work</span>
        <span class="c1"># while the rest waits (FileLock). This also means data will not be duplicated.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uuid</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span>
            <span class="k">else</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid5</span><span class="p">(</span><span class="n">_CHECKPOINT_UUID_URI_NAMESPACE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parameter</span><span class="p">,</span> <span class="n">argument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_internal_representation</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">argument</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_CheckpointMetadata</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_CheckpointMetadata</span><span class="p">(</span>
            <span class="n">checkpoint_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
            <span class="n">checkpoint_state</span><span class="o">=</span><span class="p">{</span>
                <span class="n">attr</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SERIALIZED_ATTRS</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_copy_metadata_attrs_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="s2">&quot;Checkpoint&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Copy in-place metadata attributes from ``source`` to self.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">checkpoint_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SERIALIZED_ATTRS</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@_metadata</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">_CheckpointMetadata</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">checkpoint_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Checkpoint type in metadata must match </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">metadata</span><span class="o">.</span><span class="n">checkpoint_type</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">checkpoint_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return path to checkpoint, if available.</span>

<span class="sd">        This will return a URI to cloud storage if this checkpoint is</span>
<span class="sd">        persisted on cloud, or a local path if this checkpoint</span>
<span class="sd">        is persisted on local disk and available on the current node.</span>

<span class="sd">        In all other cases, this will return None.</span>

<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; from ray.air import Checkpoint</span>
<span class="sd">            &gt;&gt;&gt; checkpoint = Checkpoint.from_uri(&quot;s3://some-bucket/some-location&quot;)</span>
<span class="sd">            &gt;&gt;&gt; assert checkpoint.path == &quot;s3://some-bucket/some-location&quot;</span>
<span class="sd">            &gt;&gt;&gt; checkpoint = Checkpoint.from_dict({&quot;data&quot;: 1})</span>
<span class="sd">            &gt;&gt;&gt; assert checkpoint.path == None</span>

<span class="sd">        Returns:</span>
<span class="sd">            Checkpoint path if this checkpoint is reachable from the current node (e.g.</span>
<span class="sd">            cloud storage or locally available directory).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uri</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return checkpoint URI, if available.</span>

<span class="sd">        This will return a URI to cloud storage if this checkpoint is</span>
<span class="sd">        persisted on cloud, or a local ``file://`` URI if this checkpoint</span>
<span class="sd">        is persisted on local disk and available on the current node.</span>

<span class="sd">        In all other cases, this will return None. Users can then choose to</span>
<span class="sd">        persist to cloud with</span>
<span class="sd">        :meth:`Checkpoint.to_uri() &lt;ray.air.Checkpoint.to_uri&gt;`.</span>

<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; from ray.air import Checkpoint</span>
<span class="sd">            &gt;&gt;&gt; checkpoint = Checkpoint.from_uri(&quot;s3://some-bucket/some-location&quot;)</span>
<span class="sd">            &gt;&gt;&gt; assert checkpoint.uri == &quot;s3://some-bucket/some-location&quot;</span>
<span class="sd">            &gt;&gt;&gt; checkpoint = Checkpoint.from_dict({&quot;data&quot;: 1})</span>
<span class="sd">            &gt;&gt;&gt; assert checkpoint.uri == None</span>

<span class="sd">        Returns:</span>
<span class="sd">            Checkpoint URI if this URI is reachable from the current node (e.g.</span>
<span class="sd">            cloud storage or locally available file URI).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;file://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Checkpoint.from_bytes"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.from_bytes.html#ray.air.checkpoint.Checkpoint.from_bytes">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_bytes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Checkpoint&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a checkpoint from the given byte string.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: Data object containing pickled checkpoint data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Checkpoint: checkpoint object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bytes_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bytes_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="n">bytes_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">_BYTES_DATA_KEY</span><span class="p">:</span> <span class="n">bytes_data</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Checkpoint.to_bytes"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.to_bytes.html#ray.air.checkpoint.Checkpoint.to_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return Checkpoint serialized as bytes object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bytes: Bytes object containing checkpoint data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Todo: Add support for stream in the future (to_bytes(file_like))</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">_BYTES_DATA_KEY</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">_BYTES_DATA_KEY</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Checkpoint.from_dict"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.from_dict.html#ray.air.checkpoint.Checkpoint.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Checkpoint&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create checkpoint object from dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: Dictionary containing checkpoint data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Checkpoint: checkpoint object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">_METADATA_KEY</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">_METADATA_KEY</span><span class="p">]</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_checkpoint_type</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">checkpoint_type</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">checkpoint_state</span>

        <span class="n">checkpoint</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data_dict</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="n">checkpoint</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">checkpoint</span></div>

<div class="viewcode-block" id="Checkpoint.to_dict"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.to_dict.html#ray.air.checkpoint.Checkpoint.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return checkpoint data as dictionary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary containing checkpoint data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_dict</span><span class="p">:</span>
            <span class="c1"># If the checkpoint data is already a dict, return</span>
            <span class="n">checkpoint_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_dict</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span><span class="p">:</span>
            <span class="c1"># Else, checkpoint is either on FS or external storage</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_directory</span><span class="p">()</span> <span class="k">as</span> <span class="n">local_path</span><span class="p">:</span>
                <span class="n">checkpoint_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">local_path</span><span class="p">,</span> <span class="n">_DICT_CHECKPOINT_FILE_NAME</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">checkpoint_data_path</span><span class="p">):</span>
                    <span class="c1"># If we are restoring a dict checkpoint, load the dict</span>
                    <span class="c1"># from the checkpoint file.</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">checkpoint_data_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">checkpoint_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

                    <span class="c1"># If there are additional files in the directory, add them as</span>
                    <span class="c1"># _DICT_CHECKPOINT_ADDITIONAL_FILE_KEY</span>
                    <span class="n">additional_files</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">file_or_dir</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">file_or_dir</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="s2">&quot;.&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;..&quot;</span><span class="p">,</span>
                            <span class="n">_DICT_CHECKPOINT_FILE_NAME</span><span class="p">,</span>
                            <span class="n">_CHECKPOINT_METADATA_FILE_NAME</span><span class="p">,</span>
                        <span class="p">]:</span>
                            <span class="k">continue</span>

                        <span class="n">additional_files</span><span class="p">[</span><span class="n">file_or_dir</span><span class="p">]</span> <span class="o">=</span> <span class="n">_pack</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">file_or_dir</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">additional_files</span><span class="p">:</span>
                        <span class="n">checkpoint_data</span><span class="p">[</span>
                            <span class="n">_DICT_CHECKPOINT_ADDITIONAL_FILE_KEY</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">additional_files</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">f</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
                        <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">_METADATA_CHECKPOINT_SUFFIX</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="n">file</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">_METADATA_CHECKPOINT_SUFFIX</span><span class="p">)]</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                            <span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                    <span class="n">data</span> <span class="o">=</span> <span class="n">_pack</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>

                    <span class="n">checkpoint_data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">_FS_CHECKPOINT_KEY</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">checkpoint_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Empty data for checkpoint </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">checkpoint_data</span><span class="p">[</span><span class="n">_METADATA_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>

        <span class="c1"># If override_preprocessor is specified, then set that in the output dict.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_override_preprocessor_set</span><span class="p">:</span>
            <span class="n">checkpoint_data</span><span class="p">[</span><span class="n">PREPROCESSOR_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_override_preprocessor</span>
        <span class="k">return</span> <span class="n">checkpoint_data</span></div>

<div class="viewcode-block" id="Checkpoint.from_directory"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.from_directory.html#ray.air.checkpoint.Checkpoint.from_directory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_directory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Checkpoint&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create checkpoint object from directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Directory containing checkpoint data. The caller promises to</span>
<span class="sd">                not delete the directory (gifts ownership of the directory to this</span>
<span class="sd">                Checkpoint).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Checkpoint: checkpoint object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">checkpoint_metadata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">_CHECKPOINT_METADATA_FILE_NAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">checkpoint_metadata_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">checkpoint_metadata_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_checkpoint_type</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">checkpoint_type</span><span class="p">)</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">checkpoint_state</span>

        <span class="n">checkpoint</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">local_path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
        <span class="n">checkpoint</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">checkpoint</span></div>

<div class="viewcode-block" id="Checkpoint.from_checkpoint"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.from_checkpoint.html#ray.air.checkpoint.Checkpoint.from_checkpoint">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="nd">@DeveloperAPI</span>
    <span class="k">def</span> <span class="nf">from_checkpoint</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;Checkpoint&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Checkpoint&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a checkpoint from a generic :class:`Checkpoint`.</span>

<span class="sd">        This method can be used to create a framework-specific checkpoint from a</span>
<span class="sd">        generic :class:`Checkpoint` object.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; result = TorchTrainer.fit(...)  # doctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt; checkpoint = TorchCheckpoint.from_checkpoint(result.checkpoint)  # doctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt; model = checkpoint.get_model()  # doctest: +SKIP</span>
<span class="sd">            Linear(in_features=1, out_features=1, bias=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">cls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">other</span>

        <span class="n">new_checkpoint</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">local_path</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">_local_path</span><span class="p">,</span>
            <span class="n">data_dict</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">_data_dict</span><span class="p">,</span>
            <span class="n">uri</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">_uri</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">new_checkpoint</span><span class="o">.</span><span class="n">_copy_metadata_attrs_from</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_checkpoint</span></div>

    <span class="k">def</span> <span class="nf">_get_temporary_checkpoint_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the name for the temporary checkpoint dir.&quot;&quot;&quot;</span>
        <span class="n">tmp_dir_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>
        <span class="n">checkpoint_dir_name</span> <span class="o">=</span> <span class="n">_CHECKPOINT_DIR_PREFIX</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uuid</span><span class="o">.</span><span class="n">hex</span>
        <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
            <span class="c1"># Max path on Windows is 260 chars, -1 for joining \</span>
            <span class="c1"># Also leave a little for the del lock</span>
            <span class="n">del_lock_name</span> <span class="o">=</span> <span class="n">_get_del_lock_path</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">checkpoint_dir_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">_CHECKPOINT_DIR_PREFIX</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uuid</span><span class="o">.</span><span class="n">hex</span><span class="p">[</span>
                    <span class="o">-</span><span class="mi">259</span>
                    <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">_CHECKPOINT_DIR_PREFIX</span><span class="p">)</span>
                    <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_dir_path</span><span class="p">)</span>
                    <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">del_lock_name</span><span class="p">)</span> <span class="p">:</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">checkpoint_dir_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">_CHECKPOINT_DIR_PREFIX</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Couldn&#39;t create checkpoint directory due to length &quot;</span>
                    <span class="s2">&quot;constraints. Try specifing a shorter checkpoint path.&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir_path</span><span class="p">,</span> <span class="n">checkpoint_dir_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_checkpoint_metadata_in_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">checkpoint_metadata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">_CHECKPOINT_METADATA_FILE_NAME</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">checkpoint_metadata_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_to_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">move_instead_of_copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_dict</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">_FS_CHECKPOINT_KEY</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">_FS_CHECKPOINT_KEY</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">metadata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}{</span><span class="n">_METADATA_CHECKPOINT_SUFFIX</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">f</span><span class="p">)</span>
                <span class="c1"># This used to be a true fs checkpoint, so restore</span>
                <span class="n">_unpack</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">_FS_CHECKPOINT_KEY</span><span class="p">],</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This is a dict checkpoint.</span>
                <span class="c1"># First, restore any additional files</span>
                <span class="n">additional_files</span> <span class="o">=</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                    <span class="n">_DICT_CHECKPOINT_ADDITIONAL_FILE_KEY</span><span class="p">,</span> <span class="p">{}</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">file</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">additional_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">_unpack</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>

                <span class="c1"># Then dump data into checkpoint.pkl</span>
                <span class="n">checkpoint_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">_DICT_CHECKPOINT_FILE_NAME</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">checkpoint_data_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is either a local fs, remote node fs, or external fs</span>
            <span class="n">local_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span>
            <span class="n">path_pathlib</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="n">external_path</span> <span class="o">=</span> <span class="n">_get_external_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_uri</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">local_path</span><span class="p">:</span>
                <span class="n">local_path_pathlib</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">local_path_pathlib</span> <span class="o">!=</span> <span class="n">path_pathlib</span><span class="p">:</span>
                    <span class="c1"># If this exists on the local path, just copy over</span>
                    <span class="k">if</span> <span class="n">move_instead_of_copy</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path_pathlib</span><span class="o">.</span><span class="n">absolute</span><span class="p">()),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path_pathlib</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
                        <span class="k">for</span> <span class="n">inner</span> <span class="ow">in</span> <span class="n">local_path_pathlib</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                            <span class="n">dest</span> <span class="o">=</span> <span class="n">path_pathlib</span> <span class="o">/</span> <span class="n">inner</span><span class="o">.</span><span class="n">name</span>
                            <span class="k">if</span> <span class="n">dest</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                                <span class="c1"># Ignore files that already exist.</span>
                                <span class="c1"># For example, checkpoints from every rank may all have</span>
                                <span class="c1"># a same .is_checkpoint file.</span>
                                <span class="k">continue</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">inner</span><span class="o">.</span><span class="n">absolute</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">path_pathlib</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_copy_dir_ignore_conflicts</span><span class="p">(</span><span class="n">local_path_pathlib</span><span class="p">,</span> <span class="n">path_pathlib</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">external_path</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Downloading checkpoint from </span><span class="si">{</span><span class="n">external_path</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> ...&quot;</span>
                <span class="p">)</span>
                <span class="c1"># If this exists on external storage (e.g. cloud), download</span>
                <span class="n">download_from_uri</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">external_path</span><span class="p">,</span> <span class="n">local_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filelock</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No valid location found for checkpoint </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_uri</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_checkpoint_metadata_in_directory</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_override_preprocessor_set</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_override_preprocessor</span><span class="p">:</span>
            <span class="n">save_preprocessor_to_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_override_preprocessor</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_to_directory_safe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">move_instead_of_copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Timeout 0 means there will be only one attempt to acquire</span>
            <span class="c1"># the file lock. If it cannot be aquired, a TimeoutError</span>
            <span class="c1"># will be thrown.</span>
            <span class="k">with</span> <span class="n">TempFileLock</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">.lock&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_to_directory</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">move_instead_of_copy</span><span class="o">=</span><span class="n">move_instead_of_copy</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="c1"># if the directory is already locked, then wait but do not do anything.</span>
            <span class="k">with</span> <span class="n">TempFileLock</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">.lock&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Checkpoint directory </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> does not exist, &quot;</span>
                    <span class="s2">&quot;even though it should have been created by &quot;</span>
                    <span class="s2">&quot;another process. Please raise an issue on GitHub: &quot;</span>
                    <span class="s2">&quot;https://github.com/ray-project/ray/issues&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_move_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Move to a new directory, changing state.</span>

<span class="sd">        Only for local directory backed checkpoints.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;_move_directory requires the checkpoint to be backed by&quot;</span>
                <span class="s2">&quot; a local directory&quot;</span>
            <span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">_make_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_directory_safe</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">move_instead_of_copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span>

<div class="viewcode-block" id="Checkpoint.to_directory"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.to_directory.html#ray.air.checkpoint.Checkpoint.to_directory">[docs]</a>    <span class="k">def</span> <span class="nf">to_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write checkpoint data to directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Target directory to restore data in. If not specified,</span>
<span class="sd">                will create a temporary directory.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Directory containing checkpoint data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_provided_path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="k">if</span> <span class="n">user_provided_path</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_temporary_checkpoint_dir</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

        <span class="n">_make_dir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">acquire_del_lock</span><span class="o">=</span><span class="ow">not</span> <span class="n">user_provided_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_directory_safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Checkpoint.as_directory"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.as_directory.html#ray.air.checkpoint.Checkpoint.as_directory">[docs]</a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">as_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return checkpoint directory path in a context.</span>

<span class="sd">        This function makes checkpoint data available as a directory while avoiding</span>
<span class="sd">        unnecessary copies and left-over temporary data.</span>

<span class="sd">        If the checkpoint is already a directory checkpoint, it will return</span>
<span class="sd">        the existing path. If it is not, it will create a temporary directory,</span>
<span class="sd">        which will be deleted after the context is exited.</span>

<span class="sd">        Users should treat the returned checkpoint directory as read-only and avoid</span>
<span class="sd">        changing any data within it, as it might get deleted when exiting the context.</span>

<span class="sd">        Example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            with checkpoint.as_directory() as checkpoint_dir:</span>
<span class="sd">                # Do some read-only processing of files within checkpoint_dir</span>
<span class="sd">                pass</span>

<span class="sd">            # At this point, if a temporary directory was created, it will have</span>
<span class="sd">            # been deleted.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_directory</span><span class="p">()</span>
            <span class="n">del_lock_path</span> <span class="o">=</span> <span class="n">_get_del_lock_path</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">temp_dir</span>

            <span class="c1"># Cleanup</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">del_lock_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not remove </span><span class="si">{</span><span class="n">del_lock_path</span><span class="si">}</span><span class="s2"> deletion file lock. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Traceback:</span><span class="se">\n</span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># In the edge case (process crash before del lock file is removed),</span>
            <span class="c1"># we do not remove the directory at all.</span>
            <span class="c1"># Since it&#39;s in /tmp, this is not that big of a deal.</span>
            <span class="c1"># check if any lock files are remaining</span>
            <span class="n">temp_dir_base_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">Path</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">_get_del_lock_path</span><span class="p">(</span><span class="n">temp_dir_base_name</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">))</span>
            <span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Timeout 0 means there will be only one attempt to acquire</span>
                    <span class="c1"># the file lock. If it cannot be aquired, a TimeoutError</span>
                    <span class="c1"># will be thrown.</span>
                    <span class="k">with</span> <span class="n">TempFileLock</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">temp_dir</span><span class="si">}</span><span class="s2">.lock&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                    <span class="k">pass</span></div>

<div class="viewcode-block" id="Checkpoint.from_uri"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.from_uri.html#ray.air.checkpoint.Checkpoint.from_uri">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_uri</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Checkpoint&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create checkpoint object from location URI (e.g. cloud storage).</span>

<span class="sd">        Valid locations currently include AWS S3 (``s3://``),</span>
<span class="sd">        Google cloud storage (``gs://``), HDFS (``hdfs://``), and</span>
<span class="sd">        local files (``file://``).</span>

<span class="sd">        Args:</span>
<span class="sd">            uri: Source location URI to read data from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Checkpoint: checkpoint object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">checkpoint_metadata_uri</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">_CHECKPOINT_METADATA_FILE_NAME</span><span class="p">)</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">read_file_from_uri</span><span class="p">(</span><span class="n">checkpoint_metadata_uri</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_checkpoint_type</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">checkpoint_type</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">checkpoint_state</span>

        <span class="n">checkpoint</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">)</span>
        <span class="n">checkpoint</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">checkpoint</span></div>

<div class="viewcode-block" id="Checkpoint.to_uri"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.to_uri.html#ray.air.checkpoint.Checkpoint.to_uri">[docs]</a>    <span class="k">def</span> <span class="nf">to_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write checkpoint data to location URI (e.g. cloud storage).</span>

<span class="sd">        Args:</span>
<span class="sd">            uri: Target location URI to write data to.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Cloud location containing checkpoint data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;file://&quot;</span><span class="p">):</span>
            <span class="n">local_path</span> <span class="o">=</span> <span class="n">uri</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_directory</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_non_local_path_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot upload checkpoint to URI: Provided URI &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;does not belong to a registered storage provider: `</span><span class="si">{</span><span class="n">uri</span><span class="si">}</span><span class="s2">`. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Hint: </span><span class="si">{</span><span class="n">fs_hint</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_directory</span><span class="p">()</span> <span class="k">as</span> <span class="n">local_path</span><span class="p">:</span>
            <span class="n">checkpoint_metadata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">local_path</span><span class="p">,</span> <span class="n">_CHECKPOINT_METADATA_FILE_NAME</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">checkpoint_metadata_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

            <span class="n">upload_to_uri</span><span class="p">(</span><span class="n">local_path</span><span class="o">=</span><span class="n">local_path</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">uri</span></div>

<div class="viewcode-block" id="Checkpoint.get_internal_representation"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.get_internal_representation.html#ray.air.checkpoint.Checkpoint.get_internal_representation">[docs]</a>    <span class="nd">@DeveloperAPI</span>
    <span class="k">def</span> <span class="nf">get_internal_representation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Return tuple of (type, data) for the internal representation.</span>

<span class="sd">        The internal representation can be used e.g. to compare checkpoint</span>
<span class="sd">        objects for equality or to access the underlying data storage.</span>

<span class="sd">        The returned type is a string and one of</span>
<span class="sd">        ``[&quot;local_path&quot;, &quot;data_dict&quot;, &quot;uri&quot;]``.</span>

<span class="sd">        The data is the respective data value.</span>

<span class="sd">        Note that paths converted from ``file://...`` will be returned</span>
<span class="sd">        as ``local_path`` (without the ``file://`` prefix) and not as ``uri``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of type and data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;local_path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;data_dict&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_dict</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;uri&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot get internal representation of empty checkpoint.&quot;</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_path</span><span class="p">:</span>
            <span class="n">blob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__fspath__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;You cannot use `air.Checkpoint` objects directly as paths. &quot;</span>
            <span class="s2">&quot;Use `Checkpoint.to_directory()` or `Checkpoint.as_directory()` instead.&quot;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Checkpoint.get_preprocessor"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.get_preprocessor.html#ray.air.checkpoint.Checkpoint.get_preprocessor">[docs]</a>    <span class="k">def</span> <span class="nf">get_preprocessor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Preprocessor&quot;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return the saved preprocessor, if one exists.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_override_preprocessor_set</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_override_preprocessor</span>

        <span class="c1"># The preprocessor will either be stored in an in-memory dict or</span>
        <span class="c1"># written to storage. In either case, it will use the PREPROCESSOR_KEY key.</span>

        <span class="c1"># If this is a pure directory checkpoint (not a dict checkpoint saved to dir),</span>
        <span class="c1"># then do not convert to dictionary as that takes a lot of time and memory.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_directory</span><span class="p">()</span> <span class="k">as</span> <span class="n">checkpoint_path</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_is_persisted_directory_checkpoint</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">):</span>
                    <span class="c1"># If this is a persisted directory checkpoint, then we load the</span>
                    <span class="c1"># files from the temp directory created by the context.</span>
                    <span class="c1"># That way we avoid having to download the files twice.</span>
                    <span class="n">loaded_checkpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_directory</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">)</span>
                    <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">_get_preprocessor</span><span class="p">(</span><span class="n">loaded_checkpoint</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">load_preprocessor_from_dir</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">_get_preprocessor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">preprocessor</span></div>

<div class="viewcode-block" id="Checkpoint.set_preprocessor"><a class="viewcode-back" href="../../../ray-air/api/doc/ray.air.checkpoint.Checkpoint.set_preprocessor.html#ray.air.checkpoint.Checkpoint.set_preprocessor">[docs]</a>    <span class="k">def</span> <span class="nf">set_preprocessor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Preprocessor&quot;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Saves the provided preprocessor to this Checkpoint.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_override_preprocessor</span> <span class="o">=</span> <span class="n">preprocessor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_override_preprocessor_set</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_checkpoint_type</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">serialized_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Checkpoint&quot;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Checkpoint&quot;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return the class that&#39;s a subclass of the other class, if one exists.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If neither class is a subclass of the other.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serialized_cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">serialized_cls</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">serialized_cls</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;You&#39;re trying to load a serialized `</span><span class="si">{</span><span class="n">serialized_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">`, but &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">serialized_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">` isn&#39;t compatible with `</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">`.&quot;</span>
        <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_get_local_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Check if path is a local path. Otherwise return None.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">is_non_local_path_uri</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;file://&quot;</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_get_external_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Check if path is an external path. Otherwise return None.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_non_local_path_uri</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">path</span>


<span class="k">def</span> <span class="nf">_pack</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Pack directory in ``path`` into an archive, return as bytes string.&quot;&quot;&quot;</span>
    <span class="n">stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">filter_function</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">_METADATA_CHECKPOINT_SUFFIX</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tarinfo</span>

    <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">tarfile</span><span class="o">.</span><span class="n">PAX_FORMAT</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">filter_function</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Unpack archive in bytes string into directory in ``path``.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">stream</span><span class="p">))</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span>


<span class="k">def</span> <span class="nf">_get_del_lock_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get the path to the deletion lock file.&quot;&quot;&quot;</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span> <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">.del_lock_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">_make_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquire_del_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create the temporary checkpoint dir in ``path``.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">acquire_del_lock</span><span class="p">:</span>
        <span class="c1"># Each process drops a deletion lock file it then cleans up.</span>
        <span class="c1"># If there are no lock files left, the last process</span>
        <span class="c1"># will remove the entire directory.</span>
        <span class="n">del_lock_path</span> <span class="o">=</span> <span class="n">_get_del_lock_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">del_lock_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_persisted_directory_checkpoint</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">_DICT_CHECKPOINT_FILE_NAME</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_get_preprocessor</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">:</span> <span class="s2">&quot;Checkpoint&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Preprocessor&quot;</span><span class="p">]:</span>
    <span class="c1"># First try converting to dictionary.</span>
    <span class="n">checkpoint_dict</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">checkpoint_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PREPROCESSOR_KEY</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">preprocessor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Fallback to reading from directory.</span>
        <span class="k">with</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">as_directory</span><span class="p">()</span> <span class="k">as</span> <span class="n">checkpoint_path</span><span class="p">:</span>
            <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">load_preprocessor_from_dir</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">preprocessor</span>
</pre></div>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The Ray Team<br/>
  
      &copy; Copyright 2023, The Ray Team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js@digest=1999514e3f237ded88cf"></script>


  </body>
</html>