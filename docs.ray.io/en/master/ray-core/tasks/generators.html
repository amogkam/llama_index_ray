
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Generators &#8212; Ray 3.0.0.dev0</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css@digest=1999514e3f237ded88cf.css" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css@digest=1999514e3f237ded88cf.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css@digest=5115cc725059bd94278eecd172e13a965bf8f5a9.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/termynal.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_/static/css/badge_only.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js@digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/versionwarning.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script defer="defer" src="../../_static/js/docsearch.js"></script>
    <script src="../../_static/js/rate-the-docs.es.min.js"></script>
    <script defer="defer" src="../../_static/js/termynal.js"></script>
    <script defer="defer" src="../../_static/js/custom.js"></script>
    <script defer="defer" src="../../_static/js/top-navigation.js"></script>
    <script src="../../_static/js/tags.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js@digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script async="async" src="../../../../_/static/javascript/readthedocs-doc-embed.js"></script>
    <link rel="canonical" href="https://docs.ray.io/en/latest/ray-core/tasks/generators.html" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Actors" href="../../ray-more-libs/actors.html" />
    <link rel="prev" title="Nested Remote Functions" href="nested-tasks.html" />

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://deer.ray.io/script.js" data-site="WYYANYOS" defer></script>
<!-- / Fathom -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110413294-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110413294-1');
</script>

<script
  src="https://widget.kapa.ai/kapa-widget.bundle.js"
  data-website-id="18a8c339-4ec5-43c8-8182-db3f2bc8c6b6"
  data-project-name="Ray"
  data-project-color="#2C2C2C"
  data-project-logo="https://global.discourse-cdn.com/business7/uploads/ray/original/1X/8f4dcb72f7cd34e2a332d548bd65860994bc8ff1.png"
></script>

<script>
(function(apiKey){
    (function(p,e,n,d,o){var v,w,x,y,z;o=p[d]=p[d]||{};o._q=o._q||[];
    v=['initialize','identify','updateOptions','pageLoad','track'];for(w=0,x=v.length;w<x;++w)(function(m){
        o[m]=o[m]||function(){o._q[m===v[0]?'unshift':'push']([m].concat([].slice.call(arguments,0)));};})(v[w]);
        y=e.createElement(n);y.async=!0;y.src='https://cdn.pendo.io/agent/static/'+apiKey+'/pendo.js';
        z=e.getElementsByTagName(n)[0];z.parentNode.insertBefore(y,z);})(window,document,'script','pendo');

        pendo.initialize({
            visitor: {
                id: 'VISITOR-UNIQUE-ID'
            },
            account: {
                id: 'ACCOUNT-UNIQUE-ID'
            }
        });
})('f89fa48a-6dd7-4d7c-67cf-a8051ed891f2');
</script>



  
<!-- RTD Extra Head -->

<link rel="stylesheet" href="../../../../_/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="application/json" id="READTHEDOCS_DATA">{"ad_free": true, "api_host": "https://readthedocs.org", "builder": "sphinx", "canonical_url": null, "docroot": "/doc/source/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-1", "language": "en", "page": "ray-core/tasks/generators", "programming_language": "py", "project": "ray", "proxied_api_host": "/_", "source_suffix": ".rst", "subprojects": {}, "theme": "sphinx_book_theme", "user_analytics_code": "", "version": "master"}</script>

<!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
-->
<script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script>

<script type="text/javascript" src="../../../../_/static/javascript/readthedocs-analytics.js" async="async"></script>

<!-- end RTD <extrahead> -->
</head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"><div class='topnav'></div></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ray 3.0.0.dev0</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main Navigation">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Welcome to Ray!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ray
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/index.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/getting-started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-more-libs/installation.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/use-cases.html">
   Use Cases
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/examples.html">
   Example Gallery
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/ray-libraries.html">
   Ecosystem
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../walkthrough.html">
   Ray Core
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../key-concepts.html">
     Key Concepts
    </a>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="../user-guide.html">
     User Guides
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3 current active has-children">
      <a class="reference internal" href="../tasks.html">
       Tasks
      </a>
      <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
      <label for="toctree-checkbox-3">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul class="current">
       <li class="toctree-l4">
        <a class="reference internal" href="nested-tasks.html">
         Nested Remote Functions
        </a>
       </li>
       <li class="toctree-l4 current active">
        <a class="current reference internal" href="generators.html#">
         Generators
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../ray-more-libs/actors.html">
       Actors
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../objects.html">
       Objects
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../handling-dependencies.html">
       Environment Dependencies
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../scheduling/index.html">
       Scheduling
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../fault-tolerance.html">
       Fault Tolerance
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../patterns/index.html">
       Design Patterns &amp; Anti-patterns
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../advanced-topics.html">
       Advanced Topics
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/overview.html">
     Examples
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../api/index.html">
     Ray Core API
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-air/getting-started.html">
   Ray AI Runtime (AIR)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../data/data.html">
   Ray Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../train/train.html">
   Ray Train
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tune.html">
   Ray Tune
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../serve/index.html">
   Ray Serve
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../rllib/index.html">
   Ray RLlib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-more-libs/index.html">
   More Libraries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../cluster/index.html">
   Ray Clusters
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-observability/index.html">
   Monitoring and Debugging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-references/api.html">
   References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-contribute/stability.html">
   Developer Guides
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ray-project/ray"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/issues/new?title=Issue%20on%20page%20%2Fray-core/tasks/generators.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/edit/master/doc/source/ray-core/tasks/generators.rst"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/ray-core/tasks/generators.rst.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.rst</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="generators.html#num-returns-set-by-the-task-caller">
   <code class="xref py py-obj docutils literal notranslate">
    <span class="pre">
     num_returns
    </span>
   </code>
   set by the task caller
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="generators.html#num-returns-set-by-the-task-executor">
   <code class="xref py py-obj docutils literal notranslate">
    <span class="pre">
     num_returns
    </span>
   </code>
   set by the task executor
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="generators.html#exception-handling">
   Exception handling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="generators.html#limitations">
   Limitations
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Generators</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="generators.html#num-returns-set-by-the-task-caller">
   <code class="xref py py-obj docutils literal notranslate">
    <span class="pre">
     num_returns
    </span>
   </code>
   set by the task caller
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="generators.html#num-returns-set-by-the-task-executor">
   <code class="xref py py-obj docutils literal notranslate">
    <span class="pre">
     num_returns
    </span>
   </code>
   set by the task executor
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="generators.html#exception-handling">
   Exception handling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="generators.html#limitations">
   Limitations
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="generators">
<span id="id1"></span><h1>Generators<a class="headerlink" href="generators.html#generators" title="Permalink to this headline">#</a></h1>
<p>Python generators are functions that behave like an iterator, yielding one
value per iteration. Ray supports remote generators for two use cases:</p>
<ol class="arabic simple">
<li><p>To reduce max heap memory usage when returning multiple values from a remote
function. See the <a class="reference internal" href="../patterns/generators.html#generator-pattern"><span class="std std-ref">design pattern guide</span></a> for an
example.</p></li>
<li><p>When the number of return values is set dynamically by the remote function
instead of by the caller.</p></li>
</ol>
<p>Remote generators can be used in both actor and non-actor tasks.</p>
<section id="num-returns-set-by-the-task-caller">
<span id="static-generators"></span><h2><code class="xref py py-obj docutils literal notranslate"><span class="pre">num_returns</span></code> set by the task caller<a class="headerlink" href="generators.html#num-returns-set-by-the-task-caller" title="Permalink to this headline">#</a></h2>
<p>Where possible, the caller should set the remote function’s number of return values using <code class="docutils literal notranslate"><span class="pre">&#64;ray.remote(num_returns=x)</span></code> or <code class="docutils literal notranslate"><span class="pre">foo.options(num_returns=x).remote()</span></code>.
Ray will return this many <code class="docutils literal notranslate"><span class="pre">ObjectRefs</span></code> to the caller.
The remote task should then return the same number of values, usually as a tuple or list.
Compared to setting the number of return values dynamically, this adds less complexity to user code and less performance overhead, as Ray will know exactly how many <code class="docutils literal notranslate"><span class="pre">ObjectRefs</span></code> to return to the caller ahead of time.</p>
<p>Without changing the caller’s syntax, we can also use a remote generator function to yield the values iteratively.
The generator should yield the same number of return values specified by the caller, and these will be stored one at a time in Ray’s object store.
An error will be raised for generators that yield a different number of values from the one specified by the caller.</p>
<p>For example, we can swap the following code that returns a list of return values:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span>
<span class="k">def</span> <span class="nf">large_values</span><span class="p">(</span><span class="n">num_returns</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">100_000_000</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_returns</span><span class="p">)</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>for this code, which uses a generator function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span>
<span class="k">def</span> <span class="nf">large_values_generator</span><span class="p">(</span><span class="n">num_returns</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_returns</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">100_000_000</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;yielded return value </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The advantage of doing so is that the generator function does not need to hold all of its return values in memory at once.
It can yield the arrays one at a time to reduce memory pressure.</p>
</section>
<section id="num-returns-set-by-the-task-executor">
<span id="dynamic-generators"></span><h2><code class="xref py py-obj docutils literal notranslate"><span class="pre">num_returns</span></code> set by the task executor<a class="headerlink" href="generators.html#num-returns-set-by-the-task-executor" title="Permalink to this headline">#</a></h2>
<p>In some cases, the caller may not know the number of return values to expect from a remote function.
For example, suppose we want to write a task that breaks up its argument into equal-size chunks and returns these.
We may not know the size of the argument until we execute the task, so we don’t know the number of return values to expect.</p>
<p>In these cases, we can use a remote generator function that returns a <em>dynamic</em> number of values.
To use this feature, set <code class="docutils literal notranslate"><span class="pre">num_returns=&quot;dynamic&quot;</span></code> in the <code class="docutils literal notranslate"><span class="pre">&#64;ray.remote</span></code> decorator or the remote function’s <code class="docutils literal notranslate"><span class="pre">.options()</span></code>.
Then, when invoking the remote function, Ray will return a <em>single</em> <code class="docutils literal notranslate"><span class="pre">ObjectRef</span></code> that will get populated with an <code class="docutils literal notranslate"><span class="pre">ObjectRefGenerator</span></code> when the task completes.
The <code class="docutils literal notranslate"><span class="pre">ObjectRefGenerator</span></code> can be used to iterate over a list of <code class="docutils literal notranslate"><span class="pre">ObjectRefs</span></code> containing the actual values returned by the task.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">num_returns</span><span class="o">=</span><span class="s2">&quot;dynamic&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">):</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">array</span><span class="p">[:</span><span class="n">chunk_size</span><span class="p">]</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">chunk_size</span><span class="p">:]</span>


<span class="n">array_ref</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000_000</span><span class="p">)))</span>
<span class="n">block_size</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># Returns an ObjectRef[ObjectRefGenerator].</span>
<span class="n">dynamic_ref</span> <span class="o">=</span> <span class="n">split</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">array_ref</span><span class="p">,</span> <span class="n">block_size</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dynamic_ref</span><span class="p">)</span>
<span class="c1"># ObjectRef(c8ef45ccd0112571ffffffffffffffffffffffff0100000001000000)</span>

<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">ref_generator</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dynamic_ref</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ref_generator</span><span class="p">)</span>
<span class="c1"># &lt;ray._raylet.ObjectRefGenerator object at 0x7f7e2116b290&gt;</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ref_generator</span><span class="p">):</span>
    <span class="c1"># Each ObjectRefGenerator iteration returns an ObjectRef.</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">block_size</span>
<span class="n">num_blocks_generated</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">array_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">array_ref</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">array_size</span> <span class="o">&lt;=</span> <span class="n">num_blocks_generated</span> <span class="o">*</span> <span class="n">block_size</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Split array of size </span><span class="si">{</span><span class="n">array_size</span><span class="si">}</span><span class="s2"> into </span><span class="si">{</span><span class="n">num_blocks_generated</span><span class="si">}</span><span class="s2"> blocks of &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;size </span><span class="si">{</span><span class="n">block_size</span><span class="si">}</span><span class="s2"> each.&quot;</span><span class="p">)</span>
<span class="c1"># Split array of size 63153 into 64 blocks of size 1000 each.</span>

<span class="c1"># NOTE: The dynamic_ref points to the generated ObjectRefs. Make sure that this</span>
<span class="c1"># ObjectRef goes out of scope so that Ray can garbage-collect the internal</span>
<span class="c1"># ObjectRefs.</span>
<span class="k">del</span> <span class="n">dynamic_ref</span>
</pre></div>
</div>
<p>We can also pass the <code class="docutils literal notranslate"><span class="pre">ObjectRef</span></code> returned by a task with <code class="docutils literal notranslate"><span class="pre">num_returns=&quot;dynamic&quot;</span></code> to another task. The task will receive the <code class="docutils literal notranslate"><span class="pre">ObjectRefGenerator</span></code>, which it can use to iterate over the task’s return values. Similarly, you can also pass an <code class="docutils literal notranslate"><span class="pre">ObjectRefGenerator</span></code> as a task argument.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span>
<span class="k">def</span> <span class="nf">get_size</span><span class="p">(</span><span class="n">ref_generator</span> <span class="p">:</span> <span class="n">ObjectRefGenerator</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ref_generator</span><span class="p">)</span>
    <span class="n">num_elements</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">ref_generator</span><span class="p">:</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">block_size</span>
        <span class="n">num_elements</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num_elements</span>


<span class="c1"># Returns an ObjectRef[ObjectRefGenerator].</span>
<span class="n">dynamic_ref</span> <span class="o">=</span> <span class="n">split</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">array_ref</span><span class="p">,</span> <span class="n">block_size</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">array_size</span> <span class="o">==</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">get_size</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">dynamic_ref</span><span class="p">))</span>
<span class="c1"># (get_size pid=1504184) &lt;ray._raylet.ObjectRefGenerator object at 0x7f81c4250ad0&gt;</span>

<span class="c1"># This also works, but should be avoided because you have to call an additional</span>
<span class="c1"># `ray.get`, which blocks the driver.</span>
<span class="n">ref_generator</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dynamic_ref</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">array_size</span> <span class="o">==</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">get_size</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">ref_generator</span><span class="p">))</span>
<span class="c1"># (get_size pid=1504184) &lt;ray._raylet.ObjectRefGenerator object at 0x7f81c4251b50&gt;</span>
</pre></div>
</div>
</section>
<section id="exception-handling">
<h2>Exception handling<a class="headerlink" href="generators.html#exception-handling" title="Permalink to this headline">#</a></h2>
<p>If a generator function raises an exception before yielding all its values, the values that it already stored will still be accessible through their <code class="docutils literal notranslate"><span class="pre">ObjectRefs</span></code>.
The remaining <code class="docutils literal notranslate"><span class="pre">ObjectRefs</span></code> will contain the raised exception.
This is true for both static and dynamic <code class="docutils literal notranslate"><span class="pre">num_returns</span></code>.
If the task was called with <code class="docutils literal notranslate"><span class="pre">num_returns=&quot;dynamic&quot;</span></code>, the exception will be stored as an additional final <code class="docutils literal notranslate"><span class="pre">ObjectRef</span></code> in the <code class="docutils literal notranslate"><span class="pre">ObjectRefGenerator</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span>
<span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">i</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>


<span class="n">ref1</span><span class="p">,</span> <span class="n">ref2</span><span class="p">,</span> <span class="n">ref3</span><span class="p">,</span> <span class="n">ref4</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">num_returns</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">ref1</span><span class="p">,</span> <span class="n">ref2</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="c1"># All remaining ObjectRefs will contain the error.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">ref3</span><span class="p">,</span> <span class="n">ref4</span><span class="p">])</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="n">dynamic_ref</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">num_returns</span><span class="o">=</span><span class="s2">&quot;dynamic&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="n">ref_generator</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dynamic_ref</span><span class="p">)</span>
<span class="n">ref1</span><span class="p">,</span> <span class="n">ref2</span><span class="p">,</span> <span class="n">ref3</span> <span class="o">=</span> <span class="n">ref_generator</span>
<span class="k">assert</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">ref1</span><span class="p">,</span> <span class="n">ref2</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="c1"># Generators with num_returns=&quot;dynamic&quot; will store the exception in the final</span>
<span class="c1"># ObjectRef.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ref3</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that there is currently a known bug where exceptions will not be propagated for generators that yield more values than expected. This can occur in two cases:</p>
<ol class="arabic simple">
<li><p>When <code class="docutils literal notranslate"><span class="pre">num_returns</span></code> is set by the caller, but the generator task returns more than this value.</p></li>
<li><p>When a generator task with <code class="docutils literal notranslate"><span class="pre">num_returns=&quot;dynamic&quot;</span></code> is <a class="reference internal" href="../fault_tolerance/tasks.html#task-retries"><span class="std std-ref">re-executed</span></a>, and the re-executed task yields more values than the original execution. Note that in general, Ray does not guarantee correctness for task re-execution if the task is nondeterministic, and it is recommended to set <code class="docutils literal notranslate"><span class="pre">&#64;ray.remote(num_retries=0)</span></code> for such tasks.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generators that yield more values than expected currently do not throw an</span>
<span class="c1"># exception (the error is only logged).</span>
<span class="c1"># See https://github.com/ray-project/ray/issues/28689.</span>
<span class="n">ref1</span><span class="p">,</span> <span class="n">ref2</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">num_returns</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">ref1</span><span class="p">,</span> <span class="n">ref2</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">(generator pid=2375938) 2022-09-28 11:08:51,386 ERROR worker.py:755 --</span>
<span class="sd">    Unhandled error: Task threw exception, but all return values already</span>
<span class="sd">    created.  This should only occur when using generator tasks.</span>
<span class="sd">...</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="generators.html#limitations" title="Permalink to this headline">#</a></h2>
<p>Although a generator function creates <code class="docutils literal notranslate"><span class="pre">ObjectRefs</span></code> one at a time, currently Ray will not schedule dependent tasks until the entire task is complete and all values have been created. This is similar to the semantics used by tasks that return multiple values as a list.</p>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="nested-tasks.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Nested Remote Functions</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../../ray-more-libs/actors.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Actors</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The Ray Team<br/>
  
      &copy; Copyright 2023, The Ray Team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js@digest=1999514e3f237ded88cf"></script>


  </body>
</html>